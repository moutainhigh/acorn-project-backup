(function(f) {
	f.tools = f.tools || {
		version : "@VERSION"
	};
	var k = /\[type=([a-z]+)\]/, i = /^-?[0-9]*(\.[0-9]+)?$/, 
	c = f.tools.dateinput, a = /^([a-z0-9_\.\-\+]+)@([\da-z\.\-]+)\.([a-z\.]{2,6})$/i,
	h = /^([a-zA-Z0-9]|[~`!@#$%\^&\*\(\)_\+-=\{\}\]\[:;\"'<>,\.\/\?]){6,16}$/, 
	g = /^(https?:\/\/)?[\da-z\.\-]+\.[a-z\.]{2,6}[#&+_\?\/\w \.\-=]*$/i, j;
	j = f.tools.validator = {
		conf : {
			grouped : false,
			effect : "default",
			errorClass : "invalid",
			inputEvent : null,
			errorInputEvent : "keyup",
			formEvent : "submit",
			lang : "en",
			message : '<div class="errorMsg"><span><i class="text"></i></span></div>',
			messageAttr : "data-message",
			messageClass : "error",
			offset : [ 0, 0 ],
			position : "center right",
			singleError : false,
			zIndex : 0,
			speed : "normal"
		},
		messages : {
			"*" : {
				en : "Please correct this value"
			}
		},
		localize : function(o, n) {
			f.each(n, function(p, q) {
				j.messages[p] = j.messages[p] || {};
				j.messages[p][o] = q
			})
		},
		localizeFn : function(n, o) {
			j.messages[n] = j.messages[n] || {};
			f.extend(j.messages[n], o)
		},
		fn : function(o, p, n) {
			if (f.isFunction(p)) {
				n = p
			} else {
				if (typeof p == "string") {
					p = {
						en : p
					}
				}
				this.messages[o.key || o] = p
			}
			var q = k.exec(o);
			if (q) {
				o = e(q[1])
			}
			l.push([ o, n ])
		},
		addEffect : function(n, o, p) {
			b[n] = [ o, p ]
		}
	};
	function m(p, o, r) {
		o = f(o).first() || o;
		var u = p.offset().top, q = p.offset().left, s = r.position
				.split(/,?\s+/), t = s[0], v = s[1];
		u -= o.outerHeight() - r.offset[0];
		q += p.outerWidth() + r.offset[1];
		if (/iPad/i.test(navigator.userAgent)) {
			u -= f(window).scrollTop()
		}
		var w = o.outerHeight() + p.outerHeight();
		if (t == "center") {
			u += w / 2
		}
		if (t == "bottom") {
			u += w
		}
		var n = p.outerWidth();
		if (v == "center") {
			q -= (n + o.outerWidth()) / 2
		}
		if (v == "left") {
			q -= n
		}
		return {
			top : u,
			left : q
		}
	}
	function e(o) {
		function n() {
			return this.getAttribute("type") == o
		}
		n.key = '[type="' + o + '"]';
		return n
	}
	var l = [], b = {
		"default" : [
				function(n) {
					var o = this.getConf();
					f.each(n, function(q, r) {
						var p = r.input;
						p.addClass(o.errorClass);
						var t = p.data("msg.el");
						if (!t) {
							t = f(o.message).addClass(o.messageClass).appendTo(
									document.body);
							var s = p.data("validcode")
									|| p.data("qsvalidcode") || p.attr("name");
							if (s) {
								t.addClass(s.replace(".", "_") + "ErrorMsg")
							}
							if (o.zIndex) {
								t.css("z-index", o.zIndex)
							}
							p.data("msg.el", t)
						}
						t.css({
							visibility : "hidden"
						}).find("p").remove();
						f.each(r.messages, function(w, v) {
							f("<p/>").html(v).appendTo(t.find("i"))
						});
						if (t.outerWidth() == t.parent().width()) {
							t.add(t.find("p")).css({
								display : "inline"
							})
						}
						var u = m(p, t, o);
						t.css({
							visibility : "visible",
							position : "absolute",
							top : u.top,
							left : u.left
						}).fadeIn(o.speed)
					})
				}, function(n) {
					var o = this.getConf();
					n.removeClass(o.errorClass).each(function() {
						var p = f(this).data("msg.el");
						if (p) {
							p.css({
								visibility : "hidden"
							})
						}
					})
				} ]
	};
	f.each("email,url,number".split(","), function(o, n) {
		f.expr[":"][n] = function(p) {
			return p.getAttribute("type") === n
		}
	});
	f.fn.oninvalid = function(n) {
		return this[n ? "on" : "trigger"]("OI", n)
	};
	j.fn(":password", "请输入6-16位数字及字符组成的密码.", function(o, n) {
		return !n || h.test(n)
	});
	j.fn(":email", "请输入正确的邮箱地址", function(o, n) {
		return !n || a.test(n)
	});
	j.fn(":url", "请输入有效的URL", function(o, n) {
		return !n || g.test(n)
	});
	j.fn(":number", "请输入数字.", function(o, n) {
		return i.test(n)
	});
	j.fn("[max]", "Please enter a value no larger than $1", function(p, o) {
		if (o === "" || c && p.is(":date")) {
			return true
		}
		var n = p.attr("max");
		return parseFloat(o) <= parseFloat(n) ? true : [ n ]
	});
	j.fn("[min]", "Please enter a value of at least $1", function(p, n) {
		if (n === "" || c && p.is(":date")) {
			return true
		}
		var o = p.attr("min");
		return parseFloat(n) >= parseFloat(o) ? true : [ o ]
	});
	j.fn("[required]", "不能为空", function(o, n) {
		if (o.is(":checkbox")) {
			return o.is(":checked")
		}
		return !!n && n != o.data("tips")
	});
	j.fn("[pattern]", function(o, n) {
		return n === "" || new RegExp("^" + o.attr("pattern") + "$").test(n)
	});
	j.fn(":radio[required]", "Please select an option.", function(o) {
		var p = false;
		var n = f("[name='" + o.attr("name") + "']").each(function(q, r) {
			if (f(r).is(":checked")) {
				p = true
			}
		});
		return (p) ? true : false
	});
	j.fn("[data-equals]", "必须和$1相同", function(p, n) {
		var o = p.attr("data-equals");
		var q = this.getInputs().filter("[name=" + o + "]");
		return p.val() == q.val() ? true : [ o ]
	});
	function d(n, s, q) {
		var p = this, r = s.add(p);
		n = n.not(":button, :image, :reset, :submit");
		s.attr("novalidate", "novalidate");
		function o(x, v, t) {
			if (!q.grouped && x.length) {
				return
			}
			var w;
			if (t === false || f.isArray(t)) {
				w = j.messages[v.key || v] || j.messages["*"];
				w = w[q.lang] || j.messages["*"].en;
				var u = w.match(/\$\d/g);
				if (u && f.isArray(t)) {
					f.each(u, function(y) {
						w = w.replace(this, t[y])
					})
				}
			} else {
				w = t[q.lang] || t
			}
			x.push(w)
		}
		f.extend(p, {
			getConf : function() {
				return q
			},
			getForm : function() {
				return s
			},
			getInputs : function() {
				return n
			},
			reflow : function() {
				n.each(function() {
					var t = f(this), u = t.data("msg.el");
					if (u) {
						var v = m(t, u, q);
						u.css({
							top : v.top,
							left : v.left
						})
					}
				});
				return p
			},
			invalidate : function(t, u) {
				if (!u) {
					var v = [];
					f.each(t, function(x, y) {
						var w = n.filter("[name='" + x + "']");
						if (w.length) {
							w.trigger("OI", [ y ]);
							v.push({
								input : w,
								messages : [ y ]
							})
						}
					});
					t = v;
					u = f.Event()
				}
				u.type = "onFail";
				r.trigger(u, [ t ]);
				if (!u.isDefaultPrevented()) {
					b[q.effect][0].call(p, t, u)
				}
				return p
			},
			reset : function(t) {
				t = t || n;
				t.removeClass(q.errorClass).each(function() {
					var u = f(this).data("msg.el");
					if (u) {
						u.remove();
						f(this).data("msg.el", null)
					}
				}).off(q.errorInputEvent + ".v" || "");
				return p
			},
			destroy : function() {
				s.off(q.formEvent + ".V reset.V");
				n.off(q.inputEvent + ".V change.V");
				return p.reset()
			},
			checkValidity : function(u, x) {
				u = u || n;
				u = u.not(":disabled");
				var w = {};
				if (q.filterByName != false) {
					u = u.filter(function() {
						var y = f(this).attr("name");
						if (!w[y]) {
							w[y] = true;
							return f(this)
						}
					})
				}
				if (!u.length) {
					return true
				}
				x = x || f.Event();
				x.type = "onBeforeValidate";
				r.trigger(x, [ u ]);
				if (x.isDefaultPrevented()) {
					return x.result
				}
				var t = [];
				u.each(function() {
					if (f(this).is(":visible")) {
						var A = [], y = f(this).data("messages", A), z = c
								&& y.is(":date") ? "onHide.v"
								: q.errorInputEvent + ".v";
						y.off(z);
						f.each(l, function() {
							var D = this, B = D[0];
							if (y.filter(B).length) {
								var C = D[1].call(p, y, f.trim(y.val()));
								if (C !== true) {
									x.type = "onBeforeFail";
									r.trigger(x, [ y, B ]);
									if (x.isDefaultPrevented()) {
										return false
									}
									var E = y.attr(q.messageAttr);
									if (E) {
										A = [ E ];
										return false
									} else {
										o(A, B, C)
									}
								}
							}
						});
						if (A.length) {
							t.push({
								input : y,
								messages : A
							});
							y.trigger("OI", [ A ]);
							if (q.errorInputEvent) {
								y.on(z, function(B) {
									p.checkValidity(y, B)
								})
							}
						}
						if (q.singleError && t.length) {
							return false
						}
					}
				});
				var v = b[q.effect];
				if (!v) {
					throw 'Validator: cannot find effect "' + q.effect + '"'
				}
				if (t.length) {
					p.invalidate(t, x);
					return false
				} else {
					v[1].call(p, u, x);
					x.type = "onSuccess";
					r.trigger(x, [ u ]);
					u.off(q.errorInputEvent + ".v")
				}
				return true
			}
		});
		f.each("onBeforeValidate,onBeforeFail,onFail,onSuccess".split(","),
				function(u, t) {
					if (f.isFunction(q[t])) {
						f(p).on(t, q[t])
					}
					p[t] = function(v) {
						if (v) {
							f(p).on(t, v)
						}
						return p
					}
				});
		if (q.formEvent) {
			s.on(q.formEvent + ".V", function(t) {
				if (!p.checkValidity(null, t)) {
					return t.preventDefault()
				}
				t.target = s;
				t.type = q.formEvent
			})
		}
		s.on("reset.V", function() {
			p.reset()
		});
		if (n[0] && n[0].validity) {
			n.each(function() {
				this.oninvalid = function() {
					return false
				}
			})
		}
		if (s[0]) {
			s[0].checkValidity = p.checkValidity
		}
		if (q.inputEvent) {
			n.on(q.inputEvent + ".V", function(t) {
				p.checkValidity(f(this), t)
			})
		}
		n.filter(":checkbox, select").filter("[required]").on("change.V",
				function(u) {
					var t = f(this);
					if (this.checked || (t.is("select") && f(this).val())) {
						b[q.effect][1].call(p, t, u)
					}
				});
		n.filter(":radio[required]").on("change.V", function(u) {
			var t = f("[name='" + f(u.srcElement).attr("name") + "']");
			if ((t != null) && (t.length != 0)) {
				p.checkValidity(t, u)
			}
		});
		f(window).resize(function() {
			p.reflow()
		})
	}
	f.fn.validator = function(o) {
		var n = this.data("validator");
		if (n) {
			n.destroy();
			this.removeData("validator")
		}
		o = f.extend(true, {}, j.conf, o);
		if (this.is("form")) {
			return this.each(function() {
				var p = f(this);
				n = new d(p.find(":input"), p, o);
				p.data("validator", n)
			})
		} else {
			n = new d(this, this.eq(0).closest("form"), o);
			return this.data("validator", n)
		}
	}
})(jQuery);