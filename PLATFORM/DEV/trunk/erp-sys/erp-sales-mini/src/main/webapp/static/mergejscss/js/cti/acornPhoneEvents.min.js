function onOffHook(d,b,e,f,c,a){console.info("onOffHook>>>");$("#wrapper").removeAttr("class").addClass("onoffhook");$("#state a.c_btn").html("摘机").attr("for","leave").unbind().bind("click",function(){changeS(this)});$("#callContext").html('<span class="incoming fl"></span>');$("#state .arrow").unbind().bind("click",function(){toggleS()});$("a.logout").unbind();$("#callback").unbind().bind("click",function(){changeCS(this)});$("#state li").unbind().bind("click",function(){toggleSC(this)});$("#outbtn").unbind().bind("click",function(){outCall(phone)});$("table.keyboard a").unbind().bind("click",function(){toggleSPE(this)});$("#softphoneWrap").unbind().bind("click",function(){toggleSP()})}function onReady(d,b,e,f,c,a){$("#callContext").html('<span class="incoming fl"></span>');$("#wrapper").removeAttr("class").addClass("onReady");$("#state a.c_btn").html("就绪").attr("for","leave").unbind().bind("click",function(){changeS(this)});console.log("5+就绪"+_source);$("#state").unbind().bind("click",function(){toggleS()});$("a.logout").unbind().bind("click",function(){logout()});$("#callback").unbind().bind("click",function(){changeCS(this)});$("#softphoneWrap").unbind().bind("click",function(){toggleSP()});$("#state li").unbind().bind("click",function(){toggleSC(this)});$("table.keyboard a").unbind().bind("click",function(){toggleSPE(this)});$("#outbtn").unbind().bind("click",function(){outCall(phone)});$("#transferPhoneBtn").unbind()}function onReadyOut(d,b,e,f,c,a){$("#wrapper").removeAttr("class").addClass("onReadyOut");$("#callContext").html("");$("#state a.c_btn").html("就绪(可外呼)").attr("for","ready").unbind().bind("click",function(){changeS(this)});$("#state .arrow").unbind().bind("click",function(){toggleS()});$("#callback").unbind().bind("click",function(){changeCS(this)});$("#softphoneWrap").unbind().bind("click",function(){toggleSP()});$("table.keyboard a").unbind().bind("click",function(){toggleSPE(this)});$("#outbtn").unbind().bind("click",function(){outCall(phone)});$("#transferPhoneBtn").unbind()}function onLeaving(d,b,e,f,c,a){$("#wrapper").removeAttr("class").addClass("onLeaving");$("#state a.c_btn").html("离席").attr("for","ready").unbind().bind("click",function(){changeS(this)});if(phone.leavingReason){$("#state a.c_btn").html("离席("+phone.leavingReason+")").attr("for","ready").unbind().bind("click",function(){changeS(this)})}$("#callContext").html('<span class="incoming fl"></span>');$("#state .arrow").unbind().bind("click",function(){toggleS()});$("a.logout").unbind().bind("click",function(){logout()});$("#callback").unbind().bind("click",function(){changeCS(this)});$("#state li").unbind().bind("click",function(){toggleSC(this)});$("#outbtn").unbind().bind("click",function(){outCall(phone)});$("table.keyboard a").unbind().bind("click",function(){toggleSPE(this)});$("#softphoneWrap").unbind().bind("click",function(){toggleSP()})}function onRinging(d,b,e,f,c,a){$("#callContext").css({width:30,"padding-left":0,"padding-right":0,"margin-right":"0"});$("#callContext .incoming").addClass("incoming_ac").show();$("#transferPhoneBtn").unbind()}function onTalking(d,b,e,f,c,a){$("#callContext").html('<span class="insure">'+phone.insure+'</span><span class="incoming incoming_ac fl"></span><span class="callin fl"><font id="time" class="time fl"></font><div id="num" class="clearfix"><span id="marquee" class="fl ml5 c_combo pl5"  style="height:25px;padding-right:18px">'+d+"("+a+')<span class="arrow"></span></span><div class="marquee_hover pl5 pr5"><div>'+d+"("+a+')</div><div class="">&nbsp;<a class="callback" onclick="callLocalhost(this);">本地</a>&nbsp;<a class="callback" onclick="callLongDistance(this);">长途</a>&nbsp;<a class="addBlacklist" onclick="addBlack(this);">加黑</a>&nbsp;</div></div></div>'+c+"&nbsp;&nbsp;"+e+"&nbsp;"+phone.dnsi+'</span><a id="onHook" title="挂机" class="onHook" href="javascript:void(0)"></a><span id="end" class="end" title="结束会话" ></span>');if($("#callback").attr("value")==1){$("#onHook").replaceWith('<span class="onHook"></span>')}$("#callContext").animate({width:$("#callContext").find(".callin").width()+50,paddingLeft:"30px",paddingRight:0,marginRight:"55px"},0,function(){$(this).width("");console.info("3333333:"+phone.customerId);$.post("/customer/mycustomer/phone/find",{phone:phone2},function(h){if(h.result){if(h.total==1){var g=h.rows;var i=g[0];phone.customerId=i.contactId;phone.customerType=i.contactType;if(i.contactType=="2"){if($("#callback").val()==1){gotoInfoCallBack(i.contactId,2,phone.ani)}else{gotoInfoCustomer(i.contactId,2,phone.ani,false)}createRecommendTask(phone.dnsi,phone.ani,i.contactId,"2")}else{if($("#callback").val()==1){gotoInfoCallBack(i.contactId,1,phone.ani,false)}else{gotoInfoCustomer(i.contactId,1,phone.ani,false)}createRecommendTask(phone.dnsi,phone.ani,i.contactId,"1")}}else{queryCustomer("","createRecommendTaskCallback","incomingCall",phone2);findCustomer()}}else{$.post("/customer/mycustomer/potentialContact/add",{phn1:phone1,phn2:phone2,phn3:phone3,phonetype:phoneType},function(j){if(j.result){phone.customerId=j.potentialContactId;phone.customerType="2";if($("#callback").val()==1){gotoInfoCallBack(j.potentialContactId,2,phone.ani,false)}else{gotoInfoCustomer(j.potentialContactId,2,phone.ani,false)}createRecommendTask(phone.dnsi,phone.ani,j.potentialContactId,"2")}else{}})}})});$("#onHook").one("click",function(){$("#transferPhoneBtn").unbind();isMyRelease=true;console.info("release:"+177);if(phone.isOutBoound){document.getElementById(outphoneFrameId).contentWindow.loadingFadeOut()}release();phone.changeStatus(7);$.get("/common/getVersion",function(g){$("#span_intradayTotalOutcallTime").html(g.totalOutcallTime+"秒")})});$("#num").hover(function(){$(".marquee_hover").fadeIn()},function(){$(".marquee_hover").fadeOut()});if(countup!=null){countup.reset()}countup=$.countup(timer);$("#state a.c_btn").html("通话中").attr("for","hold");$("#wrapper").removeAttr("class").addClass("onTalking");if(f){$("#callContext .incoming").addClass("incoming_out")}$("#callback").unbind();$("a.logout").unbind();$("table.keyboard a").unbind().bind("click",function(){toggleSPE(this)});$("#transferPhoneBtn").unbind().bind("click",function(){$("#div_transferPhone").attr("class","c_combo throughconnect");$("#div_transferPhone").attr("title","转接");transferPhone()})}function onDialing(d,b,e,f,c,a){$("#callContext").css({width:30,"padding-left":0,"padding-right":0,"margin-right":"0"});$("#callContext").html('<span class="insure">'+phone.insure+'</span><span class="incoming incoming_ac fl"></span><span class="callin fl"><font id="time" class="time fl"></font><div id="num" class="clearfix"><span id="marquee" class="fl ml5 c_combo pl5"  style="height:25px;padding-right:18px">'+d+"("+a+')<span class="arrow"></span></span><div class="marquee_hover pl5 pr5"><div>'+d+"("+a+')</div><div class="">&nbsp;<a class="callback" onclick="callLocalhost(this);">本地</a>&nbsp;<a class="callback" onclick="callLongDistance(this);">长途</a>&nbsp;<a class="addBlacklist" onclick="addBlack(this);">加黑</a>&nbsp;</div></div></div>'+c+""+e+""+phone.dnsi+'</span><a id="onHook" title="挂机" class="onHook" href="javascript:void(0)"></a><span id="end" class="end"  title="结束会话"></span>');$("#callContext").animate({width:$("#callContext").find(".callin").width(),paddingLeft:"30px",paddingRight:0,marginRight:"55px"},"slow",function(){$(this).width("")});$("#onHook").one("click",function(){isMyRelease=true;console.info("release:"+238);release();phone.changeStatus(7);$("#onHook").replaceWith('<span class="onHook"></span>');$("#end").replaceWith('<a id="end" class="end" title="结束会话" onclick="javascript:openhookwin();"></a>')});$("#num").hover(function(){$(".marquee_hover").fadeIn()},function(){$(".marquee_hover").fadeOut()});countup=null;$("#state a.c_btn").html("呼出中").unbind();$("#state .arrow,#state").unbind();$("#callContext .incoming").addClass("incoming_out");$("#wrapper").removeAttr("class").addClass("onTalking").addClass("cOff")}function onTalkingOut(d,b,e,f,c,a){if(countup==null){countup=$.countup(timer)}$("#state a.c_btn").html("呼出通话中").attr("for","hold").unbind().bind("click",function(){changeS(this)});$("#state").unbind().bind("click",function(){toggleS()});$("#wrapper").removeClass("cOff");if(f){}$("#callback").unbind();$("a.logout").unbind();$("#transferPhoneBtn").unbind().bind("click",function(){$("#div_transferPhone").attr("class","c_combo throughconnect");$("#div_transferPhone").attr("title","转接");transferPhone()})}function onProcessing(d,b,e,f,c,a){if(countup!=null){countup.stop()}$("#outcon").text("挂机后处理");$("#onHook").replaceWith('<span class="onHook"></span>');if($("#callback").attr("value")==0){$("#end").replaceWith('<a id="end" class="end" title="结束会话" onclick="javascript:openhookwin();"></a>')}$("#callContext .incoming").removeClass("incoming_ac").addClass("loading");$("#wrapper").removeAttr("class").addClass("onProcessing");$("#state a.c_btn").html("后处理").attr("for","talking");$("#state .arrow").unbind();$("#state").unbind();$("#softphoneWrap").unbind();$("body").click()}function onHolding(d,b,e,f,c,a){$("#wrapper").removeAttr("class").addClass("onHolding");$("#state a.c_btn").html("保持").attr("for","ready");console.info("hold-293");hold()}function onOutringing(d,b,e,f,c,a){$("#callContext").css({width:30,"padding-left":0,"padding-right":0,"margin-right":"0"});$("#callContext").html('<span class="incoming incoming_ac fl"></span><span class="callin fl"><font id="time" class="time fl"></font><div id="num" class="clearfix"><span id="marquee" class="fl ml5 c_combo pl5"  style="height:25px;padding-right:18px">'+d+""+a+'<span class="arrow"></span></span><div class="marquee_hover pl5 pr5"><div>'+d+""+a+'</div><div class="">&nbsp;<a class="callback" onclick="callLocalhost(this);">本地</a>&nbsp;<a class="callback" onclick="callLongDistance(this);">长途</a>&nbsp;<a class="addBlacklist" onclick="addBlack(this);">加黑</a>&nbsp;</div></div></div>'+c+""+e+""+b+'</span><a id="onHook" title="挂机" class="onHook" href="javascript:void(0)"></a><span id="end" class="end"  title="结束会话"></span>');$("#callContext").animate({width:$("#callContext").find(".callin").width(),paddingLeft:"30px",paddingRight:0,marginRight:"55px"},"slow",function(){$(this).width("")});$("#onHook").one("click",function(){isMyRelease=true;console.info("release:"+238);release();phone.changeStatus(7);$("#onHook").replaceWith('<span class="onHook"></span>');$("#end").replaceWith('<a id="end" class="end" title="结束会话" onclick="javascript:openhookwin();"></a>')});$("#num").hover(function(){$(".marquee_hover").fadeIn()},function(){$(".marquee_hover").fadeOut()});$("#callContext .incoming").addClass("incoming_out");$("#state a.c_btn").html("呼出中");$("#wrapper").removeAttr("class").addClass("onTalking")}function onOutcall(d,b,e,f,c,a){if(countup!=null){countup.reset()}countup=$.countup(timer);$("#state a.c_btn").html("呼出通话中").attr("for","hold");$("#wrapper").removeAttr("class").addClass("onTalking");if(f){}$("#callback").unbind();$("a.logout").unbind()}function offline(ani,dnsi,tollFreeNum,isOutBoound,company,province){$("#wrapper").removeAttr("class").addClass("offline");$("#state a.c_btn").html("未登录");$("#softphoneWrap").unbind();$("#callback").unbind();$("#state").unbind();$("a.logout").unbind().bind("click",function(){logout()});if(eval($("#isLoadSoftPhone").val())){$("#state .arrow").unbind().bind("click",function(){toggleS()});$("#state li").unbind().bind("click",function(){toggleSC(this)});$("#state a.c_btn").attr("for","leave").unbind().bind("click",function(){changeS(this)})}else{$("#state").addClass("discombo")}}function setCallBack(){switch($("#callback").attr("value")){case"0":$("#left,#right,#apptabs").find(".c_mask").remove();break;case"1":if($("#left .c_mask,#right .c_mask,#apptabs .c_mask").length==0){$("#left,#right").append('<div class="c_mask"></div>');$("#apptabs").append('<div class="c_mask" style="padding-top:3px;border-radius:5px 5px 0 0"></div>')}break}}function toggleS(){$("#state").addClass("selected");event.stopPropagation();colseSel($("#state"))}function changeS(a){event.stopPropagation();switch($(a).attr("for")){case"ready":if(phone.status==12){console.info("取回保持＞＞＞＞");retrieve();if(phone.isOutBoound){$("#state a.c_btn").html("呼出通话中").attr("for","hold")}else{$("#state a.c_btn").html("通话中").attr("for","hold")}$("#wrapper").removeAttr("class").addClass("onTalking");break}else{if(isDailSelf()){return}phone.changeStatus(0);ready();console.info("ready:"+345)}break;case"leave":if(phone.status==15){ctilogin();break}$("li.leave dl dt").toggleClass("open").nextAll().show();toggleS();break;case"hold":phone.changeStatus(12);break}}function flod(){$("li.leave dl dt").unbind().bind("click",function(){$(this).toggleClass("open").nextAll().slideToggle()});$("li.leave dl dd").unbind().bind("click",function(){console.info("click leave reson...");if(isDailSelf()){return}notReady($(this).attr("value"));console.info("notReady:375");event.stopPropagation();$("#state").removeClass("selected");$("#state ul").slideUp();$(this).parent().find("dd").hide();phone.leavingReason=$(this).text();phone.changeStatus(2)})}function changeCS(a){switch(parseInt($(a).attr("value"))){case 0:$(a).removeAttr("class").addClass("callback_y").attr("value","1");phone._expir=40;break;case 1:$(a).removeAttr("class").addClass("callback_n").attr("value","0");$("#left,#right,#apptabs").find(".c_mask").remove();phone._expir=300;destoryTab("CallbackTab");break}}function colseSel(a){$("body").click(function(){if(a.hasClass("opened")){a.removeClass("opened");clearProvinceCity()}else{if(a.hasClass("selected")){a.removeClass("selected")}else{if(a.hasClass("on")){a.removeClass("on")}}}})}function toggleSP(){$("#softphoneWrap").addClass("opened");event.stopPropagation();$("#delNum").unbind().bind("click",function(){$("#notelist").combobox("setValue","")});colseSel($("#softphoneWrap"))}function toggleSPE(a){if($("#notelist").combobox("getValue").length<5){$("#notelist").combobox("setValue",$("#notelist").combobox("getValue")+""+$(a).text())}}function keyComboxE(a){$("#pnum").attr("value",$(a).text());$("#pnum a").eq(0).html($(a).text()+'<span class="arrow"></span>');$("#pnum").removeClass("selected");$("#pnum a.delNum").show()}function outCall(b){console.info("======================"+getDnStatus(null));if(checkSoftPhoneApplet()){if($("#ctiPhoneType").val()==1){if(callbackIsRelease==1){msgSlide("分机资源忙!");return}else{if(getDnStatus(null)){msgSlide("电话没有摘机，请摘机！！");return}}}}if(isDailSelf()){return}event.stopPropagation();console.info("phoneNo580:"+$("#citylist").combobox("getValue"));var c=$("#citylist").combobox("getValue").trim()+""+$("#notelist").combobox("getValue"),a=$("#prolist").combobox("getValue")+$("#citylist").combobox("getValue");console.info("phoneNo581:"+c);console.info("phoneNo582:"+a);if(c.trim().length==0){return}console.info("phoneNo"+c);switch(b.status){case 0:phoneOUTfun(c);b.status=13;if(checkSoftPhoneApplet()){findoutphone=1;console.info("8"+b);dial("8"+c,null)}break;case 1:phoneOUTfun(c);b.status=13;if(checkSoftPhoneApplet()){findoutphone=1;dial("8"+c,null)}break;case 2:phoneOUTfun(c);if(checkSoftPhoneApplet()){findoutphone=1;dial("8"+c,null)}break;case 4:break;case 6:case 14:if(checkSoftPhoneApplet()){console.info("638");sendDtmf(c)}break}$("#softphoneWrap").removeClass("opened");$("#notelist,#prolist,#citylist").combobox("setValue","")}function phoneOUTcallback(){phoneOUT.changeStatus(13);phoneOUT.changeStatus(14);phone.status=14}function delCon(a){$("#pnum a.white").html('<span class="arrow"></span>');$("#pnum a.delNum").hide()}function toggleSC(a){event.stopPropagation();switch($(a).attr("class")){case"loginphone":ctilogin();$("#state").removeClass("selected");break;case"ready":$("#state").removeClass("selected");if(phone.status==12){console.info("取回保持＞＞＞＞");retrieve();if(phone.isOutBoound){$("#state a.c_btn").html("外呼通话中").attr("for","hold")}else{$("#state a.c_btn").html("通话中").attr("for","hold")}$("#wrapper").removeAttr("class").addClass("onTalking");break}else{phone.changeStatus(0);ready();console.info("ready:"+503);break}case"cancelHold":$("#state").removeClass("selected");if(phone.status==12){console.info("取回保持＞＞＞＞");retrieve();if(phone.isOutBoound){$("#state a.c_btn").html("外呼通话中").attr("for","hold")}else{$("#state a.c_btn").html("通话中").attr("for","hold")}$("#wrapper").removeAttr("class").addClass("onTalking")}break;case"leave":return;break;case"hold":console.info("hold-502");console.info("hold--list");$("#state").removeClass("selected");phone.changeStatus(12);break}}function timer(b,c){var a='<span id="min">('+c.minute+'</span>:<span id="sec">'+c.second+")</span>";if(phone.status==4){if(countup!=null){if(c.total>phone._expir){$("#time").toggleClass("yel");setTimeout(function(){$("#time").toggleClass("yel")},500)}}}if(c.total>3600){a='<span id="hour">('+c.hour+'</span>:<span id="min">'+c.minute+'</span>:<span id="sec">'+c.second+")</span>"}$("#time").html(a)}var countup=null;var phone=null;$(function(){phone=new AcornPhone();phone.onOffHook=onOffHook;phone.onLeaving=onLeaving;phone.onReady=onReady;phone.onTalking=onTalking;phone.onProcessing=onProcessing;phone.onHolding=onHolding;phone.onRinging=onRinging;phone.onReadyOut=onReadyOut;phone.onOutringing=onOutringing;phone.onOutcall=onOutcall;phone.offline=offline;phone.init();flod();if($.browser.mozilla){var a=function(){var b=a.caller;while(b.caller){b=b.caller}return b.arguments[0]};__defineGetter__("event",a)}$("#add1 a").click(function(){event.stopPropagation();$("#add1").addClass("selected")});$("#add2 a").click(function(){event.stopPropagation();$("#add2").addClass("selected")});$("#add1 li,#add2 li").click(function(){$(this).parent().parent().attr("value",$(this).text());$(this).parent().prev().find("span.c_context").text($(this).text())});$("#interrupt").click(function(){interrupt()});$("#inbb").click(function(){inphone()});$("#hooksave").click(function(){phone.insure="";var c="";console.info(getDnStatus(null));$("#hookMsg").html("");$("#callResult").selectedIndex=0;$("#callType").selectedIndex=0;if(checkSoftPhoneApplet()){if(!getDnStatus(null)){$("#hooksave").tooltip("show");return}}if(phone.isOutBoound){c=phone.instId}else{c=getRecommandTaskId()}if(typeof(c)=="undefined"){w_indexId=""}if($("#h_hookForm").form("validate")){var d=$("#d_selcontact").attr("checked")?true:false,b=$("#h_isContact").attr("checked")?true:false;if(d&&b){if($("#d_seat").combobox("getValue").length==0){alertWin("系统提示","请选择座席")}}$.ajax({type:"post",async:false,url:"/common/outbound/hook",data:{isContact:b,contactTime:$("#h_contactTime").datebox("getValue"),remark:$("#h_remark").val(),h_instId:c,ani:phone.ani,dani:phone.dnsi,time_length:phone.seconds,marketingPlan:$("#d_marketingPlan").combobox("getValue"),d_reson:$("#d_reson").combobox("getValue"),isOutbound:phone.isOutBoound,d_selcontact:d,d_dept:$("#d_dept").combobox("getValue"),d_group:$("#d_group").combobox("getValue"),d_seat:$("#d_seat").combobox("getValue"),ctiedt:phone.ctiedt,callResult:$("#callResult").val(),callType:$("#callType").val()},dataType:"json",success:function(f){try{var g=parseInt($("input[name='hook_st']:checked").val());phone.changeStatus(g);switch(g){case 0:if(checkSoftPhoneApplet()){ready();console.info("ready:"+629)}else{phone.changeStatus(0)}break;case 1:notReadyState=1;if(checkSoftPhoneApplet()){notReady("1201");console.info("ready:"+632)}else{phone.changeStatus(1)}break;default:if(checkSoftPhoneApplet()){phone.leavingReason=$("#notReadyCode").combobox("getText");notReady($("#notReadyCode").combobox("getValue"));console.info("notReady 637")}else{phone.changeStatus(2)}}}catch(e){console.info("保存通话结果异常::"+e)}finally{if(phoneOUT){phoneOUT=null}$("#hook").window("close");$("#h_contactTime").datebox("setValue","");$("#h_contactTime").datebox("disable");$("#d_selectTask").css("display","none");$("#span_intradayTotalOutcallTime").html(f.totalOutcallTime+"秒");closeAllTabs();if(b){if($("#d_marketingPlan").combobox("getValue")=="10"){if(phone.customerId.length>1){gotoInfoCustomer(phone.customerId,phone.customerType,phone.customerId,false)}}}}},error:function(){$("#hook").window("close");closeAllTabs();console.info("post fail in url=/common/outbound/hook");alertWin("系统提示","post failed in url=/common/outbound/hook");phone.changeStatus(2);if(phoneOUT){phoneOUT=null}}})}})});function inphone(){$("#w_inphone").window("open")}var phone1="",phone2="",phone3="",phoneType="",isCloseFindC=true,taskId="",phoneOUT=null,isMyRelease,outphoneFrameId=null;var isSoftPhoneLogin=0;function outphone(d,f,b,h,e,a,g){try{outphoneFrameId=g}catch(c){}if(checkSoftPhoneApplet()){if($("#ctiPhoneType").val()==1){if(callbackIsRelease==1){document.getElementById(outphoneFrameId).contentWindow.loadingFadeOut();msgSlide("分机资源忙!");return}else{if(getDnStatus(null)){document.getElementById(outphoneFrameId).contentWindow.loadingFadeOut();msgSlide("电话没有摘机，请摘机！！");return}}}}if(isDailSelf()){return}phone=new AcornPhone(d,$("#d_dn").html(),"",true);phone.boundType=a;phone.onLeaving=onLeaving;phone.onOffHook=onOffHook;phone.onReady=onReady;phone.onTalking=onTalking;phone.onProcessing=onProcessing;phone.onHolding=onHolding;phone.onRinging=onRinging;phone.onDialing=onDialing;phone.onTalkingOut=onTalkingOut;phone.onReadyOut=onReadyOut;phone.onOutringing=onOutringing;phone.onOutcall=onOutcall;phone.offline=offline;phone.instId=b;phone.customerId=h;phone.customerType=e;cleanOnHook();outgoingCall("",phone.instId);$.ajax({type:"post",url:"/common/splicePhone",data:"inPhone="+phone.ani,async:false,dataType:"json",success:function(i){if(i.result){phone.province=i.dto.provName+i.dto.cityName;insrueCheck(null,i.dto.provName,i.dto.cityName)}else{phone.province="";return}}});$.ajax({type:"post",url:"/common/fatch/message",data:"h_instId="+phone.instId+"&ani="+phone.ani+"&dani="+phone.dnsi+"&boundType="+phone.boundType+"&ctisdt="+phone.ctisdt,async:false,dataType:"json",success:function(i){}});if(checkSoftPhoneApplet()){if(phone.ani.substring(0,1)==1){if(f==2){console.info("dial1.............");dial("80"+phone.ani,null)}else{console.info("dial2.............");dial("8"+phone.ani,null)}}else{console.info("dial3.............");dial("8"+phone.ani,null)}}else{console.info("没有加载软电话");phone.changeStatus(5);phone.changeStatus(6);$("#h_instId").val(phone.instId)}}function dialCallback(a){console.info("外呼回调");phone.dnsi=a.thisDN;phone.changeStatus(6);phone.connStates=a.status;phone.cticonnid=a.connId;$("#h_instId").val(phone.instId);$.ajax({type:"post",url:"/common/fatch/message/callback",data:"h_instId="+phone.instId+"&ani="+phone.ani+"&dani="+phone.dnsi+"&boundType="+phone.boundType+"&connId="+a.connId+"&ctisdt="+phone.ctisdt,async:false,dataType:"json",success:function(b){}})}function phoneOUTfun(a){phoneOUT=new AcornPhone(a,$("#d_dn").html(),"",true);phoneOUT.boundType="";phoneOUT.onOffHook=onOffHook;phoneOUT.onLeaving=onLeaving;phoneOUT.onReady=onReady;phoneOUT.onTalking=onTalking;phoneOUT.onProcessing=onProcessing;phoneOUT.onHolding=onHolding;phoneOUT.onRinging=onRinging;phoneOUT.onDialing=onDialing;phoneOUT.onTalkingOut=onTalkingOut;phoneOUT.onOutringing=onOutringing;phoneOUT.onOutcall=onOutcall}function cleanOnHook(){$("#h_remark").val("");$("#h_contactTime").datebox("setValue","");$("#h_isContact").attr("checked",false);$("#h_instId").val("")}function outPhone2(b,a){$.post("/customer/mycustomer/phone/find",{phone:b},function(d){if(d.result){if(d.total==1){var c=d.rows;var e=c[0];phone.customerId=e.contactId;phone.customerType=e.contactType;phone.ani=b;if(a!=null&&a!=""){relateContactWithTask(e.contactId,a,true);a=""}gotoInfoCustomer(e.contactId,phone.customerType,phone.ani,false)}else{if(a!=null&&a!=""){window.taskId=a;queryCustomer("","relateContactWithTask","outCall",b);findCustomer()}}}else{$.ajax({type:"post",url:"/common/splicePhone",data:"inPhone="+b,async:false,dataType:"json",success:function(f){if(f.result){phone.province=f.dto.provName+f.dto.cityName;phone1=f.dto.phn1;phone2=f.dto.phn2;phone3=f.dto.phn3;$("#d_provid").val(f.dto.provid);$("#d_cityid").val(f.dto.cityid);phoneType=f.dto.phonetypid}else{phone.province="";alertWin("系统提示",f.msg);return}$.post("/customer/mycustomer/potentialContact/add",{phn1:phone1,phn2:phone2,phn3:phone3,phonetype:phoneType},function(g){if(g.result){phone.customerId=g.potentialContactId;phone.customerType="2";if(a!=null&&a!=""){relateContactWithTask(g.potentialContactId,a,true);a=""}gotoInfoCustomer(g.potentialContactId,2,phone.ani,false)}else{}})}})}})}function comingIn(f,b,g,h,d,c,e){phone.isOutBoound=false;phone.leadId="";phone.customerId="";phone.customerType="";phone.isOutBoound=false;if(!checkSoftPhoneApplet()){f=$("#d_inPhone").val();b=$("#d_dnis").val()}else{phone.cticonnid=g;phone.connStates=h;if(d!=null&&c!=null){phone.customerId=d;phone.customerType=c;phone.leadId=e;if(phone.status!=2){istransferComing=1;return}}else{istransferComing=0;phone.customerId="";phone.customerType="";phone.leadId=""}}var a="";phone.ani=f;$.ajax({type:"post",url:"/common/splicePhone",data:"inPhone="+f,async:false,dataType:"json",success:function(i){if(i.result){insrueCheck(b,i.dto.provName,i.dto.cityName);phone.province=i.dto.provName+i.dto.cityName;phone1=i.dto.phn1;phone2=i.dto.phn2;phone3=i.dto.phn3;$("#d_provid").val(i.dto.provid);$("#d_cityid").val(i.dto.cityid);phoneType=i.dto.phonetypid}else{phone.province="";alertWin("系统提示",i.msg);return}}});if(phoneType==4){phone.ani=phone2}phone.dnsi=b;phone.isOutBoound=false;$.ajax({type:"post",url:"/common/get400",data:"dnis="+b,async:false,dataType:"json",success:function(i){console.info("获取4000.....");if(i.result){phone.tollFreeNum=typeof(i.mediaPlan.tollFreeNum)=="undefined"?"":i.mediaPlan.tollFreeNum;phone.company=typeof(i.mediaPlan.mediaName)=="undefined"?"":i.mediaPlan.mediaName}else{phone.tollFreeNum="";phone.company=""}}});phone.changeStatus(3);console.info("3333振铃");phone.changeStatus(4);console.info("444通话中");cleanOnHook();incomingCall(phone.dnsi);$("#w_inphone").window("close")}function insrueCheck(c,a,b){$.ajax({type:"post",url:"/common/insureValidate",data:{dnis:c,provinceName:a,cityName:b},async:false,dataType:"json",success:function(d){if(d){phone.insure="(大都会赠险活动)"}}})}$(document).ready(function(){$("#h_isContact").bind("click",function(){$("#warnMsg").html("");changeIsContact()});$("#d_selcontact").bind("click",function(){changeSelConact()});initNormalPhone();initProvinceCity();$("#d_marketingPlan").combobox({onSelect:function(a){if(a.id!=10){$("#v_reson").hide()}else{$("#v_reson").show()}}})});var changeSelConact=function(){var a=$("#d_selcontact").attr("checked")?true:false;if(a){$("#d_seat").combobox({required:true})}else{$("#d_seat").combobox({required:false})}};var changeIsContact=function(){$("#warnMsg").html("");var a=$("#h_isContact").attr("checked")?true:false;$.ajax({type:"post",url:"/common/get/CurrentPlanAndPlanList",data:"h_instId="+phone.instId+"&customerId="+phone.customerId,async:false,dataType:"json",success:function(b){if(!b.isfinished){$("#d_marketingPlan").combobox({disabled:true})}else{$("#d_marketingPlan").combobox({disabled:false})}if(b.boundCustomer){$("#h_isContact").attr("checked",false);$("#h_isContact").attr("disabled",true);$("#d_selectTask").css("display","none");$("#warnMsg").html("此客户已被其他座席绑定");return false}else{$("#warnMsg").html("");$("#d_marketingPlan").combobox({data:b.leadTypeList,valueField:"id",textField:"name",onLoadSuccess:function(){$.each(b.leadTypeList,function(c,d){if(d.id==b.campaignId){$("#d_marketingPlan").combobox("setValue",b.campaignId)}else{if(c==0){$("#d_marketingPlan").combobox("setValue",d.id)}}})}})}}});if(a){$("#h_contactTime").datebox("enable");$("#d_selectTask").css("display","block");if(phone.isOutBoound){$("#v_selcontact").hide()}else{$("#v_selcontact").show()}}else{$("#h_contactTime").datebox("setValue","");$("#h_contactTime").datebox("disable");$("#d_selectTask").css("display","none")}$("#d_dept").combobox({url:"/common/getAllDept",valueField:"id",textField:"name",onSelect:function(c){var b="/common/getGroupByDept?deptId="+c.id;$("#d_group").combobox("reload",b)}});$("#d_group").combobox({valueField:"id",textField:"name",onSelect:function(c){var b="/common/getSeatByGroup?groupId="+c.id;$("#d_seat").combobox("reload",b)}});$("#d_seat").combobox({valueField:"userId",textField:"displayName"})};var addBlack=function(a){$.ajax({url:"/blackList/addPhoneBlackList",contentType:"application/json",data:{customerId:phone.customerId,customerType:phone.customerType,phoneNum:phone.ani,instId:phone.instId}});$(a).hide()};var callLocalhost=function(a){if(phone.status==7){outphone(phone.ani,"",phone.instId,phone.customerId,phone.customerType,1)}};var callLongDistance=function(a){if(phone.status==7){boundType=1;outphone(phone.ani,"",phone.instId,phone.customerId,phone.customerType,1)}};var interrupt=function(a){console.log("interrupt--------"+a);if(a==4||a==6){if($("#callback").val()==1){$("#end").replaceWith('<span id="end" class="end" title="结束会话" ></span>');phone.changeStatus(7)}else{phone.changeStatus(7)}$.ajax({type:"post",url:"/common/phone/interrupt",data:"h_instId="+phone.instId+"&time_length="+phone.seconds+"&ctiedt="+phone.ctiedt+"&connId="+phone.cticonnid,async:false,dataType:"json",success:function(c){try{$("#span_intradayTotalOutcallTime").html(c.totalOutcallTime+"秒")}catch(b){console.info("error")}}})}};var openhookwin=function(){$("#hookMsg").html("");$("#callResult option").eq(0).attr("selected","true");$("#callType option").eq(0).attr("selected","true");if(phoneOUT){$("#h_isContact").attr("disabled",true)}else{$("#h_isContact").attr("disabled",false)}$("#content").animate({scrollTop:0},0);$("#warnMsg").html("");if(phone.isOutBoound&&phone.connStates!="Established"){$("#hook").window("open");if($("#seatType").val()=="IN"){$("input[name='hook_st']:eq(2)").attr("checked","checked")}else{$("input[name='hook_st']:eq(1)").attr("checked","checked")}}else{if(hasRecommendedItem()){$("#hook").window("open");if($("#seatType").val()=="IN"){$("input[name='hook_st']:eq(2)").attr("checked","checked")}else{$("input[name='hook_st']:eq(1)").attr("checked","checked")}}else{recommendMsg("您还没有推荐产品!!","red")}}};var transferPhone=function(){var a=$("#notelist").combobox("getValue");switch(istransferPhone){case 0:istransferPhone=2;$("#div_transferPhone").attr("class","c_combo retrieve");$("#div_transferPhone").attr("title","取回");initiateTransfer(a);console.info("电话转接:initiateTransfer");break;case 1:completeTransfer();istransferPhone=0;console.info("电话转接:completeTransfer");break;case 2:releaseLine2();retrieve();istransferPhone=0;console.info("电话转接:retrieve");break}};var initNormalPhone=function(){$("#notelist").combobox({url:"/common/normalPhone",valueField:"paraValue",textField:"paraValue",filter:function(a,b){return normalPhonefilter(a,b)},formatter:function(a){return a.name+"("+a.paraName+")"},onSelect:function(a){console.info(a.paraName.indexOf("-")==-1);if(a.paraName.indexOf("-")==-1){$("#proAndCtili").show()}else{$("#proAndCtili").hide()}}})};var normalPhonefilter=function(b,c){var a=c.name+c.paraName;return a.indexOf(b)>=0};var initProvinceCity=function(){$("#prolist").combobox({url:"/common/province",valueField:"provinceId",textField:"provinceName",filter:function(a,b){return addressfilter(a,b)},onSelect:function(a){$("#citylist").combobox({onLoadSuccess:function(){}});$("#citylist").combobox({url:"/common/city?provinceId="+a.provinceId,valueField:"areaCode",textField:"areaCode",data:[{cityId:"",areaCode:""}],formatter:function(b){return formatCity(b)},filter:function(b,c){return addressfilter(b,c)}})}});if(!$.jStorage.get("city.json")){console.info("cityJson:++++++++++++++++++++");$.post("/static/plugin/city.json",function(a){$.jStorage.set("city.json",a);$("#citylist").combobox({data:$.jStorage.get("city.json")})})}else{console.info("cityJson:----------------------");$("#citylist").combobox({data:$.jStorage.get("city.json")})}$("#citylist").combobox({valueField:"areaCode",textField:"areaCode",filter:function(a,b){return addressfilter(a,b)},formatter:function(a){return formatCity(a)},onLoadSuccess:function(){$(this).combobox("clear")},onSelect:function(a){var b=a.value.split(address_split)[2];$("#prolist").combobox("reload","/common/province");$("#prolist").combobox("setValue",b)}})};function clearProvinceCity(){$("#prolist").combobox("setValue","");$("#citylist").combobox("setValue","")}function addressfilter(b,c){b=b.toUpperCase();var a=c.value.split(address_split)[0];return a.indexOf(b)>=0}function formatCity(a){return a.areaCode+"|"+a.cityName}function showCtiError(result){var stu=eval("("+result+")");if(stu.errorCode==1140){msgSlide("登陆失败,请重新登陆");if(phone){phone.changeStatus(15)}return}else{if(stu.errorCode==1161){msgSlide("不正确的状态对象")}else{if(stu.errorCode==10116){msgSlide("尚未与CTI建立连接");if(phone){phone.changeStatus(15)}return}else{if(stu.errorCode==10001){msgSlide("请求参数不正确");if(phone){phone.changeStatus(15)}return}else{if(stu.errorCode==1160){}else{if(stu.errorCode==1172){}else{if(stu.errorCode==1199){msgSlide("话机已签出,请签入")}else{if(stu.errorCode==10101){}}}}}}}}if(ctiIsLogIn==0){if(phone){phone.changeStatus(15)}}else{if(phone){phone.changeStatus(2)}}}function ctilogin(){if(checkSoftPhoneApplet()){isSoftPhoneLogin=1;document.location.reload()}}(function(){window.onbeforeunload=function(){var c=document.all?true:false;if(c){var d=window.event.screenX-window.screenLeft;var a=d>document.documentElement.scrollWidth-20;if(a&&window.event.clientY<0||window.event.altKey){closeSales();console.info("关闭")}else{console.info("刷新")}}else{if(document.documentElement.scrollWidth!=0&&isSoftPhoneLogin==0){closeSales();console.info("关闭")}else{console.info("刷新")}}}})();function closeSales(){$.ajax({type:"get",url:"/logout",data:"name="+$("#fn-bg").html().trim(),async:false,dataType:"json",success:function(a){}});agentLogout()}function msgSlide(a){$.messager.show({title:"",msg:a,showType:"slide",style:{right:"",top:document.body.scrollTop+document.documentElement.scrollTop+30,bottom:"",borderTopWidth:0,background:"-webkit-gradient(linear, 0 0, 0 100%, from(#fffcd2), to(#fff8bc))",borderRadius:"0 0 4px 4px"}})}function changeCtiOnAndOff_off(){$("#cti_onAndOff").attr("src","/static/images/phone-lamp-red.png")}function changeCtiOnAndOff_on(){$("#cti_onAndOff").attr("src","/static/images/phone-lamp-gray.png")}function hiddenCtiOnAndOff(){$("#cti_onAndOff").hide()}function isDailSelf(){if(checkSoftPhoneApplet()){if($("#ctiPhoneType").val()==1){if(dailSelf==1){console.info("dailSelf..."+1);msgSlide("系统资源忙,请稍候再试...");return true}}}return false};