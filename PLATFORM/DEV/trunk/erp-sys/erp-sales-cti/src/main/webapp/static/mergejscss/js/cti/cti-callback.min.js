var callstatus=0;var isRemoved=false;var autoReady=false;var findoutphone=0;var istransferPhone=0;var istransferComing=0;var citOnOff=0;var callbackIsRelease=0;var dailSelf=0;function onInitialized(){}function onAgentStatusChanged(a){if(a.voice=="LoggedIn"){ctiIsLogIn=1;$("#cti_jre").hide();notReady(null);console.info("cti--notReady");phone.changeStatus(2)}else{if(a.voice=="Ready"){phone.changeStatus(0)}else{if(a.voice=="NotReady"){try{if(a.reason==1200){if(phone.status!=7){phone.changeStatus(-1)}notReadyState=0;return}}catch(b){}console.info("notReady>>>>>>>>>>>>>>>>>>>");if(notReadyState==1){phone.changeStatus(1)}else{if(isMyRelease||!isRemoved){if(phone){if(a.reason==1201){phone.changeStatus(1)}else{console.info("reasonCode:"+a.reason);phone.changeStatus(2)}}}}notReadyState=0}else{if(a.voice=="LoggedOut"){ctiIsLogIn=0;phone.changeStatus(15)}}}}isRemoved=false}function onConnectionStatusChanged(a){console.log(a);if(a.voice=="Registered"){login()}else{if(a.voice=="Disconnected"){phone.changeStatus(15)}else{connStatus=0}}$(".connectionStatus").text(a.voice)}function onError(a){showCtiError(a);console.log(a)}function onInteractionAdded(a){isMyRelease=false;autoReady=false;console.log("onInteractionAdded:"+a);if(a.status=="Ringing"){callstatus=0;isInitiate=0;phone.ctisdt=a.timeStamp;console.info("istransferComing:"+istransferComing);if(istransferComing==0){callAnswer()}else{istransferComing=1}try{if(a.attachedData.RTargetRequested){console.info("设置坐席等级------");$("#d_employeeType").html(getAagentLevel(a.attachedData.RTargetRequested))}else{console.info("设置坐席等级------");$("#d_employeeType").html("--")}}catch(b){console.info("设置坐席等级------")}try{if(a.attachedData.SKILL_GROUP){phone.acdId=a.attachedData.SKILL_GROUP;console.info("result.acdId------"+phone.acdId)}else{console.info("result.acdId------");phone.acdId=""}}catch(b){console.info("result.acdId------");phone.acdId=""}if(a.callType!="Consult"){console.info("正常进线...");comingIn(a.ani,a.dnis,a.connId,a.status,null,null,null)}else{try{if(a.attachedData.batch){console.info("预测外呼");phone.campainId=a.attachedData.batch;comingIn(a.attachedData.GSW_PHONE.substr(1),a.thisDN,a.connId,a.status,null,null,null)}else{phone.campainId="";comingIn(a.attachedData.ani,a.dnis,a.connId,a.status,a.attachedData.customerId,a.attachedData.customerType,a.attachedData.leadId)}}catch(b){phone.campainId="";console.info("result.campainId------")}}}else{if(a.status=="Dialing"&&a.callType!="Consult"){callstatus=1;isInitiate=0;console.info("外呼...");try{console.info(83);document.getElementById(outphoneFrameId).contentWindow.loadingFadeOut()}catch(b){}console.info("findoutphone:"+findoutphone);if(findoutphone!=1){phone.changeStatus(5)}}else{if(a.attachedData.command==2){completeTransfer()}}}}function onInteractionUpdated(a){console.log("onInteractionUpdated:"+a);if(a.callType=="Outbound"&&a.status=="Established"){if(findoutphone==1){phoneOUTcallback()}else{phone.ctisdt=a.timeStamp;dialCallback(a)}findoutphone=0}if(a.callType=="Consult"&&a.status=="Established"){try{if(a.attachedData.command==1){if(istransferPhone==0){}else{console.info(125);istransferPhone=1;$("#div_transferPhone").attr("class","c_combo ok");$("#div_transferPhone").attr("title","完成")}}}catch(b){console.info("result.attachedData.command:"+b)}}else{if(a.callType=="Consult"){console.info(132);try{if(a.attachedData.command==1){}}catch(b){console.info("result.attachedData.command:"+b)}}}}function onInteractionRemoved(a){callbackIsRelease=0;if($("#notelist").combobox("getValue")==a.otherDN){return}if(a.thisDN!=a.otherDN){phone.ctiedt=a.timeStamp;phone.cticonnid=a.connId;try{if($("#callback").val()==1){$.get("/common/callback/setCtiInfo",{v_leadInterId:phone.leadInterId,ctiedt:phone.ctiedt,connId:phone.cticonnid})}else{$.get("/common/setCtiInfo",{h_instId:phone.instId,ctiedt:phone.ctiedt,connId:phone.cticonnid})}}catch(b){console.info("保存CtiInfo失败!!")}if(a.callType!="Consult"){console.info("phone.changeStatus:"+phone.status);phone.changeStatus(7);if(!isMyRelease){if(callstatus==0){console.info("interrupt4");if(autoReady==false){notReady("1202",3);console.info("notReady:cti :113");interrupt(4)}else{ready()}}else{if(autoReady==false){notReady("1202",3);console.info("notReady:cti :116");interrupt(6)}else{ready()}console.info("interrupt6")}}else{notReady("1202",3);console.info("notReady:cti :210")}findoutphone=0;isRemoved=true;console.log("onInteractionUpdated:"+a)}else{try{if(a.attachedData.command==1){return}}catch(b){}phone.ctiedt=a.timeStamp;console.info("phone.changeStatus:"+phone.status);phone.changeStatus(7);if(!isMyRelease){if(callstatus==0){console.info("interrupt4");if(autoReady==false){notReady("1202",3);console.info("notReady:cti :113");interrupt(4)}else{ready()}}else{if(autoReady==false){notReady("1202",3);console.info("notReady:cti :116");interrupt(6)}else{ready()}console.info("interrupt6")}}else{notReady("1202",3);console.info("notReady:cti :210")}findoutphone=0;isRemoved=true;console.log("onInteractionUpdated:"+a)}}else{console.info("dailSelf..."+0);dailSelf=0}}function onUserEvent(b){console.info("onUserEvent...."+b);switch(b.command){case"ready":ready();console.info("ready");break;case"notready":notReady();console.info("notready");break;case"releasecall":release();console.info("releasecall");break;case"bargein":console.info("bargein"+b.targetDN);singleStepConference(b.targetDN);console.info("bargein");break;case"message":console.info("message");var e=b.type;var d=b.agentId;var c=date2str(new Date(),"yyyy-MM-dd hh:mm:ss");console.info(c);var a=b.message;if(e==1){e="现场主管";bottomLeft(e,d,c,a)}else{e="业务主管";bottomRight(e,d,c,a)}break}}function date2str(x,y){var z={M:x.getMonth()+1,d:x.getDate(),h:x.getHours(),m:x.getMinutes(),s:x.getSeconds()};y=y.replace(/(M+|d+|h+|m+|s+)/g,function(v){return((v.length>1?"0":"")+eval("z."+v.slice(-1))).slice(-2)});return y.replace(/(y+)/g,function(v){return x.getFullYear().toString().slice(-v.length)})}function hookStatusChanged(a){console.info("onUserEvent...."+a);if(a=="onHook"){citOnOff=0;console.info("onUserEvent....（０）："+a);if(getDnStatus(null)){changeCtiOnAndOff_on();if(phone.status=="-1"){phone.leavingReason="";notReady("1203");phone.changeStatus(2)}}else{changeCtiOnAndOff_off()}}else{citOnOff=1;changeCtiOnAndOff_off();if(callbackIsRelease==0&&$("#ctiPhoneType").val()==1){if(isDial==0){notReady("1200")}}console.info("onUserEvent....（１）："+a)}};