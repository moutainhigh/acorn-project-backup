$().ready(function(){$("#tbNcfree").combobox({data:[],valueField:"ncfree",textField:"ncfreename",onSelect:function(d){var c=$("#tbNccode").val();var a=$(d).attr("ncfree");var b=$(d).attr("ncfreename");$.post("/inventory/sku",{nccode:c,ncfree:a,ncfreename:b},function(e){if($.isArray(e)&&e.length>0){var f=e[0];if(f!=null){$("#tbPlucode").val($(f).attr("productCode"));$("#tbListPrice").val($(f).attr("listPrice"));if($.isNumeric($(f).attr("groupPrice"))){$("#tbPriceScope").val(Math.min($(f).attr("groupPrice"),$(f).attr("minPrice"))+"-"+Math.max($(f).attr("groupPrice"),$(f).attr("maxPrice")))}else{$("#tbPriceScope").val($(f).attr("minPrice")+"-"+$(f).attr("maxPrice"))}$("#tbStockItem").val($(f).attr("availableQty")+" ("+($(f).attr("status")>=0?"无限制":"按库存销售")+")")}}})}});$("#tbKeyword").focus().autocomplete("/product/search",{minChars:2,max:12,autoFill:false,matchContains:false,matchSubset:false,scrollHeight:260,highlight:function(b,a){return b},parse:function(c){var a=[];if($.isArray(c)){for(var b=0;b<c.length;b++){var d=c[b];if(d){a[a.length]={data:d,value:null,result:this.formatResult&&this.formatResult(d,null)}}}}return a},formatItem:function(c,b,a){return'<span title="'+$(c).attr("spellcode")+'">'+$(c).attr("nccode")+" "+$(c).attr("spellname")+"</span>"},formatResult:function(a){return $(a).attr("nccode")}}).result(function(a,b){if(!b){$("#tbNccode").val("");$("#tbSpellcode").val("");$("#tbSpellname").val("");$("#tbStockItem").val("");$("#tbListPrice").val("");$("#tbPriceScope").val("");$("#tbNcfree").combobox("clear");$("#tbNcfree").combobox("loadData",[]);return}$("#tbNccode").val($(b).attr("nccode"));$("#tbSpellcode").val($(b).attr("spellcode"));$("#tbSpellname").val($(b).attr("spellname"));$("#tbStockItem").val("0");$("#tbListPrice").val($(b).attr("listPrice"));if($.isNumeric($(b).attr("groupPrice"))){$("#tbPriceScope").val(Math.min($(b).attr("groupPrice"),$(b).attr("minPrice"))+"-"+Math.max($(b).attr("groupPrice"),$(b).attr("maxPrice")))}else{if($(b).attr("minPrice")&&$(b).attr("maxPrice")){$("#tbPriceScope").val($(b).attr("minPrice")+"-"+$(b).attr("maxPrice"))}else{$("#tbPriceScope").val("0-0")}}$("#tbNcfree").combobox("clear");$("#tbNcfree").combobox("loadData",[]);$.post("/product/attributes",{nccode:$(b).attr("nccode")},function(c){$("#tbNcfree").combobox("clear");if($.isArray(c)&&c.length>0){$("#tbNcfree").combobox("loadData",c)}else{$("#tbNcfree").combobox("loadData",[])}});$.post("/inventory/item",{nccode:$(b).attr("nccode"),instId:getRecommandTaskId()},function(c){if($.isArray(c)&&c.length>0){$("#tbStockItem").val($(c[0]).attr("availableQty")+" ("+($(c[0]).attr("status")>=0?"无限制":"按库存销售")+")")}});$.post("/product/discourse",{nccode:$(b).attr("nccode")},function(d){var c=$(d).attr("discourseHtmlContent");$("#lblDiscourseInfo").html(c?c:"没有找到任何信息！")});if(appendRecommendItem&&$(b).attr("nccode")){appendRecommendItem($(b).attr("nccode"),$(b).attr("spellname"),false)}});$("#lnkStockItem").click(function(){var c=$("#tbNccode").val();if(c){var a=$("#tbNcfree").combobox("getValue");var b=$("#tbNcfree").combobox("getText");$.post("/warehouse/sku",{nccode:c,ncfree:a,ncfreename:b},function(d){$("#dgStockItem").datagrid("loadData",d);$("#dlgStockItem").window("open")})}else{window.parent.alertWin("系统提示","请先指定产品")}});$("#dlgStockItem").window({title:"商品库存明细",width:750,height:500,modal:true,shadow:false,collapsible:false,minimizable:false,maximizable:false,closed:true,draggable:false});$("#dgStockItem").datagrid({title:"",iconCls:"icon-edit",width:"100%",height:400,striped:true,border:true,scrollbarSize:16,collapsible:true,fitColumns:true,fit:true,idField:"productId",columns:[[{field:"productCode",title:"产品编码",width:100,editor:"text"},{field:"productName",title:"产品名称",width:100,editor:"text"},{field:"spellCode",title:"产品简码",width:120,editor:"text"},{field:"spellName",title:"产品简称",width:120,editor:"text",hidden:true},{field:"ncfree",title:"规格编码",width:120,editor:"text",hidden:true},{field:"ncfreeName",title:"规格名称",width:120,editor:"text"},{field:"warehouse",title:"仓库名称",width:120,editor:"text",hidden:true},{field:"warehouseName",title:"仓库名称",width:120,editor:"text"},{field:"onHandQty",title:"在库量",width:120,editor:"text",hidden:true},{field:"availableQty",title:"可用量",width:120,editor:"text"},{field:"status",title:"备注",width:120,editor:"text",formatter:function(a){return a=="-1"?"按库存销售":"无限制"}}]],remoteSort:false,singleSelect:true,checkOnSelect:false,selectOnCheck:false,pagination:false,rownumbers:false,onLoadSuccess:function(a){$(this).parent().find(".datagrid-btable").tableGroup({sumColumn:10,groupColumn:1,groupClass:"panel-header"})},onLoadError:function(){window.parent.alertWin("系统提示","加载失败!")}});$("#lnkAddFavorite").click(function(){var c=$("#tbNccode").val();if(c){var a=$("#tbNcfree").combobox("getValue");var b=$("#tbNcfree").combobox("getText");$.post("/inventory/addFavorite",{nccode:c,ncfree:a,ncfreename:b},function(d){window.parent.alertWin("系统提示",d);if(d.indexOf("成功")>-1){var e=window.frames.p_inventory;if(e){e.location.reload()}}},"text")}else{window.parent.alertWin("系统提示","添加收藏前，请先搜索出相关商品");$("#tbKeyword").focus()}})});function addCallbackProduct(){var a=window.frames.p_CallbackTab;if(a){if($(a).parent("div:visible")){if(a.addCallbackProduct){a.addCallbackProduct($("#tbNccode").val(),$("#tbSpellcode").val());return true}}}return false}function addShoppingCartProduct(){if(!addCallbackProduct()){var _currentPanel=$("#content").find("#center").find(".current").attr("id");if(_currentPanel){var _currentFrameId=_currentPanel.replace("tab_","p_");if(!$("#tbNccode").val()){window.parent.alertWin("系统提示","请输入加入购物车的产品");return}var options=$("#tbNcfree").combobox("getData").length;if(options>0&&!$("#tbNcfree").combobox("getValue")){window.parent.alertWin("系统提示","请选择加入购物车的产品规格");return}var child=window.frames[_currentFrameId];child.eval('addProduct("'+$("#tbNccode").val()+'","'+$("#tbNcfree").combobox("getText")+'","'+$("#tbListPrice").val()+'")')}}};