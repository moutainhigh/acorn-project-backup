function _handler(){$("#myorder_tabs").tabs("resize",{width:"100%"});$("#myOrderlist,#myOrderlist_pay,#myOrderlist_audit,#myProblemOrderlist,#reminderDataGrid").datagrid("resize",{width:"100%"})}var busiType=null;var parmMyOrder={xxx:0};var parmMyOrderPay={xxx:0};var parmMyOrderAudit={xxx:0};function setCrusrIds(a){$("#tbCrusr,#tbCrusr_pay,#tbCrusr_audit,#agentId,#input_problem_tbCrusr").val(a)}var b_order_pay_address_init=false;var bShowCondition=0;$(function(){if(isManager==false){$("#tbCrusr,#tbCrusr_pay,#tbCrusr_audit,#agentId,#input_problem_tbCrusr").attr("disabled","disabled")}if(isQualityInspector==true){if($("#tbCrusr").attr("disabled")!=false){console.debug($("#tbCrusr").attr("disabled"));$("#tbCrusr").removeAttr("disabled")}}var totalOrderCount=-1;var totalOrderPayCount=-1;var totalOrderAuditCount=-1;showMoreCondition(bShowCondition);var conditionHeight=0;$("#tbShowMoreCondition").click(function(){if(bShowCondition==0){bShowCondition=1}else{bShowCondition=0}showMoreCondition(bShowCondition)});$("#tbCrusr,#tbCrusr_pay,#tbCrusr_audit,#agentId,#input_problem_tbCrusr").blur(function(e){var usrid=$(this).val();setCrusrIds(usrid)});$("#tbStatus").combobox({data:orderStatuses,valueField:"id",textField:"dsc",onLoadSuccess:function(data){$("#status").combobox({data:data,valueField:"id",textField:"dsc"})},onChange:function(newValue,oldValue){if(newValue=="1"||newValue=="2"){$("#tbCheckResult").combobox("enable")}else{if(newValue=="10"){$("#tbCheckResult").combobox("setValue",3)}else{$("#tbCheckResult").combobox("setValue",2)}var validStatus=false;var index=0;for(index=0;index<orderStatuses.length;index++){if(newValue==orderStatuses[index].id){validStatus=true;break}}if(validStatus==true){$("#tbCheckResult").combobox("disable")}else{$("#tbCheckResult").combobox("enable")}}$("#myOrderallot").hide()}});$("#tbCheckResult").combobox({data:itemDataList,valueField:"id",textField:"val"});$("#tbCheckResult").combobox("setValue",2);$("#tbPaytype").combobox({data:payTypes,valueField:"id",textField:"dsc",onLoadSuccess:function(data){var notCodPayType=[];var index=0;$("#paytype").combobox({data:data,valueField:"id",textField:"dsc"});$("#tbPaytype_audit").combobox({data:data,valueField:"id",textField:"dsc"});if(payTypes==null){window.parent.alertWin("系统提示","paytype is null");return}var NCODPaytypes=$("#NCODPaytypes_hidden").val();if(NCODPaytypes!=null&&NCODPaytypes!=""){var strs=NCODPaytypes.split(",");for(var i=0;i<payTypes.length;i++){for(var j=0;j<strs.length;j++){if(payTypes[i].id==strs[j]){notCodPayType[index]=payTypes[i];index++;continue}}}}$("#tbPaytype_pay").combobox({data:notCodPayType,valueField:"id",textField:"dsc"})}});$("#tbStatus_audit").combobox({data:auditStatuses,valueField:"id",textField:"dsc",onLoadSuccess:function(data){$("#status_audit").combobox({data:data,valueField:"id",textField:"dsc"})}});$("#tbPaytype_result").combobox({data:resultStatusList,valueField:"id",textField:"val"});$.extend($.fn.validatebox.defaults.rules,{validateAccount:{validator:function(value,param){var _val=$("#d_seat").combobox("getValue");if(_val.length<4){return false}else{var valid=false;var datas=$("#d_seat").combobox("getData");if(datas!=null&&datas.length>0){for(var i=0;i<datas.length;i++){if(datas[i].userId==_val){valid=true;break}}}if(valid==false){return false}}return true},message:"请输入有效坐席工号"}});$("#d_dept").combobox({url:"/common/getAllDept",valueField:"id",textField:"name",onSelect:function(param){var url="/common/getGroupByDept?deptId="+param.id;$("#d_group").combobox("clear").combobox("reload",url)}});$("#d_group").combobox({url:"/common/getAllGroup",valueField:"id",textField:"name",onSelect:function(param){var url="/common/getSeatByGroup?groupId="+param.id;$("#d_seat").combobox("clear").combobox("reload",url)}});$("#d_seat").combobox({valueField:"userId",textField:"displayName",keyHandler:{query:function(q){if(q.length>=4){$.get("/common/getUserByUid?uid="+q,function(result){$("#d_seat").combobox("loadData",result);$("#d_seat").combobox("setValue",q)})}else{$("#d_seat").combobox("loadData",null);$("#d_seat").combobox("setValue",q)}}},onSelect:function(record){$("#d_dept").combobox("setValue",record.department);$("#d_group").combobox("setValue",record.defGrp)}});var orderlistInit=false;$("#myOrderlist").datagrid({title:"",iconCls:"icon-edit",width:"100%",height:410,url:"/myorder/myorder/query",striped:true,border:true,collapsible:true,scrollbarSize:-1,rowStyler:function(index,row){var rowStyle="";switch(row.status){case"0":case"10":rowStyle="background-color:#cecece;text-decoration: line-through;";break;case"8":rowStyle="background-color:#A2BADD;text-decoration: line-through;";break;case"1":rowStyle="background-color:#FFC0C0";break;case"5":rowStyle="background-color:#C0FFC0";break;default:rowStyle="";break}return rowStyle},columns:[[{field:"id",title:"ID",width:0,editor:"text",hidden:true},{field:"ck",width:20,checkbox:true},{field:"orderid",title:"订单编号",align:"center",width:80,editor:"text",formatter:function(value,row,index){var canedit=0;if(row.right.indexOf("MODIFY")!=-1||row.right.indexOf("ALL")!=-1){canedit=1}var token='<a class="link" href="javascript:void(0);" onclick="javascript:viewOrder(\'myOrderlist\','+index+","+row.orderid+","+canedit+')" > ';token+=value;token+="</a>";return token}},{field:"crdt",title:"订单生成时间",width:140,editor:"text"},{field:"status",title:"订单状态",align:"center",width:80,editor:"text",formatter:function(value){for(var i=0;i<orderStatuses.length;i++){if(orderStatuses[i].id==value||(!value&&orderStatuses[i].id=="0")){return orderStatuses[i].dsc}}return value}},{field:"totalprice",title:"订单金额",width:80,align:"right",editor:"text",formatter:function(value){return formatPrice(value)}},{field:"crusr",title:"座席工号",align:"center",width:80,editor:"text"},{field:"contactid",title:"客户编号",width:80,editor:"text"},{field:"contactname",title:"客户名称",align:"center",width:80,editor:"text"},{field:"paytype",title:"支付方式",width:80,editor:"text",formatter:function(value){for(var i=0;i<payTypes.length;i++){if(payTypes[i].id==value||(!value&&payTypes[i].id=="0")){return payTypes[i].dsc}}return value}},{field:"rfoutdat",title:"出库时间",width:120,editor:"text",align:"center"},{field:"mailid",title:"包裹单号",width:80,editor:"text",align:"center"},{field:"assignUser",title:"跟单分配人",width:80,align:"center"},{field:"assignTime",title:"分配时间",width:120,align:"center"},{field:"trackUsr",title:"跟单人",width:120,align:"center"},{field:"right",title:"操作",align:"center",width:120,formatter:function(val,row,index){var _buttonWrap=$("<div></div>");var _cancelButton=$('<a href="javascript:void(0);" title="取消订单" class="del mr10"></a>');var _modifyButton=$('<a href="javascript:void(0);" title="修改" class="modify mr10"></a>');var _consultButton=$('<a href="javascript:void(0);"  title="转咨询" class="cancel mr10"></a>');var _noteButton=$('<a href="javascript:void(0);" title="跟单备注" class="addnote"></a>');var _deliveryButton=$('<a href="javascript:void(0);" title="催送货"  class="deliveryBtn mr10" ></a>');var _cancelonclick=function(){cancelOrder("myOrderlist"+index,row.orderid,row.contactid)};var _modifyonclick=function(){modifyOrder("myOrderlist"+index,row.orderid)};var _consultonclick=function(){consultOrder("myOrderlist"+index,row.orderid,row.contactid)};var _noteonclick=function(){noteOrder("myOrderlist"+index,row.orderid)};var _deliveryonclick=function(){showReminder(row.orderid)};if(val.indexOf("ALL")!=-1){_buttonWrap.append(_cancelButton).append(_modifyButton).append(_consultButton).append(_deliveryButton).append(_noteButton)}else{if(val.indexOf("MODIFY")!=-1){_modifyButton.removeClass("modify_dis").addClass("modify");_modifyButton.attr("onclick","modifyOrder('myOrderlist',"+index+","+row.orderid+")");_buttonWrap.append(_modifyButton)}else{_modifyButton.removeClass("modify").addClass("modify_dis");_modifyButton.removeAttr("onclick")}if(val.indexOf("DELETE")!=-1){_cancelButton.removeClass("del_dis").addClass("del");_cancelButton.attr("onclick","cancelOrder('myOrderlist',"+index+","+row.orderid+","+row.contactid+")");_buttonWrap.append(_cancelButton)}else{_cancelButton.removeClass("del").addClass("del_dis");_cancelButton.removeAttr("onclick");_buttonWrap.append(_cancelButton)}if(val.indexOf("CONSULT")!=-1){_consultButton.removeClass("cancel_dis").addClass("cancel");_consultButton.attr("onclick","consultOrder('myOrderlist',"+index+","+row.orderid+","+row.contactid+")");_buttonWrap.append(_consultButton)}else{_consultButton.removeClass("cancel").addClass("cancel_dis");_consultButton.removeAttr("onclick");_buttonWrap.append(_consultButton)}}if(eval(row.couldReApply)){_deliveryButton.removeClass("deliveryBtn_dis").addClass("deliveryBtn");_deliveryButton.attr("onclick","showReminder("+row.orderid+")");_buttonWrap.append(_deliveryButton)}else{_deliveryButton.removeClass("deliveryBtn").addClass("deliveryBtn_dis");_deliveryButton.removeAttr("onclick");_buttonWrap.append(_deliveryButton)}_noteButton.attr("onclick","noteOrder('myOrderlist',"+index+","+row.orderid+")");_buttonWrap.append(_noteButton);trackUser=row.trackUsr;if(null!=trackUser&&""!=trackUser&&trackUser!=currentUsrId){_cancelButton.removeClass("del").addClass("del_dis");_modifyButton.removeClass("modify").addClass("modify_dis");_consultButton.removeClass("cancel").addClass("cancel_dis");_deliveryButton.removeClass("deliveryBtn").addClass("deliveryBtn_dis");_noteButton.removeClass("addnote").addClass("addnote_dis");_cancelButton.removeAttr("onclick");_modifyButton.removeAttr("onclick");_consultButton.removeAttr("onclick");_noteButton.removeAttr("onclick");_deliveryButton.removeAttr("onclick");_buttonWrap.append(_noteButton)}return _buttonWrap.html()}},{field:"trackRemark",title:"跟单备注",editor:"text",formatter:function(value,row){if(value!=null){var token='<a class="link" href="javascript:void(0);" onclick="javascript:viewTrack('+row.orderid+')" > ';token+=value;token+="</a>";return token}else{return value}}}]],remoteSort:false,singleSelect:false,checkOnSelect:true,selectOnCheck:true,pagination:true,queryParams:parmMyOrder,onBeforeLoad:function(data){if(data==null||data.xxx!=null){return false}},onLoadSuccess:function(data){if(data.err!=null){window.parent.alertWin("系统提示",data.err)}if(data.total!=null){totalOrderCount=data.total}$(".disable-linkbutton").linkbutton({disable:"true",plain:true});$(".enable-linkbutton").linkbutton({color:"blue",plain:true})},onLoadError:function(){window.parent.alertWin("系统提示","加载失败!")},onUncheck:function(index,data){$(this).datagrid("clearSelections")}});var p=$("#myOrderlist").datagrid("getPager");$(p).pagination({pageSize:10,pageList:[5,10,15],beforePageText:"",afterPageText:"页    共 {pages}页",displayMsg:"当前 {from} - {to} 记录 共 {total} 记录"});$("#myOrdersearch").click(function(){if(isManager==true||isQualityInspector==true){if(!$("#tbCrusr").validatebox("isValid")){return}}totalOrderCount=-1;if(bShowCondition==1){parmMyOrder={orderId:getNotEmptyString($("#orderid").val().replace(/^\s+|\s+$/g,"")),provinceId:getNotEmptyString($("#province001").combobox("getValue")),cityId:getNotEmptyString($("#cityId001").combobox("getValue")),countyId:getNotEmptyString($("#countyId001").combobox("getValue")),areaId:getNotEmptyString($("#areaId001").combobox("getValue")),status:getNotEmptyString($("#tbStatus").combobox("getValue")),mailId:getNotEmptyString($("#tbMailid").val().replace(/^\s+|\s+$/g,"")),contactId:getNotEmptyString($("#tbContactid").val().replace(/^\s+|\s+$/g,"")),contactName:getNotEmptyString($("#tbContactname").val().replace(/^\s+|\s+$/g,"")),crUsr:getNotEmptyString($("#tbCrusr").val().replace(/^\s+|\s+$/g,"")),beginCrdt:$("#tbBeginCrdt").datebox("getValue"),endCrdt:$("#tbEndCrdt").datebox("getValue"),getContactName:getNotEmptyString($("#tbGetcontactname").val().replace(/^\s+|\s+$/g,"")),beginOutdt:getNotEmptyString($("#tbBeginOutdt").val().replace(/^\s+|\s+$/g,"")),endOutdt:getNotEmptyString($("#tbEndOutdt").val().replace(/^\s+|\s+$/g,"")),parentOrderId:getNotEmptyString($("#tbParentid").val().replace(/^\s+|\s+$/g,"")),getContactPhone:getNotEmptyString($("#tbPhone").val().replace(/^\s+|\s+$/g,"")),payType:getNotEmptyString($("#tbPaytype").combobox("getValue")),prodId:getNotEmptyString($("#tbProdname").val().replace(/^\s+|\s+$/g,"")),checkResult:getNotEmptyString($("#tbCheckResult").combobox("getValue")),countRows:totalOrderCount}}else{parmMyOrder={orderId:getNotEmptyString($("#orderid").val().replace(/^\s+|\s+$/g,"")),status:getNotEmptyString($("#tbStatus").combobox("getValue")),mailId:getNotEmptyString($("#tbMailid").val().replace(/^\s+|\s+$/g,"")),contactId:getNotEmptyString($("#tbContactid").val().replace(/^\s+|\s+$/g,"")),contactName:getNotEmptyString($("#tbContactname").val().replace(/^\s+|\s+$/g,"")),crUsr:getNotEmptyString($("#tbCrusr").val().replace(/^\s+|\s+$/g,"")),beginCrdt:$("#tbBeginCrdt").datebox("getValue"),endCrdt:$("#tbEndCrdt").datebox("getValue"),checkResult:getNotEmptyString($("#tbCheckResult").combobox("getValue")),countRows:totalOrderCount}}if(orderlistInit==false){$("#myOrderlist").datagrid({url:"/myorder/myorder/query"});orderlistInit=true}$("#myOrderlist").datagrid("load",parmMyOrder);if(isManager){var _orderStatus=$("#tbStatus").combobox("getValue");var _agentId=getNotEmptyString($("#tbCrusr").val());if(("1"==_orderStatus||"2"==_orderStatus||"7"==_orderStatus)&&null!=_agentId){$("#myOrderallot").show();$("#d_dept").combobox({url:"/common/getAllDept",valueField:"id",textField:"name",onSelect:function(param){var url="/common/getGroupByDept?deptId="+param.id;$("#d_group").combobox("clear").combobox("reload",url)}})}else{$("#myOrderallot").hide()}}});$("#myOrderreset").click(function(){var currentUsrId=$("#tbCrusr").val();$("#myOrderForm").form("clear");$("#tbCrusr").val(currentUsrId);$("#tbCheckResult").combobox("enable")});$("#myOrderallot").click(function(){var checkedRows=$("#myOrderlist").datagrid("getChecked");if(checkedRows.length>0){$("#op_list").window("open")}else{window.parent.alertWin("错误","请选择要分配的订单")}});$("#myOrderreset_pay").click(function(){var currentUsrId=$("#tbCrusr_pay").val();$("#myOrderForm_pay").form("clear");$("#tbCrusr_pay").val(currentUsrId)});$("#myOrderreset_audit").click(function(){var currentUsrId=$("#tbCrusr_audit").val();$("#myOrderForm_audit").form("clear");$("#tbCrusr_audit").val(currentUsrId)});$("#orderCancel_confirm").click(function(){var orderId=$("#txtOrderId").val();var remark=$("#txtRemark").val();$.ajax({url:"/myorder/myorder/cancel",contentType:"application/json; charset=utf-8",data:{orderId:orderId,remark:encodeURI(remark)},success:function(data){if(data!=null){var contactId=null;if(data.succ!=null&&data.succ=="1"){$("#dlgCancel").dialog("close");if(data.audit!=null&&data.audit=="0"){var rowIndex=$("#orderCancel_index_hidden").val();contactId=$("#orderCancel_contact_hidden").val();$("#myOrderlist").datagrid("reload",parmMyOrder);$("#myOrderlist_audit").datagrid("reload",parmMyOrderAudit)}}window.parent.alertWin("系统提示",data.msg);if(contactId!=null){window.parent.subContactCallback(contactId,"refreshOrderHistory")}}else{$("#dlgCancel").dialog("close")}}})});$("#orderCancel_cancel").click(function(){$("#dlgCancel").window("close")});var paylistInit=false;$("#myOrderlist_pay").datagrid({width:"100%",height:390,fitColumns:true,columns:[[{field:"id",title:"ID",width:0,editor:"text",hidden:true},{field:"orderid",title:"订单编号",align:"center",width:80,editor:"text",formatter:function(value,row,index){var canedit=0;if(row.right.indexOf("MODIFY")!=-1||row.right.indexOf("ALL")!=-1){canedit=1}var token='<a class="link" href="javascript:void(0);" onclick="javascript:viewOrder(\'myOrderlist_pay\','+index+","+row.orderid+","+canedit+')" > ';token+=value;token+="</a>";return token}},{field:"crdt",title:"订单生成时间",width:140,editor:"text"},{field:"status",title:"订单状态",align:"center",width:80,editor:"text",formatter:function(value){for(var i=0;i<orderStatuses.length;i++){if(orderStatuses[i].id==value||(!value&&orderStatuses[i].id=="0")){return orderStatuses[i].dsc}}return value}},{field:"totalprice",title:"订单金额",width:80,align:"right",editor:"text",formatter:function(value){return formatPrice(value)}},{field:"crusr",title:"座席工号",align:"center",width:80,editor:"text"},{field:"contactid",title:"客户编号",align:"center",width:80,editor:"text"},{field:"contactname",title:"客户名称",align:"center",width:80,editor:"text"},{field:"paytype",title:"支付方式",align:"center",width:80,editor:"text",formatter:function(value){for(var i=0;i<payTypes.length;i++){if(payTypes[i].id==value||(!value&&payTypes[i].id=="0")){return payTypes[i].dsc}}return value}},{field:"cardtype",title:"卡类型",align:"center",width:80,editor:"text"},{field:"confirm",title:"支付结果",align:"center",width:80,editor:"text",formatter:function(value){if(value=="-1"){return resultStatusList[1].val}else{return resultStatusList[0].val}}},{field:"right",title:"操作",align:"center",width:80,editor:"text",formatter:function(val,row,index){var cancelEnableToken='<a href="javascript:void(0);" onclick="javascript:cancelOrder(\'myOrderlist_pay\','+index+","+row.orderid+","+row.contactid+')" title="取消订单" class="del"></a>';var cancelDisableToken='<a href="javascript:void(0);"  class="del_dis" disabled="true" title="取消订单"></a>';var modifyEnableToken='<a href="javascript:void(0);" onclick="javascript:modifyOrder(\'myOrderlist_pay\','+index+","+row.orderid+')" class="modify mr10" title="修改"></a>';var modifyDisableToken='<a href="javascript:void(0);"  class="modify_dis mr10" disabled="true"  title="修改"></a>';var claimEnableToken='<a href="javascript:void(0);" onclick="javascript:claimOrder(\'myOrderlist_pay\','+index+","+row.orderid+')" class="cr_card mr10" title="索权"></a>';var claimDisableToken='<a href="javascript:void(0);"  class="cr_card_dis mr10" disabled="true"  title="索权"></a>';var tableToken="";if(val.indexOf("ALL")!=-1){tableToken+=modifyEnableToken;if(isClaimEnable(row.bankName)){tableToken+=claimEnableToken}else{tableToken+=claimDisableToken}tableToken+=cancelEnableToken}else{if(val.indexOf("MODIFY")!=-1){tableToken+=modifyEnableToken;if(row.confirm!="-1"&&isClaimEnable(row.bankName)){tableToken+=claimEnableToken}else{tableToken+=claimDisableToken}}else{tableToken+=modifyDisableToken;tableToken+=claimDisableToken}if(val.indexOf("DELETE")!=-1){tableToken+=cancelEnableToken}else{tableToken+=cancelDisableToken}}tableToken+="";return tableToken}}]],remoteSort:false,singleSelect:true,checkOnSelect:true,selectOnCheck:true,pagination:true,queryParams:parmMyOrderPay,onBeforeLoad:function(data){if(data==null||data.xxx!=null){return false}},onLoadSuccess:function(data){if(data.err!=null){window.parent.alertWin("系统提示",data.err)}if(data.total!=null){totalOrderPayCount=data.total}$(".disable-linkbutton2").linkbutton({disable:"true",plain:true});$(".enable-linkbutton2").linkbutton({color:"blue",plain:true})},onLoadError:function(){window.parent.alertWin("系统提示","加载失败!")},onUncheck:function(index,data){$(this).datagrid("clearSelections")}});var pPay=$("#myOrderlist_pay").datagrid("getPager");$(pPay).pagination({pageSize:10,pageList:[5,10,15],beforePageText:"",afterPageText:"页    共 {pages}页",displayMsg:"当前 {from} - {to} 记录 共 {total} 记录"});$("#myOrdersearch_pay").click(function(){if(isManager==true){if(!$("#tbCrusr_pay").validatebox("isValid")){return}}totalOrderPayCount=-1;parmMyOrderPay={orderId:getNotEmptyString($("#orderid_pay").val().replace(/^\s+|\s+$/g,"")),provinceId:getNotEmptyString($("#province002").combobox("getValue")),cityId:getNotEmptyString($("#cityId002").combobox("getValue")),countyId:getNotEmptyString($("#countyId002").combobox("getValue")),areaId:getNotEmptyString($("#areaId002").combobox("getValue")),contactId:getNotEmptyString($("#tbContactid_pay").val().replace(/^\s+|\s+$/g,"")),contactName:getNotEmptyString($("#tbContactname_pay").val().replace(/^\s+|\s+$/g,"")),crUsr:getNotEmptyString($("#tbCrusr_pay").val().replace(/^\s+|\s+$/g,"")),beginCrdt:$("#tbBeginCrdt_pay").datebox("getValue"),endCrdt:$("#tbEndCrdt_pay").datebox("getValue"),getContactName:getNotEmptyString($("#tbGetcontactname_pay").val().replace(/^\s+|\s+$/g,"")),getContactPhone:getNotEmptyString($("#tbPhone_pay").val().replace(/^\s+|\s+$/g,"")),payType:getNotEmptyString($("#tbPaytype_pay").combobox("getValue")),prodId:getNotEmptyString($("#tbProdname_pay").val().replace(/^\s+|\s+$/g,"")),confirm:getNotEmptyString($("#tbPaytype_result").combobox("getValue")),countRows:totalOrderPayCount};if(paylistInit==false){$("#myOrderlist_pay").datagrid({url:"/myorder/myorder/query_pay"});paylistInit=true}$("#myOrderlist_pay").datagrid("load",parmMyOrderPay)});var auditlistInit=false;$("#myOrderlist_audit").datagrid({width:"100%",height:410,fitColumns:true,columns:[[{field:"batchid",title:"工作流批号",width:80,editor:"text",formatter:function(value,row,index){var token='<a class="link" href=# onclick="javascript:confirmAudit('+index+","+row.orderid+","+row.batchid+",'"+row.audittype+"',0)\" > ";token+=value;token+="</a>";return token}},{field:"orderid",title:"订单编号",width:80,editor:"text"},{field:"crdt",title:"订单生成时间",width:80,editor:"text"},{field:"status",title:"订单状态",width:80,editor:"text",formatter:function(value){for(var i=0;i<orderStatuses.length;i++){if(orderStatuses[i].id==value||(!value&&orderStatuses[i].id=="0")){return orderStatuses[i].dsc}}return value}},{field:"totalprice",title:"订单金额",width:80,align:"right",editor:"text",formatter:function(value){return formatPrice(value)}},{field:"crusr",title:"座席工号",width:80,editor:"text"},{field:"contactid",title:"客户编号",width:80,editor:"text"},{field:"contactname",title:"客户名称",width:80,editor:"text"},{field:"paytype",title:"支付方式",width:80,editor:"text",formatter:function(value){for(var i=0;i<payTypes.length;i++){if(payTypes[i].id==value||(!value&&payTypes[i].id=="0")){return payTypes[i].dsc}}return value}},{field:"auditdt",title:"提交时间",width:80,editor:"text"},{field:"audittype",title:"审核类型",width:80,editor:"text"},{field:"auditstatus",title:"工作流状态",width:80,editor:"text",formatter:function(value){for(var i=0;i<auditStatuses.length;i++){if(auditStatuses[i].id==value||(!value&&auditStatuses[i].id=="0")){return auditStatuses[i].dsc}}return value}},{field:"right",title:"处理",width:80,editor:"text",align:"center",formatter:function(val,row,index){var cancelEnableToken='<a href="javascript:void(0);" onclick="javascript:cancelAudit('+index+","+row.orderid+","+row.batchid+')" class="del"></a>';var confirmEnableToken='<a href="javascript:void(0);" onclick="javascript:confirmAudit('+index+","+row.orderid+","+row.batchid+",'"+row.audittype+'\',1)" class="link easyui-linkbutton">确认</a>';var tableToken="";if(val.indexOf("ALL")!=-1){tableToken+=cancelEnableToken;if(row.audittype!="新增订单"&&row.audittype!="新增客户"&&row.audittype!="取消订单"){tableToken+=confirmEnableToken}}else{if(val.indexOf("DELETE")!=-1){tableToken+=cancelEnableToken}if(val.indexOf("CONFIRM")!=-1&&(row.audittype!="新增订单"&&row.audittype!="新增客户"&&row.audittype!="取消订单")){tableToken+=confirmEnableToken}}tableToken+="";return tableToken}}]],remoteSort:false,singleSelect:true,checkOnSelect:true,selectOnCheck:true,pagination:true,queryParams:parmMyOrderAudit,onBeforeLoad:function(data){if(data==null||data.xxx!=null){return false}},onLoadSuccess:function(data){if(data.err!=null){window.parent.alertWin("系统提示",data.err)}if(data.total!=null){totalOrderAuditCount=data.total}},onLoadError:function(){window.parent.alertWin("系统提示","加载失败!")},onUncheck:function(index,data){$(this).datagrid("clearSelections")}});var pAudit=$("#myOrderlist_audit").datagrid("getPager");$(pAudit).pagination({pageSize:10,pageList:[5,10,15],beforePageText:"",afterPageText:"页    共 {pages}页",displayMsg:"当前 {from} - {to} 记录 共 {total} 记录"});$("#myOrdersearch_audit").click(function(){if(isManager==true){if(!$("#tbCrusr_audit").validatebox("isValid")){return}}totalOrderAuditCount=-1;parmMyOrderAudit={orderId:getNotEmptyString($("#orderid_audit").val().replace(/^\s+|\s+$/g,"")),contactId:getNotEmptyString($("#tbContactid_audit").val().replace(/^\s+|\s+$/g,"")),contactName:getNotEmptyString($("#tbContactname_audit").val().replace(/^\s+|\s+$/g,"")),crUsr:getNotEmptyString($("#tbCrusr_audit").val().replace(/^\s+|\s+$/g,"")),beginCrdt:$("#tbBeginCrdt_audit").datebox("getValue"),endCrdt:$("#tbEndCrdt_audit").datebox("getValue"),payType:getNotEmptyString($("#tbPaytype_audit").combobox("getValue")),prodId:getNotEmptyString($("#tbProdname_audit").val().replace(/^\s+|\s+$/g,"")),auditStatus:$("#tbStatus_audit").combobox("getValue"),busiType:busiType,countRows:totalOrderAuditCount};if(auditlistInit==false){$("#myOrderlist_audit").datagrid({url:"/myorder/myorder/query_audit"});auditlistInit=true}$("#myOrderlist_audit").datagrid("load",parmMyOrderAudit)});$("#orderClaim_confirm").click(function(){var orderId=$("#txtClaimOrderId").val();$.ajax({url:"/myorder/myorder/grant/"+orderId,async:false,success:function(data){if(data!=null){window.parent.alertWin("系统提示",data.msg);if(data.st=="succ"){$("#dlgClaim").dialog("close");$("#myOrderlist_pay").datagrid("reload",parmMyOrderPay)}}else{$("#dlgClaim").dialog("close")}$("#myOrderlist_pay").datagrid("reload",parmMyOrderPay)}})});$("#orderClaim_cancel").click(function(){$("#dlgClaim").window("close")});$("#pay_order_address").load("/common/address_no_validation.jsp?instId=002")});function viewOrder(d,c,a,e){var b="myorder/orderDetails/get/"+a+"?activable=false";window.parent.addTab("myorder_"+a,"订单："+a,"false",b)}function modifyOrder(c,b,a){if(isOrderInBmp(a)){return}else{doModifyOrder(a)}}function doModifyOrder(a){if(a==undefined){a=$("#id_audit_order").html();closeOpenAuditWindow()}window.parent.addTab("myorder_"+a,"订单："+a,"false","myorder/orderDetails/get/"+a+"?activable=true")}function isOrderInBmp(b){var a=false;$.ajax({type:"POST",async:false,url:"orderDetails/check/"+b+"/approving",dataType:"json",success:function(c){if(c.approve=="false"){a=true;$("#id_audit_batch").html(c.batchId);$("#id_audit_order").html(b);$("#id_input_bmp_type").val(c.bpmType);$("#div_open_audit").dialog("open")}}});return a}function openAudit(){var b=$("#id_audit_batch").html();var a=$("#id_audit_order").html();var d=$("#id_input_bmp_type").val();var c="task/processAuditTaskAjax?batchId="+b+"&auditTaskType="+d+"&isConfirmAudit=0&id="+a;window.parent.addTab("task_"+b,"我的订单","false",c);closeOpenAuditWindow()}function closeOpenAuditWindow(){$("#div_open_audit").dialog("close");$("#id_audit_batch").html("");$("#id_audit_order").html("");$("#id_input_bmp_type").val("")}function consultOrder(c,b,a,d){var e="订单："+a+" 确定要转咨询吗？";$("#txtOrderId_Consult").val(a);$("#consult_show_text").html(e);$("#orderCancel_contact_hidden").val(d);$("#dlgConsult").dialog({title:"订单转咨询",width:300,top:200,iconCls:"",shadow:true,modal:true,closed:true,minimizable:false,maximizable:false,collapsible:false,draggable:false,buttons:[{text:"确定",plain:true,handler:function(){var f=$("#txtOrderId_Consult").val();$.ajax({url:"/myorder/myorder/consult",contentType:"application/json; charset=utf-8",data:{orderId:f},success:function(g){if(g!=null){var h=null;if(g.succ!=null&&g.succ=="1"){$("#dlgConsult").dialog("close");h=$("#orderCancel_contact_hidden").val();$("#myOrderlist").datagrid("reload",parmMyOrder);$("#myOrderlist_audit").datagrid("reload",parmMyOrderAudit)}window.parent.alertWin("系统提示",g.msg);if(h!=null){window.parent.subContactCallback(h,"refreshOrderHistory")}}else{$("#dlgConsult").dialog("close")}}})}},{text:"取消",plain:true,handler:function(){$("#dlgConsult").dialog("close")}}]}).window("open")}function noteOrder(c,b,a){$("#txtOrderId_Note").val(a);$("#txtAppend_note").val("");$("#dlgNote").dialog({title:"订单跟单备注",width:350,top:200,iconCls:"",shadow:true,modal:true,closed:true,minimizable:false,maximizable:false,collapsible:false,draggable:false,buttons:[{text:"确定",plain:true,handler:function(){var d=$("#txtOrderId_Note").val();var e=$("#txtAppend_note").val();$.ajax({url:"/myorder/myorder/note",contentType:"application/json; charset=utf-8",data:{orderId:d,newNote:e},success:function(f){if(f!=null){if(f.succ!=null&&f.succ=="1"){$("#dlgNote").dialog("close");$("#myOrderlist").datagrid("reload",parmMyOrder)}else{window.parent.alertWin("系统提示",f.msg)}}else{$("#dlgConsult").dialog("close")}}})}},{text:"取消",plain:true,handler:function(){$("#dlgNote").dialog("close")}}]}).window("open")}function claimOrder(c,b,a){var d=true;$.ajax({url:"/myorder/myorder/grantCheck/"+a,async:false,success:function(e){if(e!=null){if(e.result=="1"){d=false;window.parent.alertWin("系统提示","订单正在审批中，请稍后索权。");return}}}});if(d==false){return}$("#txtClaimOrderId").val(a);$("#dlgClaim").window({title:"订单在线索权",width:400,height:140,top:200,iconCls:"",shadow:true,modal:true,closed:true,minimizable:false,maximizable:false,collapsible:false,draggable:false}).window("open")}function cancelOrder(c,b,a,d){$("#txtOrderId").val(a);$("#txtRemark").val(null);$("#orderCancel_contact_hidden").val(d);$("#dlgCancel").dialog({title:"取消订单",width:400,top:200,iconCls:"",shadow:true,modal:true,closed:true,minimizable:false,maximizable:false,collapsible:false,draggable:false,buttons:[{text:"确定",plain:true,handler:function(){var e=$("#txtOrderId").val();var f=$("#txtRemark").val();$.ajax({url:"/myorder/myorder/cancel",contentType:"application/json; charset=utf-8",data:{orderId:e,remark:encodeURI(f)},success:function(g){if(g!=null){var h=null;if(g.succ!=null&&g.succ=="1"){$("#dlgCancel").dialog("close");if(g.audit!=null&&g.audit=="0"){var i=$("#orderCancel_index_hidden").val();h=$("#orderCancel_contact_hidden").val();$("#myOrderlist").datagrid("reload",parmMyOrder);$("#myOrderlist_audit").datagrid("reload",parmMyOrderAudit)}}window.parent.alertWin("系统提示",g.msg);if(h!=null){window.parent.subContactCallback(h,"refreshOrderHistory")}}else{$("#dlgCancel").dialog("close")}}})}},{text:"取消",plain:true,handler:function(){$("#dlgCancel").window("close")}}]}).window("open")}function cancelAudit(c,b,a){$("#txtAuditBatchId").val(a);$("#txtAuditRemark").val(null);$("#dlgAuditCancel").dialog({title:"取消审批",width:350,iconCls:"",top:200,shadow:true,modal:true,closed:true,minimizable:false,maximizable:false,collapsible:false,draggable:false,buttons:[{text:"确定",plain:true,handler:function(){var d=$("#txtAuditBatchId").val();var e=$("#txtAuditRemark").val();$.ajax({url:"/myorder/myorder/cancel_audit",contentType:"application/json; charset=utf-8",data:{batchId:d,remark:encodeURI(e)},success:function(h){if(h!=null){var g=h.substr(1);var f=h.substr(0,1);window.parent.alertWin("系统提示",g);if(f=="1"){$("#dlgAuditCancel").dialog("close");$("#myOrderlist_audit").datagrid("reload",parmMyOrderAudit)}}else{$("#dlgAuditCancel").dialog("close")}}})}},{text:"取消",plain:true,handler:function(){$("#dlgAuditCancel").dialog("close")}}]}).window("open")}function confirmAudit(d,b,a,c,e){window.parent.addTab("task_"+a,"我的订单","false","task/processAuditTaskAjax?batchId="+a+"&auditTaskType="+c+"&isConfirmAudit="+e+"&id="+b)}function timeFormatter(a){return a.getFullYear()+"-"+(a.getMonth()+1)+"-"+a.getDate()}function timeParser(a){return new Date(Date.parse(a.replace(/-/g,"/")))}var b_order_address_init=false;function showMoreCondition(a){if(a==0){$("#morConditons1").css({display:"none"});$("#morConditons2").css({display:"none"});$("#morConditons3").css({display:"none"});$("#morConditons4").css({display:"none"});$(".u").removeClass("underline")}else{if(b_order_address_init==false){$("#order_address").load("/common/address_no_validation.jsp?instId=001",function(){b_order_address_init=true;$("#morConditons1").css({display:""});$("#morConditons2").css({display:""});$("#morConditons3").css({display:""});$("#morConditons4").css({display:""});$(".u").addClass("underline")})}else{$("#morConditons1").css({display:""});$("#morConditons2").css({display:""});$("#morConditons3").css({display:""});$("#morConditons4").css({display:""});$(".u").addClass("underline")}}setTimeout(function(){window.parent.SetCwinHeight(frameElement)},200)}function formatPrice(a){if(a==null||a==""){return"0.00"}var b=a;return b.toFixed(2)}var bNeedRefresh=false;function refreshOrderHistory(){bNeedRefresh=true}function refreshMyorderlist(){if(bNeedRefresh==true){$("#myOrderlist").datagrid("reload");$("#myOrderlist_audit").datagrid("reload");bNeedRefresh=false}}function justest(a){$("#orderid_pay").val(a.orgSourceType);$("#myorder_tabs").tabs("select",1)}function isClaimEnable(a){if(a==null){return false}var b=a.indexOf("招行");if(b>=0){return true}return false}function checkMember(a){var b=false;$.ajax({type:"post",url:"/myorder/myorder/checkGrpMember",data:"usrId="+a,async:false,dataType:"json",success:function(c){b=c}});return b}function viewTrack(a){showOrderProcess(a,"跟单查询")}function queryFromSysmessage(b){if(b.orgSourceType=="5"||b.orgSourceType=="6"||b.orgSourceType=="11"){$("#myorder_tabs").tabs("select",3);var a=$("#tbBeginCrdt_audit").datebox("getValue");var c=$("#tbEndCrdt_audit").datebox("getValue");$("#myOrderreset_audit").click();$("#tbCrusr_audit").val(b.receiverId);$("#tbStatus_audit").combobox("setValue","2");if(b.orgSourceType=="5"){busiType="2"}else{if(b.orgSourceType=="6"){busiType="1"}else{if(b.orgSourceType=="11"){busiType="1"}}}$("#tbBeginCrdt_audit").datebox("setValue",a);$("#tbEndCrdt_audit").datebox("setValue",c);$("#myOrdersearch_audit").click();busiType=null}else{if(b.orgSourceType=="0"){$("#myorder_tabs").tabs("select",2);var a=$("#input_problem_tbBeginCrdt").datebox("getValue");var c=$("#input_problem_tbEndCrdt").datebox("getValue");$("#a_myProblemOrderreset").click();$("#input_problem_tbBeginOutdt").datebox("setValue","");$("#input_problem_tbEndOutdt").datebox("setValue","");$("#input_problem_tbBeginCrdt").datebox("setValue",a);$("#input_problem_tbEndCrdt").datebox("setValue",c);$("#input_problem_tbCrusr").val(b.receiverId);$("#a_myProblemOrdersearch").click()}else{if(b.orgSourceType=="1"){$("#myorder_tabs").tabs("select",4);$("#clearReminder").click();$("#r_beginCrDate").datebox("setValue",new Date(new Date()-90*86400000).format("yyyy-MM-dd"));$("#r_endCrDate").datebox("setValue",new Date().format("yyyy-MM-dd"));$("#agentId").val(b.receiverId);$("#r_status").combobox("setValue","1");$("#queryReminder").click()}}}}function followOrder(){if(!$("#d_seat").combobox("isValid")){return}var trackUser=$("#d_seat").combobox("getValue");var checkedRows=$("#myOrderlist").datagrid("getChecked");if(null==trackUser||""==trackUser||checkedRows.length==0){window.parent.alertWin("错误","请选择要分配的坐席");return false}var orderIds="";for(var i=0;i<checkedRows.length;i++){orderIds+=checkedRows[i].orderid;if(i!=(checkedRows.length-1)){orderIds+=","}}var ownerUser=$("#tbCrusr").val();$.ajax({type:"POST",url:"/myorder/myorder/assignToAgent",data:{orderIds:orderIds,trackUser:trackUser,ownerUser:ownerUser},success:function(rs){if(eval(rs.success)){closeFollowWin();$("#myOrdersearch").trigger("click");window.parent.alertWin("提示","共分配 ["+rs.totalCount+"] 条跟单任务到坐席 ["+trackUser+"] ")}else{window.parent.alertWin("提示","分配跟单任务失败:<br>"+rs.message);console.error("分配跟单任务失败: "+rs.message)}},error:function(msg){window.parent.alertWin("提示","分配跟单任务失败")}})}function closeFollowWin(){$("#op_list").window("close");$("#d_dept").combobox("setValue",null);$("#d_group").combobox("setValue",null);$("#d_seat").combobox("setValue",null)}function getNotEmptyString(a){if(a==null||a==""){return null}else{return a}};