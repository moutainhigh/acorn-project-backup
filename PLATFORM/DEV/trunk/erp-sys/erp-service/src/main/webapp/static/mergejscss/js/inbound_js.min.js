function _handler(){$("#inboundtabs,#contactTab,#cart_tabs").tabs("resize",{width:"100%"});$("#phoneTable,#addressTable,#cardTable,#orderHistory").datagrid("resize",{width:"100%"});var b=$("#inboundtabs").tabs("getSelected");var a=$("#inboundtabs").tabs("getTabIndex",b);if(a==3){$("#id_cases").datagrid("resize",{width:"100%"})}else{if(a==4){$("#lead_interation_history,#message_history").datagrid("resize",{width:"100%"})}}}function compare(){var a={title:"修改确认"};window.parent.popWin(frameElement.id,"compare",a)}$(document).ready(function(){$.extend($.fn.datagrid.methods,{doRowTip:function(jq,params){function showTip(data,tr,e,colName,func){var selFilter=">td[field='"+colName+"']";var offset=$(tr).offset();var rowIndex=$(tr).attr("datagrid-row-index");console.debug(rowIndex);if(rowIndex!=null&&data.data!=null&&data.data.rows!=null){var colData=data.data.rows[rowIndex][colName];if(colData!=null){if(func!=null){var name=func(colData);data.tooltip.html(name).css({top:(offset.top+10)+"px",left:(offset.left+20)+"px","max-width":"2000px","z-index":$.fn.window.defaults.zIndex,display:"block"})}else{data.tooltip.text(colData).css({top:(offset.top+10)+"px",left:(offset.left+20)+"px","max-width":"2000px","z-index":$.fn.window.defaults.zIndex,display:"block"})}}}}return jq.each(function(){var grid=$(this);var options=$(this).data("datagrid");if(!options.tooltip){var panel=grid.datagrid("getPanel").panel("panel");var defaultCls={border:"none",padding:"5px",color:"#333",position:"absolute","border-radius":"4px","-moz-border-radius":"4px","-webkit-border-radius":"4px",display:"none"};var tooltip=$('<div id="celltip" class="goods_info"></div>').appendTo("body");tooltip.css($.extend({},defaultCls,params.cls));options.tooltip=tooltip;panel.find(".datagrid-body").each(function(){var delegateEle=$(this).find("> div.datagrid-body-inner").length?$(this).find("> div.datagrid-body-inner")[0]:this;$(delegateEle).undelegate("tr","mouseover").undelegate("tr","mouseout").undelegate("tr","mousemove").delegate("tr",{mouseover:function(e){if(params.delay){if(options.tipDelayTime){clearTimeout(options.tipDelayTime)}var that=this;options.tipDelayTime=setTimeout(function(){showTip(options,that,e,params.col,params.func)},params.delay)}else{showTip(options,this,e,params.col,params.func)}},mouseout:function(e){if(options.tipDelayTime){clearTimeout(options.tipDelayTime)}options.tooltip.css({display:"none"})},mousemove:function(e){var that=this;if(options.tipDelayTime){clearTimeout(options.tipDelayTime)}options.tipDelayTime=setTimeout(function(){showTip(options,that,e,params.col,params.func)},params.delay)}})})}})},cancelRowTip:function(jq){return jq.each(function(){var data=$(this).data("datagrid");if(data.tooltip){data.tooltip.remove();data.tooltip=null;var panel=$(this).datagrid("getPanel").panel("panel");panel.find(".datagrid-body").undelegate("tr","mouseover").undelegate("tr","mouseout").undelegate("tr","mousemove")}if(data.tipDelayTime){clearTimeout(data.tipDelayTime);data.tipDelayTime=null}})}});$("#inboundtabs").tabs({border:false,onSelect:function(title){if(title=="客户扩展信息"){}if(title=="客户服务历史"){contactCases();initComplainTable()}if(title=="客户联系历史"){contactContactHist()}if(title=="客户购物车"){if($("#customerId").val()){showShoppingCartPage()}else{$("#id_page_shoppingCart").hide();$("#id_page_shoppingCart_message").show()}}window.parent.SetCwinHeight(frameElement)}});if($("#page_refresh").val()){$("#inboundtabs").tabs("select",parseInt($("#page_refresh").val()))}if($("#customerId").val()==""){$("#token").hide()}else{if($("#customerType").val()=="2"){$("#addCoustomerInfoBut").hide();$("#clearCoustomerInfoBut").hide()}}if($("#customerType").val()=="1"){$("#clearCoustomerInfoBut").hide()}$("#addCoustomerBut").bind("click",function(){addCoustomer()});$("#addCoustomerInfoBut").click(function(){var addressRows=$("#addressTable").datagrid("getRows");if($("#customerId").val()==""){addCoustomerInfo()}else{if($("#customerType").val()=="2"&&addressRows==""){submitEditNameAndSex()}else{if($("#customerType").val()=="2"&&addressRows!=""){addAddressToUpgrade()}else{compareNameAndSex()}}}});$("#clearCoustomerInfoBut").bind("click",function(){clearCoustomerInfo()});$("#displayCoustomerPhoneBut").bind("click",function(){displayCoustomerPhone()});$("#phonetypid").bind("click",function(){changefPhone()});$("#addCoustomerPhoneBut").bind("click",function(){addCoustomerPhone()});$("#cancleCoustomerPhoneBut").bind("click",function(){cancleCoustomerPhone()});$("#displayCoustomerAddressBut").bind("click",function(){displayCoustomerAddress()});$("#addCardIcon").bind("click",function(){$("#addCardTable").show()});$("#addCoustomerAddressBut").bind("click",function(){$(this).attr("disabled",true);if($("#addressRowIndex").val()!=""&&$("#addressId").val()!=""){addCoustomerAddress()}else{if($("#addressRowIndex").val()==""&&$("#addressId").val()==""){addCoustomerAddress()}else{saveEditAddress()}}});$("#saveEditCard").bind("click",function(){if($("#addCardId").val()!=""){saveEditCard()}});$("#cancelEditCard").bind("click",function(){cancelEditCard()});$("#cancleCoustomerAddressBut").bind("click",function(){cancleCoustomerAddress()});$("#addCoustomerExtBut").bind("click",function(){addCoustomerExt()});$("#cancleCoustomerExtBut").bind("click",function(){if($("#customerType").val()=="1"){$.get("/contact/getContactInfo/"+$("#customerId").val(),function(data){$("#birthday").datebox("setValue",data.customer.birthdayStr);$("#marriage").combobox("setValue",data.customer.marriage);$("#income").combobox("setValue",data.customer.income);$("#occupationStatus").combobox("setValue",data.customer.occupationStatus);$("#education").combobox("setValue",data.customer.education);if(data.customer.car=="-1"){$("#isCar").attr("checked",true)}else{$("#isCar").attr("checked",false)}if(data.customer.car!="-1"){$("#carmoney2").attr("disabled",true)}else{$("#carmoney2").attr("disabled",false)}$("#carmoney2").val(data.customer.carmoney2);if(data.customer.children=="-1"){$("#isChild").attr("checked",true)}else{$("#isChild").attr("checked",false)}if(data.customer.children!="-1"){$("#childrenage").datebox({disabled:true})}else{$("#childrenage").datebox({disabled:false})}$("#childrenage").datebox("setValue",data.customer.childrenageStr);if(data.customer.hasElder=="-1"){$("#isParent").attr("checked",true)}else{$("#isParent").attr("checked",false)}if(data.customer.hasElder!="-1"){$("#elderBirthday").datebox({disabled:true})}else{$("#elderBirthday").datebox({disabled:false})}$("#elderBirthday").datebox("setValue",data.customer.elderBirthdayStr)})}});$("#phoneTable").datagrid({title:"",method:"get",width:"100%",height:120,nowrap:false,striped:true,border:true,collapsible:false,fitColumns:true,singleSelect:true,scrollbarSize:-1,onBeforeLoad:function(){if($("#customerId").val()==null||$("#customerId").val()==""){return false}},onLoadSuccess:function(){if($("#customerState").val()==""||$("#customerState").val()=="2"){displayCoustomerPhone()}},url:"/contact/phoneList/"+$("#customerType").val()+"/"+$("#customerId").val(),columns:[[{field:"state",width:30,align:"center",title:"审核",formatter:function(value){if(value==0){return'<span class="exaa">待审核</span>'}if(value==1){return'<span class="exaa">审核中</span>'}if(value==3){return'<span class="exa">未通过</span>'}else{return""}}},{field:"phn2",title:"客户电话",width:100,align:"center",formatter:function(value,rowData,rowIndex){if($("#customerState").val()=="0"||$("#customerState").val()=="1"||$("#customerState").val()=="3"||rowData.state=="0"||rowData.state=="1"||rowData.state=="3"){if(rowData.phonetypid&&rowData.phonetypid!=4){var phone="";phone+=(rowData.phn1?rowData.phn1+"-":"");phone+=value;phone+=(rowData.phn3?"-"+rowData.phn3:"");phone+=rowData.belongAddress;phone+=' <a class="customerQuery s_btn" href="javascript:void(0);" onclick="findByPhone('+rowIndex+')"></a>';return phone}else{return value+rowData.belongAddress+' <a class="customerQuery s_btn" href="javascript:void(0);" onclick="findByPhone('+rowIndex+')"></a>'}}if(rowData.phonetypid&&rowData.phonetypid!=4){var phone="";phone+=(rowData.phn1?rowData.phn1+"-":"");phone+=value;phone+=(rowData.phn3?"-"+rowData.phn3:"");phone+=rowData.belongAddress;return'<span class="tel"><a class="phoneTablePhn2_'+rowIndex+' link pl5 pr5" style="margin:0 5px" href="javascript:void(0);" onclick="showOutPhoneType('+rowIndex+')">'+phone+'</a> <a class="customerQuery s_btn" href="javascript:void(0);" onclick="findByPhone('+rowIndex+')"></a></span>'}else{return'<span class="tel"><a class="phoneTablePhn2_'+rowIndex+' link pl5 pr5" style="margin:0 5px" href="javascript:void(0);" onclick="showOutPhoneType('+rowIndex+')">'+value+rowData.belongAddress+'</a><a class="customerQuery s_btn" href="javascript:void(0);" onclick="findByPhone('+rowIndex+')"></a></span>'}}},{field:"lastCallDateStr",title:"最近接通时间",width:100},{field:"callCount",title:"接通次数",width:40,align:"center"},{field:"prmphn",title:"默认",width:30,align:"center",formatter:function(value,rowData,rowIndex){if($("#customerState").val()=="0"||$("#customerState").val()=="1"||$("#customerState").val()=="3"||rowData.state=="0"||rowData.state=="1"||rowData.state=="3"){return rowData.prmphn=="Y"?'<input type="checkbox" checked disabled/>':'<input type="checkbox" disabled/>'}return value=="Y"?'<input type="checkbox" checked disabled />':'<input type="checkbox" onclick="setPrimePhone('+rowIndex+')" />'}},{field:"backupPhn",title:"备选",width:30,align:"center",formatter:function(value,rowData,rowIndex){if($("#customerState").val()=="0"||$("#customerState").val()=="1"||$("#customerState").val()=="3"||rowData.state=="0"||rowData.state=="1"||rowData.state=="3"){return rowData.prmphn=="B"?'<input type="checkbox" checked disabled/>':'<input type="checkbox" disabled/>'}return rowData.prmphn=="B"?'<input type="checkbox" onclick="editBackupPhone('+rowIndex+',this)" checked />':'<input type="checkbox" onclick="editBackupPhone('+rowIndex+',this)" />'}},{field:"phoneOperate",title:"操作",align:"center",width:100,hidden:true,formatter:function(value,rowData,rowIndex){return'<a class="modify" title="修改" href="javascript:void(0);" onclick="editPhone('+rowIndex+')"></a>   <a class="del ml10" href="javascript:void(0);" onclick="deletePhone('+rowIndex+')"></a>'}},{field:"phonetypid",title:"电话类型",width:100,hidden:true}]]});$("#addressTable").datagrid({title:"",method:"get",width:"100%",height:150,nowrap:false,striped:true,border:true,collapsible:false,fitColumns:true,singleSelect:true,scrollbarSize:-1,onBeforeLoad:function(){if($("#customerId").val()==null||$("#customerId").val()==""||$("#customerType").val()=="2"){return false}},onLoadSuccess:function(){if($("#customerState").val()==""||$("#customerState").val()=="2"){displayCoustomerAddress()}},url:"/contact/addressList/"+$("#customerType").val()+"/"+$("#customerId").val(),columns:[[{field:"auditState",width:26,align:"center",title:"审核",sortable:false,formatter:function(value){if(value==0){return'<span class="exaa">待审核</span>'}if(value==1){return'<span class="exaa">审核中</span>'}if(value==3){return'<span class="exa">未通过</span>'}else{return""}}},{field:"receiveAddress",title:"收货地址",width:120},{field:"address",title:"详细地址",width:30,resizable:false,formatter:function(value){return'<div onselectstart="return false;"><marquee direction="left" scrollamount="3">'+value+"</marquee></div>"}},{field:"zip",title:"邮编",width:30,align:"center"},{field:"isdefault",title:"默认",width:30,align:"center",formatter:function(value,rowData,rowIndex){if($("#customerState").val()=="0"||$("#customerState").val()=="1"||$("#customerState").val()=="3"||rowData.auditState=="0"||rowData.auditState=="1"||rowData.auditState=="3"){return value=="-1"?'<input type="checkbox" checked disabled />':'<input type="checkbox" disabled/>'}return value=="-1"?'<input type="checkbox" checked disabled />':'<input type="checkbox" onclick="setMainAddress('+rowIndex+')" />'}},{field:"addressEdit",title:"操作",align:"center",width:50,formatter:function(value,rowData,rowIndex){if($("#customerState").val()=="0"||$("#customerState").val()=="1"||$("#customerState").val()=="3"||rowData.auditState=="0"||rowData.auditState=="1"||rowData.auditState=="3"){return""}if($("#customerId").val()==""){return'<a class="modify" href="javascript:void(0);" onclick="editAddressNoId('+rowIndex+')"></a> <a class="del" href="javascript:void(0);" onclick="deleteAddress('+rowIndex+')"></a>'}else{var html='<a class="modify" href="javascript:void(0);" onclick="editAddress('+rowIndex+')"></a>';if($("#agentType").val().toLocaleLowerCase()=="in"&&rowData.addressid!=null){html+='&nbsp;&nbsp;&nbsp;<a class="modify" href="javascript:void(0);" onclick="onlyEditFourthAddress('+rowIndex+');">四</a>'}return html}}},{field:"addrtypid",title:"地址类型",width:100,hidden:true}]]});if($("#customerId").val()==null||$("#customerId").val()==""){displayCoustomerAddress();displayCoustomerPhone()}if($("#customerType").val()=="2"){displayCoustomerAddress()}$("#cardTable").datagrid({title:"",method:"get",width:"100%",height:120,nowrap:false,striped:true,border:true,collapsible:false,fitColumns:true,singleSelect:true,scrollbarSize:-1,onBeforeLoad:function(){if($("#customerId").val()==null||$("#customerId").val()==""||$("#customerType").val()=="2"){return false}},url:"/contact/cardList/"+$("#customerType").val()+"/"+$("#customerId").val(),columns:[[{field:"state",width:7,align:"center",title:"审核",formatter:function(value){if(value==0){return'<span class="exaa">待审核</span>'}if(value==1){return'<span class="exaa">审核中</span>'}if(value==3){return'<span class="exa">未通过</span>'}else{return""}}},{field:"cardtypeName",title:"信用卡类型",width:20},{field:"cardNumber",title:"卡号",width:30},{field:"validDate",title:"有效期",width:20}]]});$("#birthday").datebox({formatter:function(date){return date.getFullYear()+"-"+(date.getMonth()+1)+"-"+date.getDate()},onChange:function(){$("#formAddCustomerExt").data("changed",true)}});$("#birthday").datebox("setValue",$("#birthdayHidden").val());$("#formAddCustomerExt").data("changed",false);$("#childrenage").datebox({formatter:function(date){return date.getFullYear()+"-"+(date.getMonth()+1)+"-"+date.getDate()},onChange:function(){$("#formAddCustomerExt").data("changed",true)}});$("#childrenage").datebox("setValue",$("#childrenageHidden").val());$("#formAddCustomerExt").data("changed",false);$("#elderBirthday").datebox({formatter:function(date){return date.getFullYear()+"-"+(date.getMonth()+1)+"-"+date.getDate()},onChange:function(){$("#formAddCustomerExt").data("changed",true)}});$("#elderBirthday").datebox("setValue",$("#elderBirthdayHidden").val());$("#formAddCustomerExt").data("changed",false);initCustomerData();$("#formAddCustomerExt").change(function(){$("#formAddCustomerExt").data("changed",true)});$("#compareEditPhoneAndAddress").click(function(){var addressRows=$("#addressTable").datagrid("getRows");if($("#customerId").val()==""){addCoustomerInfo();return}else{if($("#customerType").val()=="2"&&addressRows==""){submitEditNameAndSex();return}else{if($("#customerType").val()=="2"&&addressRows!=""){addAddressToUpgrade();return}}}$(this).hide();$("#compareEditPhoneAndAddress_hidden").show();$.post("/contact/comparePhoneAndAddress",{customerId:$("#customerId").val(),customerType:$("#customerType").val(),phones:JSON.stringify($("#phoneTable").datagrid("getRows")),addresss:JSON.stringify($("#addressTable").datagrid("getRows"))},function(data){if(data.error){window.parent.alertWin("系统提示",data.error)}else{var options={title:"客户电话地址信息修改确认",height:395};window.parent.popWin(frameElement.id,"comparePhoneAndAddress"+$("#initCustomerId").val(),options);$(getPopWinNode("comparePhoneAndAddress","oldPhoneTable"),window.parent.document).datagrid({width:325,height:120,nowrap:false,striped:true,border:true,collapsible:false,fitColumns:true,columns:[[{field:"phn2",title:"客户电话",width:50,formatter:function(value,rowData,rowIndex){if(rowData.phonetypid&&rowData.phonetypid!=4){var phone="";phone+=(rowData.phn1?rowData.phn1+"-":"");phone+=value;phone+=(rowData.phn3?"-"+rowData.phn3:"");return phone}else{return value}}},{field:"prmphn",title:"默认",width:20,formatter:function(value){return value=="Y"?'<input type="checkbox" checked disabled />':'<input type="checkbox" disabled />'}},{field:"backupPhn",title:"备选",width:20,formatter:function(value,rowData,rowIndex){return rowData.prmphn=="B"?'<input type="checkbox" checked disabled />':'<input type="checkbox" disabled />'}}]]});$(getPopWinNode("comparePhoneAndAddress","oldPhoneTable"),window.parent.document).datagrid("loadData",data.oldPhones);$(getPopWinNode("comparePhoneAndAddress","newPhoneTable"),window.parent.document).datagrid({width:325,height:120,nowrap:false,striped:true,border:true,collapsible:false,fitColumns:true,scrollbarSize:0,columns:[[{field:"phn2",title:"客户电话",width:50,formatter:function(value,rowData,rowIndex){if(rowData.phonetypid&&rowData.phonetypid!=4){var phone="";phone+=(rowData.phn1?rowData.phn1+"-":"");phone+=value;phone+=(rowData.phn3?"-"+rowData.phn3:"");return phone}else{return value}}},{field:"prmphn",title:"默认",width:20,formatter:function(value){return value=="Y"?'<input type="checkbox" checked disabled />':'<input type="checkbox" disabled />'}},{field:"backupPhn",title:"备选",width:20,formatter:function(value,rowData,rowIndex){return rowData.prmphn=="B"?'<input type="checkbox" checked disabled />':'<input type="checkbox" disabled />'}}]]});var phoneEditIndexs=eval("["+data.phoneEditIndexs+"]");$(getPopWinNode("comparePhoneAndAddress","newPhoneTable"),window.parent.document).datagrid({rowStyler:function(rowIndex){if($.inArray(rowIndex,phoneEditIndexs)>-1){return"color:red;"}}});$(getPopWinNode("comparePhoneAndAddress","newPhoneTable"),window.parent.document).datagrid("loadData",data.newPhones);$(getPopWinNode("comparePhoneAndAddress","oldAddressTable"),window.parent.document).datagrid({width:325,height:120,striped:true,border:true,collapsible:false,fitColumns:true,columns:[[{field:"receiveAddress",title:"收货地址",width:20},{field:"address",title:"详细地址",width:10,resizable:false,formatter:function(value){return'<div onselectstart="return false;"><marquee direction="left" scrollamount="3">'+value+"</marquee></div>"}},{field:"zip",title:"邮编",width:15},{field:"isdefault",title:"默认",width:10,formatter:function(value){return value=="-1"?'<input type="checkbox" checked disabled />':'<input type="checkbox" disabled />'}}]]});$(getPopWinNode("comparePhoneAndAddress","oldAddressTable"),window.parent.document).datagrid("loadData",data.oldAddresss);var addAddressIndexs=eval("["+data.addressEditIndexs.addAddressIndexs+"]");var editAddressIndexs=eval("["+data.addressEditIndexs.editAddressIndexs+"]");$(getPopWinNode("comparePhoneAndAddress","newAddressTable"),window.parent.document).datagrid({width:325,height:120,striped:true,border:true,collapsible:false,fitColumns:true,rowStyler:function(rowIndex){if($.inArray(rowIndex,addAddressIndexs)>-1){return"color:red;"}},columns:[[{field:"receiveAddress",title:"收货地址",width:20,styler:function(value,rowData,rowIndex){if($.inArray(rowIndex,editAddressIndexs)>-1){var editAddressIndexClumns=eval("["+data.editAddressIndexColumns[rowIndex]+"]");if($.inArray(1,editAddressIndexClumns)>-1){return"color:red;"}}}},{field:"address",title:"详细地址",width:10,resizable:false,formatter:function(value){return'<div onselectstart="return false;"><marquee direction="left" scrollamount="3">'+value+"</marquee></div>"},styler:function(value,rowData,rowIndex){if($.inArray(rowIndex,editAddressIndexs)>-1){var editAddressIndexClumns=eval("["+data.editAddressIndexColumns[rowIndex]+"]");if($.inArray(2,editAddressIndexClumns)>-1){return"color:red;"}}}},{field:"zip",title:"邮编",width:15,styler:function(value,rowData,rowIndex){if($.inArray(rowIndex,editAddressIndexs)>-1){var editAddressIndexClumns=eval("["+data.editAddressIndexColumns[rowIndex]+"]");if($.inArray(3,editAddressIndexClumns)>-1){return"color:red;"}}}},{field:"isdefault",title:"默认",width:10,formatter:function(value){return value=="-1"?'<input type="checkbox" checked disabled />':'<input type="checkbox" disabled />'}}]]});$(getPopWinNode("comparePhoneAndAddress","newAddressTable"),window.parent.document).datagrid("loadData",data.newAddresss)}$("#compareEditPhoneAndAddress_hidden").hide();$("#compareEditPhoneAndAddress").show()})});$("#cancelEdit").click(function(){if($("#customerId").val()==""){$("#name").val("");$('input[name="sex"]')[0].checked=true;$("#phoneTable").datagrid("loadData",{total:0,rows:[]});$("#addressTable").datagrid("loadData",{total:0,rows:[]})}else{if($("#customerType").val()=="2"){$.get("/contact/getPotentialContactInfo/"+$("#customerId").val(),function(data){$("#name").val(data.customer.name);data.customer.sex==2?$('input[name="sex"]')[1].checked=true:$('input[name="sex"]')[0].checked=true});$("#phoneTable").datagrid("reload");$("#addressTable").datagrid("reload")}else{$("#phoneTable").datagrid("reload");$("#addressTable").datagrid("reload")}}});hiddenDocumentElement();$("#orderHistory").datagrid({view:detailview,detailFormatter:function(index,row){return'<div style="padding:2px"><table id="ddv-'+index+'"></table></div>'},onExpandRow:function(index,row){$("#ddv-"+index).datagrid({fitColumns:true,singleSelect:true,scrollbarSize:-1,loadMsg:"",height:"auto",columns:[[{field:"prodId",title:"商品编号",width:100,align:"center"},{field:"prodName",title:"商品名称",width:200,align:"center"},{field:"typeName",title:"规格",width:100,align:"center"},{field:"price",title:"价格",width:100,align:"right",formatter:function(value){return formatPrice(value)}},{field:"quantity",title:"数量",width:100,align:"center"},{field:"soldwith",title:"销售方式",width:100,align:"center"}]],onResize:function(){},onLoadSuccess:function(){setTimeout(function(){$("#orderHistory").datagrid("fixDetailRowHeight",index)},200)}});$("#ddv-"+index).datagrid("loadData",{total:row.contactOrderDetailFrontDtos.length,rows:row.contactOrderDetailFrontDtos})},width:"100%",height:410,fitColumns:true,scrollbarSize:-1,url:"/myorder/myorder/query_contact",queryParams:{contactId:$("#customerId").val()},rowStyler:function(index,row){var rowStyle="";switch(row.status){case"0":case"10":rowStyle="background-color:#cecece;text-decoration: line-through;";break;case"8":rowStyle="background-color:#A2BADD;text-decoration: line-through;";break;case"1":rowStyle="background-color:#FFC0C0";break;case"5":rowStyle="background-color:#C0FFC0";break;default:rowStyle="";break}return rowStyle},columns:[[{field:"orderid",title:"订单编号",align:"center",width:80,formatter:function(value,row,index){var canedit=0;if(row.right.indexOf("MODIFY")!=-1||row.right.indexOf("ALL")!=-1){canedit=1}var token='<a class="link" href="javascript:void(0);" onclick="javascript:viewOrder(\'myOrderlist\','+index+","+row.orderid+","+canedit+')" > ';token+=value;token+="</a>";return token}},{field:"crdt",title:"订单生成时间",width:120},{field:"paytype",title:"支付类型",align:"center",width:80,formatter:orderPaytypeFormatter},{field:"status",title:"订单状态",align:"center",width:80,formatter:orderStatusFormatter},{field:"totalprice",title:"订单金额",width:80,align:"right",formatter:function(value){return formatPrice(value)}},{field:"crusr",title:"生成坐席",align:"center",width:80},{field:"grpName",title:"坐席组",align:"center",width:140},{field:"mailid",title:"包裹单号",align:"center",width:120},{field:"fbdt",title:"反馈日期",width:150,align:"center"},{field:"logisticsStatusId",title:"物流状态",align:"center",width:150,formatter:logisticStatusFormatter},{field:"contactOrderDetailFrontDtos",title:"商品明细",hidden:true,formatter:function(value,row,index){return"<a>"+row.id+"</a>"}}]],remoteSort:false,singleSelect:true,pagination:true,onLoadSuccess:function(data){if(data.err!=null){window.parent.alertWin("系统提示",data.err)}},onLoadError:function(){window.parent.alertWin("系统提示","加载失败")}});$("#pointsDetail").click(function(){window.parent.addTab("pointDetail_"+$("#customerId").val(),$("#name").val()+"-积分详情",false,"/integral/integral?name="+encodeURI(encodeURI($("#name").val()))+"&customerId="+$("#customerId").val())});$("#newCustomerHiddenTd4").click(function(){$("#inboundtabs").tabs("select",1)});$("#taskCount").click(function(){window.parent.addTab("myTask_"+$("#customerId").val(),$("#name").val()+"-待办任务",false,"/task/myCampaignTask?contactId="+$("#customerId").val())});$("#assignHistory").datagrid({width:"100%",height:200,fitColumns:true,remoteSort:false,singleSelect:true,pagination:false,url:ctx+"/contact/queryAssignHistory",queryParams:{initLoad:false},onBeforeLoad:function(param){if(param.initLoad){return true}return false},onLoadSuccess:function(data){$("#assignHistory").datagrid("doCellTip",{delay:500})},columns:[[{field:"agentId",title:"当前分配座席",align:"center",width:100},{field:"agentGrp",title:"座席组",align:"center",width:100},{field:"sourceType",title:"分配方式",align:"center",width:100,formatter:function(value,row){var _label="";if(value==1){_label="自助取数"}else{if(value==3){_label="数据推送"}}return _label}},{field:"createDate",title:"分配时间",align:"center",width:100,formatter:dateFormatter},{field:"endDate",title:"到期时间",align:"center",width:100,formatter:dateFormatter}]]});$("#cancleEditFourthAddressBut").click(function(){$("#editFourthAddressTab").hide();$("#addAddressDiv").show()});$("#editFourthAddressBut").click(function(){var addresss=$("#addressTable").datagrid("getRows");var address=addresss[$("#addressRowIndexForFourth").val()];$.post("/contact/updateAddressArea/",{addressId:address.addressid,areaId:$("#areaIdForEditFourth").combobox("getValue")},function(data){$.ajax({url:"/contact/getReceiveAddress/"+$("#provinceForEditFourth").combobox("getValue")+"/"+$("#cityIdForEditFourth").combobox("getValue")+"/"+$("#countyIdForEditFourth").combobox("getValue")+"/"+$("#areaIdForEditFourth").combobox("getValue"),type:"GET",dataType:"json",success:function(data){if(data=="error"){window.parent.alertWin("系统提示","四级地址选择错误。");return}$("#addressTable").datagrid("updateRow",{index:$("#addressRowIndexForFourth").val(),row:{areaid:$("#areaIdForEditFourth").combobox("getValue"),receiveAddress:data}})}});$("#editFourthAddressTab").hide();$("#addAddressDiv").show()})});console.info("begin add click func");parent.addTabClickCallback($("#customerId").val(),"showCallback");console.info("end add click func");try{$("#name").focus();$("#phn1,#phn2,#phn3,#phn4").keydown(function(event){if(event.keyCode==13){$("#addCoustomerPhoneBut").click()}});$("#formAddCustomerAddress").keypress(function(event){if(event.keyCode==13){$("#addCoustomerAddressBut").click()}})}catch(err){console.error(err)}});function queryAssignHistory(){$("#gg").window("open");$("#assignHistory").datagrid("reload",{initLoad:true,contactId:$("#showCustomerId").html()})}function contactCases(){$("#id_cases").datagrid({width:"100%",height:410,nowrap:false,striped:true,border:true,collapsible:false,fitColumns:true,scrollbarSize:-1,url:"/contact/queryCase/"+$("#customerId").val(),columns:[[{title:"事件类型",field:"casetypeName",width:80},{title:"事件生成时间",field:"crdt",width:160},{title:"生成座席",field:"crusr",width:80},{title:"解决方式",field:"delivered",width:80},{title:"问题描述",field:"probdsc",width:150},{title:"处理描述",field:"external",width:150},{title:"是否协办",field:"cmpfBack",width:80}]],remoteSort:false,singleSelect:false,pagination:true})}function initComplainTable(){$("#complainTable").datagrid({width:"100%",height:410,nowrap:false,method:"GET",striped:true,border:true,collapsible:false,fitColumns:true,scrollbarSize:-1,url:"/complain/complainList/"+$("#customerId").val(),columns:[[{title:"客户姓名",field:"contactName",width:30},{title:"投诉内容",field:"content",width:97},{title:"投诉时间",field:"crtm",width:73,formatter:dateFormatter},{title:"创建坐席",field:"crusr",width:30},{title:"订单编号",field:"orderId",width:40},{title:"产品",field:"prod",width:40},{title:"优先级",field:"priovity",width:30,formatter:priorityFormatter},{title:"状态",field:"status",width:30,formatter:complainStatusFormatter},{title:"事件ID",field:"caseId",width:25},{title:"处理人",field:"opusr",width:22}]],remoteSort:false,singleSelect:false,pagination:true})}function contactContactHist(){$("#lead_interation_history").datagrid({width:"100%",url:"/contact/getLeadIntegration/"+$("#customerId").val(),nowrap:false,striped:true,height:330,border:true,collapsible:false,fitColumns:true,scrollbarSize:-1,columns:[[{title:"开始时间",field:"createDate",width:80},{title:"结束时间",field:"endDate",width:80},{title:"创建人",field:"createUser",width:80},{title:"备注",field:"note",width:80},{title:"客户编号",field:"contactId",width:80}]],remoteSort:false,singleSelect:false,pagination:true});$("#message_history").datagrid({width:"100%",height:330,url:"/contact/getMessageHistory/"+$("#customerId").val(),nowrap:false,striped:true,border:true,collapsible:false,fitColumns:true,scrollbarSize:-1,columns:[[{title:"类型",field:"smsType",width:80},{title:"手机号码",field:"mobile",width:80},{title:"内容",field:"content",width:80},{title:"时间",field:"createTime",width:80},{title:"状态",field:"receiveStatusDes",width:80}]],remoteSort:false,singleSelect:false,pagination:true})}var hiddenDocumentElement=function(){if($("#customerType").val()!="1"){$("#displayCard").css("display","none");$("#newCustomerHiddenTr").hide();$("#newCustomerHiddenTd1").hide();$("#newCustomerHiddenTd2").hide();$("#newCustomerHiddenTd3").hide();$("#newCustomerHiddenTd4").hide();$("#phoneTable").datagrid("showColumn","phoneOperate")}if(parent.showccBut){$("#cc_change").show()}else{$("#cc_change").hide()}};var initCustomerData=function(){$("#marriage").combobox("setValue",$("#marriageHidden").val());$("#income").combobox("setValue",$("#incomeHidden").val());$("#occupationStatus").combobox("setValue",$("#occupationStatusHidden").val());$("#education").combobox("setValue",$("#educationHidden").val())};var checkSubmitFlg=true;var addCoustomer=function(b,c,a,d){if(checkSubmitFlg==true){checkSubmitFlg=false;$.post("/customer/mycustomer/add/formal",{customerId:$("#customerId").val(),name:$("#name").val(),sex:$('input[name="sex"]:checked').val(),phones:a,addresses:d,source:parent._source},function(e){checkSubmitFlg=true;var f=$("#customerId").val();$("#customerId").val(e.customerId);$("#showCustomerId").html(e.customerId);$("#customerType").val(e.customerType);if(e.result){if(typeof(parent._source)=="undefined"){parent.gotoInfoCustomer(e.customerId,customerId.customerType,$("#name").val(),!window.parent.$("#"+window.parent.currentTabObj.tabId).hasClass("rell"))}else{if(parent._source=="shoppingCart"){parent.subCallback(parent._callBackframeid,parent._callbackMethod,e.customerId)}else{if(parent._source=="editOrder"){parent.subCallback(parent._callBackframeid,parent._callbackMethod,e.customerId)}else{parent.gotoInfoCustomer(e.customerId,customerId.customerType,$("#name").val(),!window.parent.$("#"+window.parent.currentTabObj.tabId).hasClass("rell"))}}}if(f==null||f==""){parent.destoryTab("newCustomer")}else{parent.destoryTab(f)}}else{window.parent.alertWin("系统提示",e.msg)}}).error(function(){checkSubmitFlg=true})}};var addCoustomerInfo=function(){if($("#formAddCustomerInfo").form("validate")){var b=$("#phoneTable").datagrid("getRows");var a=$("#addressTable").datagrid("getRows");if(b==""){window.parent.alertWin("提示","请添加客户电话")}else{if(a==""){window.parent.alertWin("提示","请添加客户地址")}else{addCoustomer($("#name").val(),$('input[name="sex"]:checked').val(),JSON.stringify(b),JSON.stringify(a))}}}};var addAddressToUpgrade=function(){if($("#name").val()==null||$("#name").val().trim()==""){window.parent.alertWin("系统提示","升级为正式客户，姓名为必填项。");return}if($("#formAddCustomerInfo").form("validate")){var a=$("#addressTable").datagrid("getRows");addCoustomer($("#name").val(),$('input[name="sex"]:checked').val(),null,JSON.stringify(a))}};function showShoppingCartPage(){if($("#shoppingcart_id").val()){$("#id_page_shoppingCart").show();$("#id_page_shoppingCart_message").hide();initShoppingCart()}else{var a="/cart/shoppingCartCreate";if($("#order_id").val()){a=a+"/ORDER/"+$("#customerId").val()}else{a=a+"/CART/"+$("#customerId").val()}$.ajax({url:a,async:false,type:"POST",dataType:"JSON",success:function(c){if(c.shoppingCartId){$("#id_page_shoppingCart").show();$("#id_page_shoppingCart_message").hide();$("#shoppingcart_id").attr("value",c.shoppingCartId);$("#shoppingcart_contactId").attr("value",c.shoppingCartContactId);$("#cart_cartType").attr("value",c.cart_cartType);$("#approveManager").attr("value",c.approveManager);$("#payment_contactid").attr("value",c.shoppingCartContactId);if(c.cardTypes!=null){for(var b in c.cardTypes){var d=c.cardTypes[b];if(d.bankName){$("#tbType").append('<option title="'+d.bankName+'" value="'+d.cardtypeid+'">'+d.bankName+"--"+d.cardname+"</option>")}else{$("#tbType").append('<option value="'+d.cardtypeid+'">'+d.cardname+"</option>")}}}if(c.cardBanks!=null){for(var b in c.cardBanks){$("#tbBank").append('<option value="'+c.cardBanks[b]+'">'+c.cardBanks[b]+"</option>")}}initShoppingCart()}}})}}var compareNameAndSex=function(){if($("#formAddCustomerInfo").form("validate")){$.post("/contact/compareNameAndSex",{name:$("#name").val(),sex:$('input:radio[name="sex"]:checked').val(),customerId:$("#customerId").val(),customerType:$("#customerType").val()},function(b){if(b.error){window.parent.alertWin("系统提示",b.error)}else{$(getPopWinNode("compareNameAndSex","oldName")).val(b.oldName);$(getPopWinNode("compareNameAndSex","newName")).val(b.newName);b.nameEdit?$(getPopWinNode("compareNameAndSex","newNameTR")).css("color","red"):$(getPopWinNode("compareNameAndSex","newNameTR")).css("color","black");b.oldSex==2?$(getPopWinNode("compareNameAndSex","oldSexWomen"))[0].checked=true:$(getPopWinNode("compareNameAndSex","oldSexMen"))[0].checked=true;b.newSex==2?$(getPopWinNode("compareNameAndSex","newSexWomen"))[0].checked=true:$(getPopWinNode("compareNameAndSex","newSexMen"))[0].checked=true;b.newSex==2?$(getPopWinNode("compareNameAndSex","newSexMen"))[0].checked=false:$(getPopWinNode("compareNameAndSex","newSexWomen"))[0].checked=false;b.sexEdit?$(getPopWinNode("compareNameAndSex","newSexTR")).css("color","red"):$(getPopWinNode("compareNameAndSex","newSexTR")).css("color","black");var a={title:"客户基本信息修改确认"};window.parent.popWin(frameElement.id,"compareNameAndSex"+$("#initCustomerId").val(),a)}})}};var submitEditNameAndSex=function(){if($("#formAddCustomerInfo").form("validate")){$.post("/contact/submitEditNameAndSex",{batchId:$("#input_batchId").val(),name:$("#name").val(),sex:$('input:radio[name="sex"]:checked').val(),customerId:$("#customerId").val(),customerType:$("#customerType").val()},function(a){window.parent.alertWin("系统提示",a.msg)})}};var clearCoustomerInfo=function(){if($("#customerId").val().trim()==""){$("#formAddCustomerInfo").form("clear")}else{window.parent.alertWin("系统提示","客户信息已保存！")}};$.extend($.fn.validatebox.methods,{remove:function(b,a){return b.each(function(){$(this).removeClass("validatebox-text validatebox-invalid").unbind("focus").unbind("blur")})},reduce:function(b,a){return b.each(function(){var c=$(this).data().validatebox.options;$(this).addClass("validatebox-text").validatebox(c)})}});var displayCoustomerPhone=function(){initPhone();var a=$("#phoneTable").datagrid("getRows");if(a.length==0){$("#isDefault").attr("checked",true);$("#isDefault").attr("disabled",true);$("#isDefaultPhoneTR").show()}else{$("#isDefault").attr("checked",false);$("#isDefaultPhoneTR").hide()}$("#phn1").validatebox("remove");$("#phn2").validatebox("remove");$("#phn4").validatebox("reduce");$("#AddPhoneTab").css("display","block");window.parent.SetCwinHeight(frameElement)};var initPhone=function(){$("#phn1").val("");$("#phn2").val("");$("#phn3").val("");$("#phn4").val("");$("#editRowIndex").val("");$("#potentialPhoneId").val("");$("#phonetypid").attr("checked",false);changefPhone();var a=$("#phoneTable").datagrid("getRows");if(a.length==0){$("#isDefault").attr("checked",true);$("#isDefault").attr("disabled",true);$("#isDefaultPhoneTR").show()}else{$("#isDefault").attr("checked",false);$("#isDefaultPhoneTR").hide()}$("#addCoustomerPhoneBut").removeAttr("disabled")};var changefPhone=function(){var c=$("#phonetypid").attr("checked")?"1":"4";if(c=="1"){$("#phn1").validatebox("reduce");$("#phn2").validatebox("reduce");$("#phn4").validatebox("remove");$("#fphone1").hide();$("#fphone2").show();if($("#editRowIndex").val()!=""){var b=$("#phoneTable").datagrid("getRows");var a=b[$("#editRowIndex").val()];if(a.phonetypid=="1"){$("#phn2").val(a.phn2)}else{$("#phn2").val("")}}}else{if(c=="4"){$("#phn1").validatebox("remove");$("#phn2").validatebox("remove");$("#phn4").validatebox("reduce");$("#fphone1").show();$("#fphone2").hide();if($("#editRowIndex").val()!=""){var b=$("#phoneTable").datagrid("getRows");var a=b[$("#editRowIndex").val()];if(a.phonetypid=="4"){$("#phn2").val(a.phn2)}else{$("#phn2").val("")}}}}};var addCoustomerPhone=function(){$("#addCoustomerPhoneBut").attr("disabled",true);if($("#formAddCustomerPhone").form("validate")){var k=($("#phonetypid").attr("checked")?1:4);var m=$("#phn1").val();var j=$("#phn2").val();var g=$("#phn3").val();var e=(m==null||m==""?"":(m+"-"))+j+(g==null||g==""?"":("-"+g));var d=m+"-"+j+"-"+g;var b=$("#phoneTable").datagrid("getRows");var l=$("#phn4").val();var a=(k==1?d:l);var h=(k==1?e:l);for(var c=0;c<b.length;c++){if(k==1&&b[c].phn1==m&&b[c].phn2==j&&b[c].phn3==g){window.parent.alertWin("系统提示","添加了重复电话号码。");return}if(k==4&&b[c].phn2==l){window.parent.alertWin("系统提示","添加了重复电话号码。");return}}var f=$("#customerId").val()==null||$("#customerId").val()==""?"newCustomer":$("#customerId").val();$.get("/contact/checkDuplicatePhone/"+f+"/"+k+"/"+a,function(o){if(o.code==0){window.parent.alertWin("系统提示",h+"已关联本客户ID！")}else{if(o.code==1){executeAddCusomerPhone()}else{if(o.code==2){$(getPopWinNode("phoneBindOneContact","popWinPhoneNum")).html(h);$(getPopWinNode("phoneBindOneContact","popWinContactId")).html(o.bindContactId);if(f=="newCustomer"){$(getPopWinNode("phoneBindOneContact","popWinPhonesMsg")).html("。");$(getPopWinNode("phoneBindOneContact","popWinButtons")).hide()}else{$(getPopWinNode("phoneBindOneContact","popWinPhonesMsg")).html("，是否新增？");$(getPopWinNode("phoneBindOneContact","popWinButtons")).show()}var n={title:"客户新增电话"};window.parent.popWin(frameElement.id,"phoneBindOneContact"+$("#initCustomerId").val(),n)}else{$(getPopWinNode("phoneBindMultiContact","popWinPhoneNum")).html(h);if(f=="newCustomer"){$(getPopWinNode("phoneBindMultiContact","popWinMultiPhonesMsg")).html("已关联多个客户ID，请选择绑定客户。");$(getPopWinNode("phoneBindMultiContact","popWinButtons")).hide()}else{$(getPopWinNode("phoneBindMultiContact","popWinMultiPhonesMsg")).html("已关联多个客户ID，是否新增？");$(getPopWinNode("phoneBindMultiContact","popWinButtons")).show()}$(getPopWinNode("phoneBindMultiContact","multiContactTable")).datagrid({title:"",iconCls:"icon-edit",height:200,nowrap:false,striped:true,border:true,collapsible:false,fitColumns:true,scrollbarSize:-1,url:"/customer/contact/phone/find",idField:"contactid",sortName:"crdt",sortOrder:"desc",columns:[[{field:"customerId",title:"客户编号",align:"center",width:100},{field:"name",title:"客户名称",align:"center",width:80},{field:"level",title:"会员等级",align:"center",width:80},{field:"address",title:"客户地址",width:200,formatter:function(r,p,s){return"<div unselectable='on' onselectstart='return false;' style='-moz-user-select:none;'><marquee scrollamount='3'>"+r+"</marquee></div>"}},{field:"crusr",title:"创建人",align:"center",width:80},{field:"crdt",title:"创建时间",width:140},{field:"addressid",title:"地址编号",width:100,hidden:true}]],remoteSort:false,singleSelect:false,pagination:true,queryParams:{phone:a,phoneType:k},onDblClickRow:function(p,r){if(r){window.parent.addTab(r.customerId,"客户详情",false,"/contact/1/"+r.customerId);window.parent.closeWin("phoneBindMultiContact"+$("#initCustomerId").val())}}});$(getPopWinNode("phoneBindMultiContact","multiContactTable")).datagrid("load");var q=$(getPopWinNode("phoneBindMultiContact","multiContactTable")).datagrid("getPager");$(q).pagination({pageSize:10,pageList:[5,10,15],beforePageText:"第",afterPageText:"页    共 {pages} 页",displayMsg:"当前显示 {from} - {to} 条记录   共 {total} 条记录",onBeforeRefresh:function(){$(this).pagination("loading");$(this).pagination("loaded")}});$("#phoneBindMultiContact"+$("#initCustomerId").val()).window("open")}}}})}};var executeAddCusomerPhone=function(){if($("#customerId").val()==""){if($("#editRowIndex").val()!=""){$("#phoneTable").datagrid("updateRow",{index:$("#editRowIndex").val(),row:{customerId:$("#customerId").val(),customerType:$("#customerType").val(),phn1:$("#phonetypid").attr("checked")?$("#phn1").val():"",phn2:$("#phonetypid").attr("checked")?$("#phn2").val():$("#phn4").val(),phn3:$("#phonetypid").attr("checked")?$("#phn3").val():"",phonetypid:$("#phonetypid").attr("checked")?"1":"4",prmphn:$("#isDefault").attr("checked")?"Y":"N"}});$("#editRowIndex").val("")}else{$("#editRowIndex").val("");$("#phoneTable").datagrid("appendRow",{customerId:$("#customerId").val(),customerType:$("#customerType").val(),phn1:$("#phonetypid").attr("checked")?$("#phn1").val():"",phn2:$("#phonetypid").attr("checked")?$("#phn2").val():$("#phn4").val(),phn3:$("#phonetypid").attr("checked")?$("#phn3").val():"",phonetypid:$("#phonetypid").attr("checked")?"1":"4",belongAddress:"",prmphn:$("#isDefault").attr("checked")?"Y":"N"})}initPhone();window.parent.SetCwinHeight(frameElement)}else{if($("#customerType").val()=="1"){$("#phoneTable").datagrid("appendRow",{customerId:$("#customerId").val(),customerType:$("#customerType").val(),phn1:$("#phonetypid").attr("checked")?$("#phn1").val():"",phn2:$("#phonetypid").attr("checked")?$("#phn2").val():$("#phn4").val(),phn3:$("#phonetypid").attr("checked")?$("#phn3").val():"",phonetypid:$("#phonetypid").attr("checked")?"1":"4",belongAddress:"",prmphn:$("#isDefault").attr("checked")?"Y":"N"});initPhone();return}$.post("/customer/mycustomer/phone/add",{customerId:$("#customerId").val(),customerType:$("#customerType").val(),phn1:$("#phn1").val(),phn2:$("#phn2").val(),phn3:$("#phn3").val(),phn4:$("#phn4").val(),isDefault:$("#isDefault").attr("checked"),phonetypid:$("#phonetypid").attr("checked"),potentialPhoneId:$("#potentialPhoneId").val()},function(a){if(a.result){$("#phoneTable").datagrid({url:"/contact/phoneList/"+$("#customerType").val()+"/"+$("#customerId").val()});$("#phoneTable").datagrid("reload")}else{window.parent.alertWin("系统提示",a.msg)}$("#potentialPhoneId").val("")});$("#potentialPhoneId").val("");initPhone();window.parent.SetCwinHeight(frameElement)}};var clickPopWinContactId=function(){var a=$(getPopWinNode("phoneBindOneContact","popWinContactId")).html();window.parent.addTab("p_"+$("#initCustomerId").val(),"客户详情",false,"/contact/1/"+a);window.parent.closeWin("phoneBindOneContact"+$("#initCustomerId").val())};var clickCancelPhoneBind=function(){window.parent.closeWin("phoneBindOneContact"+$("#initCustomerId").val())};var clickSubmitPhoneBind=function(){executeAddCusomerPhone();window.parent.closeWin("phoneBindOneContact"+$("#initCustomerId").val())};var clickCancelPhoneMultiBind=function(){$("#phoneBindMultiContact"+$("#initCustomerId").val()).window("close")};var clickSubmitPhoneMultiBind=function(){executeAddCusomerPhone();$("#phoneBindMultiContact"+$("#initCustomerId").val()).window("close")};var editPhone=function(c){displayCoustomerPhone();var b=$("#phoneTable").datagrid("getRows");var a=b[c];$("#potentialPhoneId").val(a.customerPhoneId);$("#phn1").val(a.phn1);$("#phn2").val(a.phn2);$("#phn3").val(a.phn3);$("#phn4").val(a.phn2);if(a.prmphn=="Y"){$("#isDefault").attr("checked",true)}else{$("#isDefault").attr("checked",false)}if(a.phonetypid=="4"){$("#phn1").validatebox("remove");$("#phn2").validatebox("remove");$("#phn4").validatebox("reduce");$("#fphone1").show();$("#fphone2").hide();if($("#editRowIndex").val()!=""){if(a.phonetypid=="4"){$("#phn2").val(a.phn2)}else{$("#phn2").val("")}}}else{$("#phonetypid").attr("checked",true);$("#phn1").validatebox("reduce");$("#phn2").validatebox("reduce");$("#phn4").validatebox("remove");$("#fphone1").hide();$("#fphone2").show();if($("#editRowIndex").val()!=""){if(a.phonetypid=="1"){$("#phn2").val(a.phn2)}else{$("#phn2").val("")}}}if($("#customerId").val()==""){$("#editRowIndex").val(c);if(a.prmphn=="Y"){$("#isDefaultPhoneTR").show()}else{$("#isDefaultPhoneTR").hidden()}}changefPhone()};var findByPhone=function(d){var c=$("#phoneTable").datagrid("getRows");var b=c[d];var a=(b.noEncryptionPhone==null||b.noEncryptionPhone=="")?b.phn2:b.noEncryptionPhone;parent.queryCustomer("","","queryByPhone",a,true);parent.findCustomer()};var deletePhone=function(c){var b=$("#phoneTable").datagrid("getRows");var a=b[c];if(a.prmphn=="Y"){window.parent.alertWin("系统提示","主电话不能被删除");return}if($("#customerId").val()==""){var b=$("#phoneTable").datagrid("getRows");var a=b[c];if(a.prmphn=="Y"){window.parent.alertWin("系统提示","默认电话不可以删除")}else{$("#phoneTable").datagrid("deleteRow",c)}}else{$.post("/customer/mycustomer/phone/delete",{customerId:$("#customerId").val(),customerType:$("#customerType").val(),potentialPhoneId:a.customerPhoneId},function(d){$("#phoneTable").datagrid({url:"/contact/phoneList/"+$("#customerType").val()+"/"+$("#customerId").val()});$("#phoneTable").datagrid("reload");if(!d.result){window.parent.alertWin("系统提示",d.msg)}})}initPhone()};var cancleCoustomerPhone=function(){$("#editRowIndex").val("");$("#formAddCustomerPhone")[0].reset();initPhone();window.parent.SetCwinHeight(frameElement)};var addCoustomerAddress=function(){if($("#formAddCustomerAddress").form("validate")){if($("#customerId").val()==""){if($("#editAddressRowIndex").val()!=""){$.ajax({url:"/contact/getReceiveAddress/"+$("#province").combobox("getValue")+"/"+$("#cityId").combobox("getValue")+"/"+$("#countyId").combobox("getValue")+"/"+$("#areaId").combobox("getValue"),type:"GET",dataType:"json",success:function(a){if(a=="error"){window.parent.alertWin("系统提示","四级地址选择错误。");return}$("#addressTable").datagrid("updateRow",{index:$("#editAddressRowIndex").val(),row:{state:$("#province").combobox("getValue"),cityId:$("#cityId").combobox("getValue"),countyId:$("#countyId").combobox("getValue"),areaid:$("#areaId").combobox("getValue"),address:$("#address").val(),zip:$("#zip").val(),receiveAddress:a,isdefault:$("#isDefaultAddress").attr("checked")?"-1":"0"}});$("#editAddressRowIndex").val("");cancleCoustomerAddress()}})}else{$("#editAddressRowIndex").val("");$.ajax({url:"/contact/getReceiveAddress/"+$("#province").combobox("getValue")+"/"+$("#cityId").combobox("getValue")+"/"+$("#countyId").combobox("getValue")+"/"+$("#areaId").combobox("getValue"),type:"GET",dataType:"json",success:function(a){if(a=="error"){window.parent.alertWin("系统提示","四级地址选择错误。");return}$("#addressTable").datagrid("appendRow",{contactid:$("#customerId").val(),state:$("#province").combobox("getValue"),cityId:$("#cityId").combobox("getValue"),countyId:$("#countyId").combobox("getValue"),areaid:$("#areaId").combobox("getValue"),address:$("#address").val(),addrtypid:"2",zip:$("#zip").val(),receiveAddress:a,isdefault:$("#isDefaultAddress").attr("checked")?"-1":"0"});cancleCoustomerAddress()}})}}else{$.ajax({url:"/contact/getReceiveAddress/"+$("#province").combobox("getValue")+"/"+$("#cityId").combobox("getValue")+"/"+$("#countyId").combobox("getValue")+"/"+$("#areaId").combobox("getValue"),type:"GET",dataType:"json",success:function(a){if(a=="error"){window.parent.alertWin("系统提示","四级地址选择错误。");return}$("#addressTable").datagrid("appendRow",{contactid:$("#customerId").val(),state:$("#province").combobox("getValue"),cityId:$("#cityId").combobox("getValue"),countyId:$("#countyId").combobox("getValue"),areaid:$("#areaId").combobox("getValue"),address:$("#address").val(),zip:$("#zip").val(),receiveAddress:a,isdefault:$("#isDefaultAddress").attr("checked")?"-1":"0"});cancleCoustomerAddress()}})}}};var displayCoustomerAddress=function(){cancleCoustomerAddress();var a=$("#addressTable").datagrid("getRows");if(a.length==0){$("#isDefaultAddress").attr("checked",true);$("#isDefaultAddress").attr("disabled",true);$("#isDefaultAddressTR").show()}else{$("#isDefaultAddress").attr("checked",false);$("#isDefaultAddress").attr("disabled",false);$("#isDefaultAddressTR").hide()}$("#address").show();$("#AddAdderssTab").css("display","block");window.parent.SetCwinHeight(frameElement)};var cancleCoustomerAddress=function(){if($("#h_provid").val()){addressInit("",$("#h_provid").val(),$("#h_cityid").val(),"","")}else{cancleAddressItem()}$("#formAddCustomerAddress")[0].reset();$("#editAddressRowIndex").val("");$("#addressRowIndex").val("");window.parent.SetCwinHeight(frameElement);var a=$("#addressTable").datagrid("getRows");if(a.length==0){$("#isDefaultAddress").attr("checked",true);$("#isDefaultAddress").attr("disabled",true);$("#isDefaultAddressTR").show()}else{$("#isDefaultAddress").attr("checked",false);$("#isDefaultAddress").attr("disabled",false);$("#isDefaultAddressTR").hide()}$("#addCoustomerAddressBut").removeAttr("disabled")};var addCoustomerExt=function(){var c,b,a;if(typeof($("#isCar").attr("checked"))=="undefined"){c=0}else{c="-1"}if(typeof($("#isChild").attr("checked"))=="undefined"){b=0}else{b="-1"}if(typeof($("#isParent").attr("checked"))=="undefined"){a=0}else{a="-1"}if($("#email").val()!=null&&$("#email").val()!=""&&/^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/.test($("#email").val())==false){$("#emailError").show();return}else{$("#emailError").hide()}if($("#formAddCustomerExt").form("validate")){$.post("/customer/mycustomer/ext/add",{customerId:$("#customerId").val(),customerType:$("#customerType").val(),email:$("#email").val(),weixin:$("#weixin").val(),birthday:$("#birthday").datebox("getValue"),marriage:$("#marriage").combobox("getValue"),income:$("#income").combobox("getValue"),occupation:$("#occupationStatus").combobox("getValue"),education:$("#education").combobox("getValue"),isCar:c,carValue:$("#carmoney2").val(),isChild:b,childAge:$("#childrenage").datebox("getValue"),isParent:a,parentAge:$("#elderBirthday").datebox("getValue")},function(d){window.parent.alertWin("系统提示",d.result)})}};var clearCoustomerExt=function(){$("#formAddCustomerExt").form("clear")};var editAddress=function(c){var b=$("#addressTable").datagrid("getRows");var a=b[c];initAddressForm(a,c)};var onlyEditFourthAddress=function(c){var b=$("#addressTable").datagrid("getRows");var a=b[c];if(a.addressid!=null){$.get("/contact/haveExWarehouseOrder/"+a.addressid,function(d){if(d){window.parent.alertWin("系统提示","该地址关联有未出库订单，暂时不能修改。");return}else{$("#editFourthAddressTab").show();$("#addAddressDiv").hide();$("#addressRowIndexForFourth").val(c);addressInitForEditFourth(a.state,a.cityId,a.countyId,a.areaid)}})}};var initAddressForm=function(a,b){$("#AddAdderssTab").show();$("#address").val("");$("#address").show();addressInit("",a.state,a.cityId,a.countyId,a.areaid);$("#address").val();$("#zip").val(a.zip);$("#addressId").val(a.addressid);$("#addressRowIndex").val(b);$("#isDefaultAddressTR").hide();window.parent.SetCwinHeight(frameElement)};var editAddressNoId=function(c){$("#AddAdderssTab").show();$("#address").val("");$("#address").show();$("#editAddressRowIndex").val(c);var b=$("#addressTable").datagrid("getRows");var a=b[c];addressInit("",a.state,a.cityId,a.countyId,a.areaid);$("#address").val();$("#zip").val(a.zip);$("#addressId").val(a.addressid);if(a.isdefault=="-1"){$("#isDefaultAddress")[0].checked=true;$("#isDefaultAddress").attr("disabled",true);$("#isDefaultAddressTR").show()}else{$("#isDefaultAddressTR").hide();$("#isDefaultAddress")[0].checked=false;$("#isDefaultAddress").attr("disabled",false)}};var deleteAddress=function(c){var b=$("#addressTable").datagrid("getRows");var a=b[c];if(a.isdefault=="-1"){window.parent.alertWin("系统提示","主地址不能被删除");return}if($("#customerId").val()==""){var b=$("#addressTable").datagrid("getRows");var a=b[c];if(a.isdefault=="-1"){window.parent.alertWin("系统提示","默认地址不可以删除")}else{$("#addressTable").datagrid("deleteRow",c)}}};var saveEditAddress=function(){if(!$("#formAddCustomerAddress").form("validate")){return}$.ajax({url:"/contact/getReceiveAddress/"+$("#province").combobox("getValue")+"/"+$("#cityId").combobox("getValue")+"/"+$("#countyId").combobox("getValue")+"/"+$("#areaId").combobox("getValue"),type:"GET",dataType:"json",success:function(a){if(a=="error"){window.parent.alertWin("系统提示","四级地址选择错误。");return}$("#addressTable").datagrid("updateRow",{index:$("#addressRowIndex").val(),row:{state:$("#province").combobox("getValue"),cityId:$("#cityId").combobox("getValue"),countyId:$("#countyId").combobox("getValue"),areaid:$("#areaId").combobox("getValue"),address:$("#address").val(),zip:$("#zip").val(),receiveAddress:a,isdefault:$("#isDefaultAddress").attr("checked")?"-1":"0"}});$("#addressId").val("");$("#addressRowIndex").val("");cancleCoustomerAddress()}});window.parent.SetCwinHeight(frameElement)};var editCard=function(c){$("#addCardTable").show();var b=$("#cardTable").datagrid("getRows");var a=b[c];$("#addCardType").val(a.type);$("#addCardNumber").val(a.cardNumber);$("#addCardValidateDate").val(a.validDate);$("#addCardRowIndex").val(c);$("#addCardId").val(a.cardId)};var saveEditCard=function(){$("#cardTable").datagrid("updateRow",{index:$("#addCardRowIndex").val(),row:{type:$("#addCardType").val(),cardNumber:$("#addCardNumber").val(),validDate:$("#addCardValidateDate").val()}});$("#addCardId").val("");$("#addCardRowIndex").val("");$("#addCardTable").hide();window.parent.SetCwinHeight(frameElement)};var cancelEditCard=function(){$("#addCardId").val("");$("#addCardRowIndex").val("");$("#addCardTable").hide();window.parent.SetCwinHeight(frameElement)};var submitEditPhoneAndAddress=function(){if($("#formAddCustomerInfo").form("validate")){$.post("/contact/submitEditPhoneAndAddress",{batchId:$("#input_batchId").val(),customerId:$("#customerId").val(),customerType:$("#customerType").val(),phones:JSON.stringify($("#phoneTable").datagrid("getRows")),addresss:JSON.stringify($("#addressTable").datagrid("getRows"))},function(a){window.parent.alertWin("系统提示",a.msg)})}};var clickIsCar=function(){var a=$("#isCar").attr("checked")?"1":"0";if(a=="0"){$("#carmoney2").val("");$("#carmoney2").attr("disabled","disabled")}else{$("#carmoney2").removeAttr("disabled")}};var clickIsChild=function(){var a=$("#isChild").attr("checked")?"1":"0";if(a=="0"){$("#childrenage").datebox("setValue","");$("#childrenage").datebox("disable")}else{$("#childrenage").datebox("enable")}};var clickIsParent=function(){var a=$("#isParent").attr("checked")?"1":"0";if(a=="0"){$("#elderBirthday").datebox("setValue","");$("#elderBirthday").datebox("disable")}else{$("#elderBirthday").datebox("enable")}};var setPrimePhone=function(c){var b=$("#phoneTable").datagrid("getRows");var a=b[c];if($("#customerId").val()==""){resetDefaultPhone(b,c)}else{if(a.customerPhoneId==null){resetDefaultPhone(b,c);return}$.post("/contact/setPrimePhone",{customerId:$("#customerId").val(),customerType:$("#customerType").val(),phoneId:a.customerPhoneId},function(d){$("#phoneTable").datagrid("reload")})}};var resetDefaultPhone=function(b,c){for(var a=0;a<b.length;a++){$("#phoneTable").datagrid("updateRow",{index:a,row:{prmphn:"N"}})}$("#phoneTable").datagrid("updateRow",{index:c,row:{prmphn:"Y"}})};var editBackupPhone=function(d,a){var c=$("#phoneTable").datagrid("getRows");var b=c[d];if(b.prmphn=="Y"){$(a).attr("checked",false);window.parent.alertWin("系统提示","主电话不能同时成为备选电话。");return}if($("#customerId").val()==""){resetBackupPhone(c,d)}else{if(b.customerPhoneId==null){resetBackupPhone(c,d);return}$.post("/contact/setBackupPhone",{customerId:$("#customerId").val(),customerType:$("#customerType").val(),phoneId:b.customerPhoneId,isBackup:c[d].prmphn!="B"},function(e){$("#phoneTable").datagrid("reload")})}};var resetBackupPhone=function(c,d){if(c[d].prmphn=="B"){$("#phoneTable").datagrid("updateRow",{index:d,row:{prmphn:"N"}});return}var b=new Array();for(var a=0;a<c.length;a++){if(c[a].prmphn=="B"){b.push(a)}}if(b.length>1){$("#phoneTable").datagrid("updateRow",{index:b[0],row:{prmphn:"N"}})}$("#phoneTable").datagrid("updateRow",{index:d,row:{prmphn:"B"}})};var setMainAddress=function(c){var b=$("#addressTable").datagrid("getRows");var a=b[c];if(a.addressid==null){resetMainAddress(b,c);return}$.post("/contact/setMainAddress",{customerId:$("#customerId").val(),addressId:a.addressid},function(d){$("#addressTable").datagrid("reload")})};var resetMainAddress=function(b,c){for(var a=0;a<b.length;a++){$("#addressTable").datagrid("updateRow",{index:a,row:{isdefault:"0"}})}$("#addressTable").datagrid("updateRow",{index:c,row:{isdefault:"-1"}})};function clickCancelEditNameAndSex(){window.parent.closeWin("compareNameAndSex"+$("#initCustomerId").val())}function clickSubmitEditNameAndSex(){window.parent.closeWin("compareNameAndSex"+$("#initCustomerId").val());submitEditNameAndSex()}function clickCancelEditPhoneAndAddress(){window.parent.closeWin("comparePhoneAndAddress"+$("#initCustomerId").val())}function clickSubmitEditPhoneAndAddress(){window.parent.closeWin("comparePhoneAndAddress"+$("#initCustomerId").val());submitEditPhoneAndAddress()}function getPopWinNode(b,a){return"#"+b+$("#initCustomerId").val()+" ."+a}function orderStatusFormatter(c,b){var a="";if(c==0){a="取消"}else{if(c==1){a="订购"}else{if(c==2){a="分拣"}else{if(c==5){a="完成"}else{if(c==6){a="拒收"}else{if(c==7){a="压单"}else{if(c==8){a="物流取消"}else{if(c==10){a="作废"}}}}}}}}return a}function orderPaytypeFormatter(c,b){for(var a=0;a<orderPayTypeList.length;a++){if(orderPayTypeList[a].id.id==c){return orderPayTypeList[a].dsc}}return c}function logisticStatusFormatter(c,b){var a="";if(c==0){a="正常"}else{if(c==1){a="已取消"}else{if(c==2){a="已出货"}else{if(c==3){a=""}else{if(c==4){a=""}else{if(c==5){a="客户签收"}else{if(c==6){a="拒收未入库"}else{if(c==7){a="问题单"}else{if(c==8){a="结算完成"}else{if(c==9){a="拒收入库"}else{if(c==10){a="配送异常"}else{if(c==11){a="总站收件"}else{if(c==12){a="派送点收件"}else{if(c==13){a="派件"}else{if(c==14){a="部分签收"}else{if(c==15){a="丢失"}else{if(c==16){a="退回"}else{if(c==17){a="转站"}else{if(c==18){a="二次配送"}else{if(c==19){a="三次配送"}}}}}}}}}}}}}}}}}}}}return a}function dateFormatter(b,a){if(null!=b){return new Date(b).format("yyyy-MM-dd hh:mm:ss")}}function priorityFormatter(b){var a="";if(b==1){a="紧急"}else{if(b==2){a="一般"}else{if(b==3){a="可以等待"}else{if(b==4){a="特别紧急"}}}}return a}function complainStatusFormatter(a){if(a==1){return"已受理"}else{return"未受理"}}Date.prototype.format=function(b){var c={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};if(/(y+)/.test(b)){b=b.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))}for(var a in c){if(new RegExp("("+a+")").test(b)){b=b.replace(RegExp.$1,RegExp.$1.length==1?c[a]:("00"+c[a]).substr((""+c[a]).length))}}return b};function formatPrice(a){if(a==null||a==""){return"0.00"}var b=a;return b.toFixed(2)}var callPhone=function(a,c,b){if(!checkStatusToCall()){return}if($("#analoglines",window.parent.document).val()=="false"){$("#outphone_loading").fadeIn();$("#outphone_loading div:first").css("line-height",$("#outphone_loading div:first").height()+"px")}$("#instanceId").val("");parent.outphone(a,c,b,$("#customerId").val(),$("#customerType").val(),0,frameElement.id)};function loadingFadeOut(){$("#outphone_loading").fadeOut()}function dateFormatter(a){if(null!=a){return new Date(a).format("yyyy-MM-dd hh:mm:ss")}}function checkStatusToCall(){if($("#callback",window.parent.document).val()==1){window.parent.alertWin("系统提示","系统处于callback模式，不支持外呼。");return false}if(parent.phone.status==-1||parent.phone.status==0||parent.phone.status==1||parent.phone.status==2){return true}window.parent.alertWin("系统提示","系统处在不能外拨的状态。");return false}var problematicOrderCallPhone=function(a,c){var b='{"id":'+$("#h_campaignId").val()+"}";ajaxToCreateTaskAndCallPhone(a,b,c)};var createTaskAndCallPhone=function(a,d,c){var b=$(".campaignTip"+c+"_"+d).val();if(null==b||""==b){return}ajaxToCreateTaskAndCallPhone(a,b,c)};var ajaxToCreateTaskAndCallPhone=function(a,b,c){var d=$("#customerId").val();$.ajax({url:"/contact/createTask",contentType:"application/json",data:{campaignDtoStr:b,contactId:d,dnsi:a},success:function(e){callPhone(a,c,e.campaignTask.instID)}})};function viewOrder(d,c,a,e){var b="myorder/orderDetails/get/"+a+"?activable=false";window.parent.addTab("myorder_"+a,"订单："+a,"false",b)}function refreshOrderHistory(){$("#orderHistory").datagrid("reload");bRefreshOrderHistory=true}var bRefreshOrderHistory=false;function showCallback(){if(bRefreshOrderHistory==true){$("#orderHistory").datagrid("reload");bRefreshOrderHistory=false}}function showOutPhoneType(d){if(!checkStatusToCall()){return}var c=$("#phoneTable").datagrid("getRows");var b=c[d];if(b.customerPhoneId==null||b.customerPhoneId==""){return}var a=b.noEncryptionPhone;if($("#instanceId").val()){$.ajax({url:"/task/isTaskFinished",async:false,contentType:"application/json",data:{instId:$("#instanceId").val()},success:function(e){if(e){$("#instanceId").val("")}}})}if($("#instanceId").val()){$(".phoneTablePhn2_"+d).tooltip({hideEvent:"none",showEvent:"click",content:'<div class="textC"><div>'+$(".phoneTablePhn2_"+d).text()+'</div><a class="callback" onclick="callPhone(\''+a+"', 1,'"+$("#instanceId").val()+'\')">本地</a>&nbsp;<a class="callback" onclick="callPhone(\''+a+"', 2,'"+$("#instanceId").val()+"')\">长途</a></div>",onShow:function(h,g){var f=$(this);f.tooltip("tip").css({backgroundColor:"#fff",borderColor:"#236FBD",borderRadius:"5px",padding:"3px",minWidth:"130px",color:"#236FBD",boxShadow:"0 0 3px rgba(0,0,0,0.5)",left:f.offset().left+f.width()/2-63,top:f.offset().top-6}).unbind().focus().bind("blur",function(){f.tooltip("hide")})}});$(".phoneTablePhn2_"+d).tooltip("show").tooltip("tip").find(".tooltip-arrow,.tooltip-arrow-outer").hide()}else{if($("#h_campaignId").val()){$(".phoneTablePhn2_"+d).tooltip({hideEvent:"none",showEvent:"click",content:'<div class="textC"><div>'+$(".phoneTablePhn2_"+d).text()+'</div><a class="callback" onclick="problematicOrderCallPhone(\''+a+'\', 1)">本地</a>&nbsp;<a class="callback" onclick="problematicOrderCallPhone(\''+a+"', 2)\">长途</a></div>",onShow:function(h,g){var f=$(this);f.tooltip("tip").css({backgroundColor:"#fff",borderColor:"#236FBD",borderRadius:"5px",padding:"3px",minWidth:"130px",color:"#236FBD",boxShadow:"0 0 3px rgba(0,0,0,0.5)",left:f.offset().left+f.width()/2-63,top:f.offset().top-6}).unbind().focus().bind("blur",function(){f.tooltip("hide")})}});$(".phoneTablePhn2_"+d).tooltip("show").tooltip("tip").find(".tooltip-arrow,.tooltip-arrow-outer").hide()}else{$.ajax({url:"/contact/queryContactTasks/"+$("#customerType").val()+"/"+$("#customerId").val(),type:"GET",dataType:"json",success:function(j){if(j.code=="0"){window.parent.alertWin("系统提示",j.msg)}else{if(j.code=="1"){$(".phoneTablePhn2_"+d).tooltip({hideEvent:"none",showEvent:"click",content:'<div class="textC"><div>'+$(".phoneTablePhn2_"+d).text()+'</div><a class="callback phoneTip1_'+d+'">本地</a>&nbsp;<a class="callback phoneTip2_'+d+'">长途</a></div>',onShow:function(p,o){var n=$(this);n.tooltip("tip").css({backgroundColor:"#fff",borderColor:"#236FBD",borderRadius:"5px",padding:"3px",minWidth:"130px",color:"#236FBD",boxShadow:"0 0 3px rgba(0,0,0,0.5)",left:n.offset().left+n.width()/2-63,top:n.offset().top-6}).unbind().focus().bind("blur",function(){if((!n.attr("isTip1Show")||n.attr("isTip1Show")=="false")&&(!n.attr("isTip2Show")||n.attr("isTip2Show")=="false")){n.tooltip("hide")}})}});$(".phoneTablePhn2_"+d).tooltip("show").tooltip("tip").find(".tooltip-arrow,.tooltip-arrow-outer").hide();$(".campaignTip1_"+d).each(function(){this.parentNode.removeChild(this)});var m='<div class="textC mb5"><p><font style="color:#fff;">任务：</font><select class="campaignTip1_'+d+'" style="width:150px;">';m+='<option value="">--请选择--</option>';for(var h=0;h<j.campaignList.length;h++){var k=j.campaignList[h];m+="<option value='"+k.json+"'>"+k.name+"</option>"}m+='</select></p><br><br><a class="dialBtn " onclick="createTaskAndCallPhone(\''+a+"',"+d+', 1)">确定</a></div>';$(".phoneTip1_"+d).tooltip({showEvent:"click",hideEvent:"none",content:m,onShow:function(){var n=$(this);$(".phoneTablePhn2_"+d).attr("isTip1Show",true);n.tooltip("tip").css({backgroundColor:"#3892D3",borderColor:"#3892D3",borderRadius:"5px",padding:"3px",boxShadow:"0 0 2px #999"}).unbind().focus().bind("blur",function(){setTimeout(function(){if($("select:focus").attr("class")!="campaignTip1_"+d){n.tooltip("hide");$(".phoneTablePhn2_"+d).attr("isTip1Show",false);if(!$(".phoneTablePhn2_"+d).attr("isTip2Show")||$(".phoneTablePhn2_"+d).attr("isTip2Show")=="false"){$(".phoneTablePhn2_"+d).tooltip("hide")}}else{$(".campaignTip1_"+d).bind("blur",function(){n.tooltip("hide");$(".phoneTablePhn2_"+d).attr("isTip1Show",false);setTimeout(function(){if(!$(".phoneTablePhn2_"+d).attr("isTip2Show")||$(".phoneTablePhn2_"+d).attr("isTip2Show")=="false"){$(".phoneTablePhn2_"+d).tooltip("hide")}},500)})}},500)})}});$(".campaignTip2_"+d).each(function(){this.parentNode.removeChild(this)});var l='<div class="textC mb5"><p><font style="color:#fff;">任务：</font><select class="campaignTip2_'+d+'" style="width:150px;">';l+='<option value="">--请选择--</option>';for(var h=0;h<j.campaignList.length;h++){var k=j.campaignList[h];l+="<option value='"+k.json+"'>"+k.name+"</option>"}l+='</select></p><br><br><a class="dialBtn" onclick="createTaskAndCallPhone(\''+a+"',"+d+', 2)">确定</a></div>';$(".phoneTip2_"+d).tooltip({showEvent:"click",hideEvent:"none",content:l,onShow:function(){var n=$(this);$(".phoneTablePhn2_"+d).attr("isTip2Show",true);n.tooltip("tip").css({backgroundColor:"#3892D3",borderColor:"#3892D3",borderRadius:"5px",padding:"3px"}).unbind().focus().bind("blur",function(){setTimeout(function(){if($("select:focus").attr("class")!="campaignTip2_"+d){n.tooltip("hide");$(".phoneTablePhn2_"+d).attr("isTip2Show",false);if(!$(".phoneTablePhn2_"+d).attr("isTip1Show")||$(".phoneTablePhn2_"+d).attr("isTip1Show")=="false"){$(".phoneTablePhn2_"+d).tooltip("hide")}}else{$(".campaignTip2_"+d).bind("blur",function(){n.tooltip("hide");$(".phoneTablePhn2_"+d).attr("isTip2Show",false);setTimeout(function(){if(!$(".phoneTablePhn2_"+d).attr("isTip1Show")||$(".phoneTablePhn2_"+d).attr("isTip1Show")=="false"){$(".phoneTablePhn2_"+d).tooltip("hide")}},500)})}},500)})}})}else{if(j.code=="2"){$(".phoneTablePhn2_"+d).tooltip({hideEvent:"none",showEvent:"click",content:'<div class="textC"><div>'+$(".phoneTablePhn2_"+d).text()+'</div><a class="callback" onclick="callPhone(\''+a+"', 1,'"+j.campaignTask.instID+'\')">本地</a>&nbsp;<a class="callback" onclick="callPhone(\''+a+"', 2,'"+j.campaignTask.instID+"')\">长途</a></div>",onShow:function(p,o){var n=$(this);n.tooltip("tip").css({backgroundColor:"#fff",borderColor:"#236FBD",borderRadius:"5px",padding:"3px",minWidth:"130px",color:"#236FBD",boxShadow:"0 0 3px rgba(0,0,0,0.5)",left:n.offset().left+n.width()/2-63,top:n.offset().top-6}).unbind().focus().bind("blur",function(){n.tooltip("hide")})}});$(".phoneTablePhn2_"+d).tooltip("show").tooltip("tip").find(".tooltip-arrow,.tooltip-arrow-outer").hide()}else{$(".phoneTablePhn2_"+d).tooltip({hideEvent:"none",showEvent:"click",content:'<div class="textC"><div>'+$(".phoneTablePhn2_"+d).text()+'</div><a href="javascript:void(0)" class="callback phoneTip1_'+d+'">本地</a>&nbsp;<a href="javascript:void(0)" class="callback phoneTip2_'+d+'">长途</a></div>',onShow:function(p,o){var n=$(this);n.tooltip("tip").css({backgroundColor:"#fff",borderColor:"#236FBD",borderRadius:"5px",padding:"3px",minWidth:"130px",color:"#236FBD",boxShadow:"0 0 3px rgba(0,0,0,0.5)",left:n.offset().left+n.width()/2-63,top:n.offset().top-6}).unbind().focus().bind("blur",function(){if((!n.attr("isTip1Show")||n.attr("isTip1Show")=="false")&&(!n.attr("isTip2Show")||n.attr("isTip2Show")=="false")){n.tooltip("hide")}})}});$(".phoneTablePhn2_"+d).tooltip("show").tooltip("tip").find(".tooltip-arrow,.tooltip-arrow-outer").hide();var e=j.myCampaignList.length>5?160:(22+j.myCampaignList.length*24);var g='<div style="height:'+e+'px;overflow:auto;white-space:nowrap;"><table width="100%" class="tooltip_2" >';g+='<tr><th >任务编号</th><th>任务名称</th><th align="center">任务类型</th><th>任务生成时间</th></tr>';for(var h=0;h<j.myCampaignList.length;h++){var k=j.myCampaignList[h];g+='<tr><td><a class="link" href="javascript:void(0);" onclick="callPhone(\''+a+"',1,'"+k.instID+"')\">"+k.instID+"</td><td>"+k.caName+'</td><td align="center">'+k.taskType+"</td><td>"+dateFormatter(k.ltCreateDate)+"</td></tr>"}g+="</table></div>";$(".phoneTip1_"+d).tooltip({hideEvent:"none",showEvent:"click",content:g,onShow:function(){var n=$(this);$(".phoneTablePhn2_"+d).attr("isTip1Show",true);n.tooltip("tip").css({backgroundColor:"#3892D3",borderColor:"#3892D3",borderRadius:"5px",padding:"3px",width:"361px",left:n.offset().left+n.width()/2-170}).unbind().focus().bind("blur",function(){n.tooltip("hide");$(".phoneTablePhn2_"+d).attr("isTip1Show",false);setTimeout(function(){if(!$(".phoneTablePhn2_"+d).attr("isTip2Show")||$(".phoneTablePhn2_"+d).attr("isTip2Show")=="false"){$(".phoneTablePhn2_"+d).tooltip("hide")}},500)})}});var f='<div style="height:'+e+'px;overflow:auto;white-space:nowrap;"><table width="100%" class="tooltip_2">';f+='<tr><th>任务编号</th><th>任务名称</th><th align="center">任务类型</th><th>任务生成时间</th></tr>';for(var h=0;h<j.myCampaignList.length;h++){var k=j.myCampaignList[h];f+='<tr><td><a class="link" href="javascript:void(0);" onclick="callPhone(\''+a+"',2,'"+k.instID+"')\">"+k.instID+"</td><td>"+k.caName+'</td><td align="center">'+k.taskType+"</td><td>"+dateFormatter(k.ltCreateDate)+"</td></tr>"}f+="</table>";$(".phoneTip2_"+d).tooltip({hideEvent:"none",showEvent:"click",content:f,onShow:function(){var n=$(this);$(".phoneTablePhn2_"+d).attr("isTip2Show",true);n.tooltip("tip").css({backgroundColor:"#3892D3",borderColor:"#3892D3",borderRadius:"5px",padding:"3px",width:"361px"}).unbind().focus().bind("blur",function(){n.tooltip("hide");$(".phoneTablePhn2_"+d).attr("isTip2Show",false);setTimeout(function(){if(!$(".phoneTablePhn2_"+d).attr("isTip1Show")||$(".phoneTablePhn2_"+d).attr("isTip1Show")=="false"){$(".phoneTablePhn2_"+d).tooltip("hide")}},500)})}})}}}}})}}}var detailview=$.extend({},$.fn.datagrid.defaults.view,{render:function(l,e,a){var d=$.data(l,"datagrid");var b=d.options;if(a){if(!(b.rownumbers||(b.frozenColumns&&b.frozenColumns.length))){return}}var p=d.data.rows;var k=$(l).datagrid("getColumnFields",a);var n=[];n.push('<table class="datagrid-btable" cellspacing="0" cellpadding="0" border="0"><tbody>');for(var h=0;h<p.length;h++){var j=b.rowStyler?b.rowStyler.call(l,h,p[h]):"";var f="";var o="";if(typeof j=="string"){o=j}else{if(j){f=j["class"]||"";o=j.style||""}}var m='class="datagrid-row '+(h%2&&b.striped?"datagrid-row-alt ":" ")+f+'"';var c=o?'style="'+o+'"':"";var g=d.rowIdPrefix+"-"+(a?1:2)+"-"+h;n.push('<tr id="'+g+'" datagrid-row-index="'+h+'" '+m+" "+c+">");n.push(this.renderRow.call(this,l,k,a,h,p[h]));n.push("</tr>");n.push('<tr style="display:none;">');if(a){n.push("<td colspan="+(k.length+2)+' style="border-right:0">')}else{n.push("<td colspan="+(k.length)+">")}n.push('<div class="datagrid-row-detail">');if(a){n.push("&nbsp;")}else{n.push(b.detailFormatter.call(l,h,p[h]))}n.push("</div>");n.push("</td>");n.push("</tr>")}n.push("</tbody></table>");$(e).html(n.join(""))},renderRow:function(m,l,a,n,h){var b=$.data(m,"datagrid").options;var g=[];if(a&&b.rownumbers){var f=n+1;if(b.pagination){f+=(b.pageNumber-1)*b.pageSize}g.push('<td class="datagrid-td-rownumber"><div class="datagrid-cell-rownumber">'+f+"</div></td>")}for(var j=0;j<l.length;j++){var o=l[j];var e=$(m).datagrid("getColumnOption",o);if(e){var p=h[o];var k=e.styler?(e.styler(p,h,n)||""):"";var d="";var r="";if(typeof k=="string"){r=k}else{if(g){d=k["class"]||"";r=k.style||""}}var q=d?'class="'+d+'"':"";var c=e.hidden?'style="display:none;'+r+'"':(r?'style="'+r+'"':"");g.push('<td field="'+o+'" '+q+" "+c+">");if(e.checkbox){c=""}else{if(e.expander){c="text-align:center;height:16px;"}else{c=r;if(e.align){c+=";text-align:"+e.align+";"}if(!b.nowrap){c+=";white-space:normal;height:auto;"}else{if(b.autoRowHeight){c+=";height:auto;"}}}}g.push('<div style="'+c+'" ');if(e.checkbox){g.push('class="datagrid-cell-check ')}else{g.push('class="datagrid-cell '+e.cellClass)}g.push('">');if(e.checkbox){g.push('<input type="checkbox" name="'+o+'" value="'+(p!=undefined?p:"")+'">')}else{if(e.expander){g.push('<span class="datagrid-row-expander datagrid-row-expand" style="display:inline-block;width:16px;height:16px;cursor:pointer;" />')}else{if(e.formatter){g.push(e.formatter(p,h,n))}else{g.push(p)}}}g.push("</div>");g.push("</td>")}}return g.join("")},insertRow:function(f,e,l){var a=$.data(f,"datagrid").options;var k=$.data(f,"datagrid").dc;var b=$(f).datagrid("getPanel");var j=k.view1;var g=k.view2;var h=false;var c=$(f).datagrid("getRows").length;if(c==0){$(f).datagrid("loadData",{total:1,rows:[l]});return}if(e==undefined||e==null||e>=c){e=c;h=true;this.canUpdateDetail=false}$.fn.datagrid.defaults.view.insertRow.call(this,f,e,l);d(true);d(false);this.canUpdateDetail=true;function d(p){var m=p?j:g;var o=m.find("tr[datagrid-row-index="+e+"]");if(h){var n=o.next().clone()}else{var n=o.next().next().clone()}n.insertAfter(o);n.hide();if(!p){n.find("div.datagrid-row-detail").html(a.detailFormatter.call(f,e,l))}}},deleteRow:function(e,b){var c=$.data(e,"datagrid").options;var a=$.data(e,"datagrid").dc;var d=c.finder.getTr(e,b);d.next().remove();$.fn.datagrid.defaults.view.deleteRow.call(this,e,b);a.body2.triggerHandler("scroll")},updateRow:function(e,g,f){var b=$.data(e,"datagrid").dc;var d=$.data(e,"datagrid").options;var a=$(e).datagrid("getExpander",g).attr("class");$.fn.datagrid.defaults.view.updateRow.call(this,e,g,f);$(e).datagrid("getExpander",g).attr("class",a);if(this.canUpdateDetail){var f=$(e).datagrid("getRows")[g];var c=$(e).datagrid("getRowDetail",g);c.html(d.detailFormatter.call(e,g,f))}},bindEvents:function(e){var d=$.data(e,"datagrid");var b=d.dc;var c=d.options;var a=b.body1.add(b.body2);var f=($.data(a[0],"events")||$._data(a[0],"events")).click[0].handler;a.unbind("click").bind("click",function(j){var g=$(j.target);var h=g.closest("tr.datagrid-row");if(!h.length){return}if(g.hasClass("datagrid-row-expander")){var k=parseInt(h.attr("datagrid-row-index"));if(g.hasClass("datagrid-row-expand")){$(e).datagrid("expandRow",k)}else{$(e).datagrid("collapseRow",k)}$(e).datagrid("fixRowHeight")}else{f(j)}j.stopPropagation()})},onBeforeRender:function(h){var b=$.data(h,"datagrid");var a=b.options;var j=b.dc;var k=$(h);var l=false;var f=k.datagrid("getColumnFields",true).concat(k.datagrid("getColumnFields"));for(var e=0;e<f.length;e++){var c=k.datagrid("getColumnOption",f[e]);if(c.expander){l=true;break}}if(!l){if(a.frozenColumns&&a.frozenColumns.length){a.frozenColumns[0].splice(0,0,{field:"_expander",expander:true,width:24,resizable:false,fixed:true})}else{a.frozenColumns=[[{field:"_expander",expander:true,width:24,resizable:false,fixed:true}]]}var k=j.view1.children("div.datagrid-header").find("table");var d=$('<td rowspan="'+a.frozenColumns.length+'"><div class="datagrid-header-expander" style="width:24px;"></div></td>');if($("tr",k).length==0){d.wrap("<tr></tr>").parent().appendTo($("tbody",k))}else{if(a.rownumbers){d.insertAfter(k.find("td:has(div.datagrid-header-rownumber)"))}else{d.prependTo(k.find("tr:first"))}}}var g=this;setTimeout(function(){g.bindEvents(h)},0)},onAfterRender:function(g){var e=this;var f=$.data(g,"datagrid");var c=f.dc;var d=f.options;var b=$(g).datagrid("getPanel");$.fn.datagrid.defaults.view.onAfterRender.call(this,g);if(!f.onResizeColumn){f.onResizeColumn=d.onResizeColumn}if(!f.onResize){f.onResize=d.onResize}function a(){var h=c.view2.children("div.datagrid-header").find("table").width();c.body2.children("table").width(h)}d.onResizeColumn=function(l,k){a();var h=$(g).datagrid("getRows").length;for(var j=0;j<h;j++){$(g).datagrid("fixDetailRowHeight",j)}f.onResizeColumn.call(g,l,k)};d.onResize=function(j,h){a();f.onResize.call(b,j,h)};this.canUpdateDetail=true;c.footer1.find("span.datagrid-row-expander").css("visibility","hidden");$(g).datagrid("resize")}});$.extend($.fn.datagrid.methods,{fixDetailRowHeight:function(b,a){return b.each(function(){var f=$.data(this,"datagrid").options;if(!(f.rownumbers||(f.frozenColumns&&f.frozenColumns.length))){return}var e=$.data(this,"datagrid").dc;var d=f.finder.getTr(this,a,"body",1).next();var g=f.finder.getTr(this,a,"body",2).next();if(g.is(":visible")){d.css("height","");g.css("height","");var c=Math.max(d.height(),g.height());d.css("height",c);g.css("height",c)}e.body2.triggerHandler("scroll")})},getExpander:function(c,a){var b=$.data(c[0],"datagrid").options;return b.finder.getTr(c[0],a).find("span.datagrid-row-expander")},getRowDetail:function(d,a){var b=$.data(d[0],"datagrid").options;var c=b.finder.getTr(d[0],a,"body",2);return c.next().find("div.datagrid-row-detail")},expandRow:function(b,a){return b.each(function(){var e=$(this).datagrid("options");var d=$.data(this,"datagrid").dc;var h=$(this).datagrid("getExpander",a);if(h.hasClass("datagrid-row-expand")){h.removeClass("datagrid-row-expand").addClass("datagrid-row-collapse");var c=e.finder.getTr(this,a,"body",1).next();var g=e.finder.getTr(this,a,"body",2).next();c.show();g.show();$(this).datagrid("fixDetailRowHeight",a);if(e.onExpandRow){var f=$(this).datagrid("getRows")[a];e.onExpandRow.call(this,a,f)}}})},collapseRow:function(b,a){return b.each(function(){var e=$(this).datagrid("options");var d=$.data(this,"datagrid").dc;var h=$(this).datagrid("getExpander",a);if(h.hasClass("datagrid-row-collapse")){h.removeClass("datagrid-row-collapse").addClass("datagrid-row-expand");var c=e.finder.getTr(this,a,"body",1).next();var g=e.finder.getTr(this,a,"body",2).next();c.hide();g.hide();d.body2.triggerHandler("scroll");if(e.onCollapseRow){var f=$(this).datagrid("getRows")[a];e.onCollapseRow.call(this,a,f)}}})}});(function(a){a.link=function(e,h){if(!e){var e={}}var b=true;var g=a("[link]").toArray();for(var d=0;d<g.length-1;d++){for(var c=1;c<g.length;c++){if(a(g[d]).attr("link")==a(g[c]).attr("link")){f(a(g[d]),a(g[c]));b=false;break}}}function f(l,k){k.width(l.width());var j=l.find("tr:first div.table-cell");var m=k.find("tr");m.each(function(n){a(this).find("div.table-cell").each(function(o){a(this).width(j.eq(o).width())})})}}})(jQuery);$(function(){$("#creditCards-grid").datagrid({title:"",width:"100%",striped:false,border:false,collapsible:false,fitColumns:true,scrollbarSize:-1,url:"/checkout/cc/default",columns:[[{field:"state",title:"审批",width:80,align:"center",formatter:function(a){if(a==0){return'<span class="exaa">待审核</span>'}else{if(a==1){return'<span class="exaa">审核中</span>'}else{if(a==3){return'<span class="exa">未通过</span>'}else{return""}}}}},{field:"contactId",title:"持卡人客户编号",width:120},{field:"contactName",title:"持卡人姓名",width:120},{field:"bankName",title:"银行",width:120},{field:"typeName",title:"证件类型",width:140},{field:"cardNumber",title:"证件号",width:150},{field:"extraCode",title:"附加码",width:100},{field:"validDate",title:"有效期",width:120},{field:"lastStatus",title:"分期数",width:60,editor:{type:"combobox",options:{valueField:"amortisation",textField:"amortisation",data:[],required:false,onSelect:function(){getOrderMessage()}}}}]],remoteSort:false,singleSelect:true,queryParams:{contactId:$("#payment_contactid").val()},onLoadSuccess:function(a){if(parent&&frameElement&&parent.SetCwinHeight){parent.SetCwinHeight(frameElement)}},onLoadError:function(){window.parent.alertWin("系统提示","加载失败!")},onClickRow:function(d,b){var c=$(this).attr("lastIndex");if(c){$(this).datagrid("endEdit",c)}if(["001","002","011","014"].indexOf($(b).attr("type"))>-1){return}$(this).datagrid("beginEdit",d);var a=$(this).datagrid("getEditors",d);if(a.length>0){$(a[0].target).combobox("clear");$(a[0].target).combobox("loadData",b.amortisations);$(a[0].target).combobox("setValue",b.lastStatus);$(a[0].target).focus()}$(this).attr("lastIndex",d)}});$("#selectCards-grid").datagrid({width:"90%",showHeader:true,nowrap:false,striped:true,border:true,collapsible:false,fitColumns:true,scrollbarSize:17,url:"/checkout/cc/all",frozenColumns:[[]],columns:[[{field:"ck",checkbox:true},{field:"state",title:"审批",width:68,align:"center",formatter:function(a){if(a==0){return'<span class="exaa">待审核</span>'}else{if(a==1){return'<span class="exaa">审核中</span>'}else{if(a==3){return'<span class="exa">未通过</span>'}else{return""}}}}},{field:"contactId",title:"持卡人客户编号",width:120},{field:"contactName",title:"持卡人姓名",width:120},{field:"bankName",title:"银行",width:120},{field:"typeName",title:"证件类型",width:80},{field:"cardNumber",title:"证件号",width:150},{field:"extraCode",title:"附加码",width:100},{field:"validDate",title:"有效期",width:120},{field:"lastStatus",title:"分期数",width:60},{field:"o",title:"操作",width:50,align:"center",formatter:function(b,c,a){return"<a class='link modify ' title='编辑' href='javascript:editCard("+a+")'></a>"}}]],remoteSort:false,singleSelect:false,checkOnSelect:true,selectOnCheck:true,queryParams:{contactId:$("#payment_contactid").val()},onClickRow:function(b,a){},onLoadSuccess:function(a){if(a.total>0){$("#selectCards-list").show();$("#selectCards-grid").datagrid("resize");if(parent&&frameElement&&parent.SetCwinHeight){parent.SetCwinHeight(frameElement)}}else{}},onLoadError:function(){window.parent.alertWin("系统提示","加载失败!")}});$("#tbTypeOptions").change(function(){var a=$(this).val();if(a){$("#lblType").parents("tr").show();$("#lblBank").parents("tr").show();$("#lblCardNumber").parents("tr").show();$("#lblValidDate").parents("tr").show();switch(a){case"0":$("#tbType").find("div > option").unwrap().removeAttr("selected");$("#tbType").find("option").wrap("<div/>");$("#tbType").find("div > option:first").unwrap();$("#tbType").find("div > option[value='014']").unwrap();$("#tbType").find("div > option[value='011']").unwrap();$("#tbType").find("div > option[value='002']").unwrap();$("#tbType").find("div > option[value='001']").unwrap();$("#tbBank").val("");$("#lblExtraCode").closest("tr").hide();$("#tbBank").closest("tr").find("td[accesskey='bank']").hide();break;case"1":$("#tbType").find("div > option").unwrap().removeAttr("selected");$("#lblExtraCode").closest("tr").show();$("#tbBank").closest("tr").find("td[accesskey='bank']").show();break;default:$("#tbType").find("div > option").unwrap().removeAttr("selected");break}}window.parent.SetCwinHeight(frameElement)});$("#tbBank").change(function(){var a=$(this).val();if(a){var b=$("#tbType").find("option[title='"+a+"']");if(b.length>0){$("#tbType").val($(b.get(0)).attr("value"))}}else{$("#tbType").val("")}});$("#tbType").change(function(){var c=$("#tbType > option").eq($("#tbType").get(0).selectedIndex).attr("value");if(c){if(["001","002","011","014"].indexOf(c)>-1){$("#tbBank").val("")}else{var b=$(this).find("option[value='"+c+"']");if(b){var a=$(b).attr("title");$("#tbBank").find("option[value='"+a+"']").attr("selected",true);$("#tbBank").val(a);$("#tbExtraCode2").validatebox({required:b.attr("extra")==-1})}}}else{$("#tbBank").val("")}});$("#tbValidYear").numberbox({formatter:function(a){return a.length>0?(a+"000").substring(0,4):a}});$("#tbValidMonth").numberbox({formatter:function(a){return a.length<2&&a.length>0?"0"+a:a}});$("#lnkCardConfirm").click(function(){var d=$("#selectCards-grid").datagrid("getSelections");if(d&&d.length>0){var c=null;var b=null;var f=getAddressContactId();for(var a=0;a<d.length;a++){var e=$(d[a]).attr("contactId");if(e!=f){window.parent.alertWin("系统提示","信用卡订单付款人与收货人必须一致");return}if(["001","002","011","014"].indexOf($(d[a]).attr("type"))>-1){b=d[a]}else{if(c){window.parent.alertWin("系统提示","最多只能使用一张信用卡");return}else{c=d[a]}}}if(b&&b.state=="1"){window.parent.alertWin("系统提示","不能使用正在审批的身份证件");return}else{if(b&&b.state=="3"){window.parent.alertWin("系统提示","不能使用未通过的身份证件");return}}if(c&&c.state=="1"){window.parent.alertWin("系统提示","不能使用正在审批的信用卡");return}else{if(c&&c.state=="3"){window.parent.alertWin("系统提示","不能使用未通过审批的信用卡");return}}$("#creditCards-grid").datagrid("loadData",d);$("#creditCards-grid").datagrid("resize",{height:"auto",width:"100%"});$("#selectCards-div").hide();$("#id_creditTitle_div").hide();getOrderMessage()}else{window.parent.alertWin("系统提示","请先选择一笔证件或卡记录")}window.parent.SetCwinHeight(frameElement)});$("#lnkCardNew").click(function(){$("#tbType").val("");$("#tbBank").val("");$("#tbCardNumber").val("");$("#tbValidYear").numberbox("setValue","");$("#tbValidMonth").numberbox("setValue","");$("#tbCardId").val("");$("#tbTypeOptions").val("");$("#tbType").find("span > option").unwrap().removeAttr("selected");$("#lblType").parents("tr").hide();$("#lblBank").parents("tr").hide();$("#lblCardNumber").parents("tr").hide();$("#lblExtraCode").closest("tr").hide();$("#lblValidDate").parents("tr").hide();$("#card-container-div").show();window.parent.SetCwinHeight(frameElement)});$("#lnkCardCancel").click(function(){$("#card-container-div").hide();window.parent.SetCwinHeight(frameElement)});$("#lnkCardSave").click(function(){var c=$("#tbValidYear").numberbox("getValue");var d=$("#tbValidMonth").numberbox("getValue");var a="";if(c&&d){if(d.length<2){d="0"+d}a=c+"-"+d}var b=$("#tbType > option").eq($("#tbType").get(0).selectedIndex).attr("value");if(!b){window.parent.alertWin("系统提示","证件类型不能为空！");$("#tbType").focus();return}if(["001","002","011","014"].indexOf(b)==-1){if(a==""){window.parent.alertWin("系统提示","信用卡有效期不能为空");$("#tbValidYear").focus();return}else{if(new Date(a+"-01")<new Date()){window.parent.alertWin("系统提示","信用卡有效期已经过期");$("#tbValidYear").focus();return}}}if(!$("#tbCardNumber").validatebox("isValid")){return}if(!$("#tbExtraCode2").validatebox("isValid")){return}$.post("/checkout/cc/save",{contactId:$("#payment_contactid").val(),cardType:b,cardNumber:$("#tbCardNumber").val(),validDate:a,cardId:$("#tbCardId").val(),extraCode:$("#tbExtraCode2").val()},function(e){if(e){$("#selectCards-grid").datagrid("load",{contactId:$("#payment_contactid").val()});if(e.indexOf("失败")>-1){window.parent.alertWin("系统提示",e)}else{$("#card-container-div").hide()}if(parent&&frameElement&&parent.SetCwinHeight){parent.SetCwinHeight(frameElement)}}window.parent.alertWin("系统提示",e)},"text")});$("#lnkAuth").click(function(){var k=$("#creditCards-grid").datagrid("getRows");if(k&&k.length>0){var g=null;var j=null;var a=1;for(var d=0;d<k.length;d++){$("#creditCards-grid").datagrid("endEdit",d);if(["001","002","011","014"].indexOf($(k[d]).attr("type"))>-1){j=k[d]}else{if(g){window.parent.alertWin("系统提示","最多只能使用一张信用卡");return}else{g=k[d];a=$(g).attr("lastStatus")}}}if(g==null||j==null){window.parent.alertWin("系统提示","至少必须有一张信用卡与一个身份证件");return}if(!a){a=1}var b=$(g).attr("amortisations");if(b.length==0){window.parent.alertWin("系统提示","一张信用卡设置需要设置相应分期数");return}else{var h=0;var c=0;var f=false;for(var d=0;d<b.length;d++){if(b[d].amortisation==a){h=b[d].lprice;c=b[d].uprice;f=true;break}}if(f){var e=$("#tbPayAmount").val();if(e<h||e>=c){window.parent.alertWin("系统提示","当前信用卡分期数["+a+"]的金额范围："+h+"-"+c);return}}else{window.parent.alertWin("系统提示","当前信用卡分期数不正确");return}}$.post("/checkout/cc/auth",{orderId:$("#tbOrderId").val(),ccCardId:$(g).attr("cardId"),idCardId:$(j).attr("cardId"),extraCode:$("#tbExtraCode").val(),lastStatus:a},function(l){if(l){window.parent.alertWin("系统提示","信用卡索权成功！")}else{window.parent.alertWin("系统提示","信用卡索权失败！")}})}});$("#lnkPay").click(function(){var k=$("#creditCards-grid").datagrid("getRows");if(k&&k.length>0){var g=null;var j=null;var a=1;for(var d=0;d<k.length;d++){$("#creditCards-grid").datagrid("endEdit",d);if(["001","002","011","014"].indexOf($(k[d]).attr("type"))>-1){j=k[d]}else{if(g){window.parent.alertWin("系统提示","最多只能使用一张信用卡");return}else{g=k[d];a=$(g).attr("lastStatus")}}}if(g==null||j==null){window.parent.alertWin("系统提示","至少必须有一张信用卡与一个身份证件");return}if(!a){a=1}var b=$(g).attr("amortisations");if(b.length==0){window.parent.alertWin("系统提示","一张信用卡设置需要设置相应分期数");return}else{var h=0;var c=0;var f=false;for(var d=0;d<b.length;d++){if(b[d].amortisation==a){h=b[d].lprice;c=b[d].uprice;f=true;break}}if(f){var e=$("#tbPayAmount").val();if(e<h||e>=c){window.parent.alertWin("系统提示","当前信用卡分期数["+a+"]的金额范围："+h+"-"+c);return}}else{window.parent.alertWin("系统提示","当前信用卡分期数不正确");return}}$("#tbExtraCode").val($("#tbExtraCode").val().replace(/^\s+|\s+$/g,""));if($(g).attr("showextracode")=="0"){}else{if(!$("#tbExtraCode").val()){window.parent.alertWin("系统提示","请输入信用卡附加码!");$("#tbExtraCode").focus();return}}$.post("/checkout/cc/pay",{orderId:$("#tbOrderId").val(),ccCardId:$(g).attr("cardId"),idCardId:$(j).attr("cardId"),extraCode:$("#tbExtraCode").val(),lastStatus:a},function(l){if(l.indexOf("支付成功")>-1){matchDelivery($("#tbOrderId").val(),2)}else{window.parent.alertWin("系统提示",l)}},"text")}else{window.parent.alertWin("系统提示","请选择信用卡及其证件记录!")}});$("#lnkCancel").click(function(){if(confirm("真的要取消订单吗？")){$.post("/checkout/cc/cancel",{orderId:$("#tbOrderId").val()},function(a){if(a){window.parent.alertWin("系统提示","订单取消成功!")}else{window.parent.alertWin("系统提示","订单取消失败!")}})}});$("#lnkContact").click(function(){selectContactAddress2()});$("#modifyDCBtn").click(function(){$("#lnkCardNew").click();$("#selectCards-div").toggle();$("#id_creditTitle_div").toggle();var a=$("#selectCards-grid").datagrid("getRows");if(a==0){$("#selectCards-grid").datagrid("resize",{width:"100%",height:60})}$("#selectCards-grid").datagrid("resize",{width:"100%",height:150});$("#card-container-div").hide();parent.SetCwinHeight(frameElement)});$("#selectCards-div").hide()});function initCreditCard(){checkPayerName($("#payment_contactid").val());$("#creditCards-grid").datagrid("load",{contactId:$("#payment_contactid").val()});$("#selectCards-grid").datagrid("load",{contactId:$("#payment_contactid").val()});$("#selectCards-div").hide()}function editCard(b){var c=$("#selectCards-grid").datagrid("getRows")[b];if(c){if(["001","002","011","014"].indexOf($(c).attr("type"))>-1){$("#tbTypeOptions").val(0)}else{$("#tbTypeOptions").val(1)}$("#tbTypeOptions").change();$("#tbBank").val($(c).attr("bankName"));$("#tbBank").change();$("#tbCardId").val($(c).attr("cardId"));$("#tbType").val($(c).attr("type"));$("#tbCardNumber").val($(c).attr("cardNumber"));$("#tbExtraCode2").val($(c).attr("extraCode"));var a=$(c).attr("validDate");if(a){$("#tbValidYear").numberbox("setValue",a.substring(0,4));$("#tbValidMonth").numberbox("setValue",a.substring(5,7))}else{$("#tbValidYear").numberbox("setValue","");$("#tbValidMonth").numberbox("setValue","")}$("#card-container-div").show()}}function selectContactAddress2(){window.parent.queryC(frameElement.id,"getCustomerShow2","shoppingCart")}function getCustomerShow2(a,b){parent._source="";if(a==$("#shoppingcart_contactId").val()){$("#lblModifyContact").html("当前客户")}$.post("/cart/check/contactName",{contactId:a},function(c){if(c=="auditContact"){$("#id_payer_errorMessage").html("付款人("+b+")正在审批中，无法选用");return}if(c!="false"){$("#id_payer_errorMessage").html("付款人("+b+")姓名正在审批中")}else{$("#id_payer_errorMessage").html("");$("#creditCards-grid").datagrid("load",{contactId:a});$("#selectCards-grid").datagrid("load",{contactId:a});$("#payment_contactid").val(a);if(b){$("#lblModifyContact").html(b)}else{$("#lblModifyContact").html(a)}}});$("#card-container-div").hide()}function checkPayerName(a){$.post("/cart/check/contactName",{contactId:a},function(b){if(b=="auditContact"){$("#id_payer_errorMessage").html("付款人正在审批中,无法选用");return}if(b!="false"){$("#id_payer_errorMessage").html("付款人姓名正在审批中")}else{$("#id_payer_errorMessage").html("")}})}$(function(){$.extend($.fn.datagrid.methods,{doCellTip:function(d,c){function b(f,h,g){if($(h).text()==""){return}f.tooltip.text($(h).text()).css({top:(g.pageY+10)+"px",left:(g.pageX+20)+"px","z-index":$.fn.window.defaults.zIndex,display:"block"})}return d.each(function(){var h=$(this);var g=$(this).data("datagrid");if(!g.tooltip){var e=h.datagrid("getPanel").panel("panel");var f={border:"1px solid #333",padding:"1px",color:"#333",background:"#f7f5d1",position:"absolute","max-width":"200px","border-radius":"4px","-moz-border-radius":"4px","-webkit-border-radius":"4px",display:"none"};var j=$("<div id='celltip'></div>").appendTo("body");j.css($.extend({},f,c.cls));g.tooltip=j;e.find(".datagrid-body").each(function(){var k=$(this).find("> div.datagrid-body-inner").length?$(this).find("> div.datagrid-body-inner")[0]:this;$(k).undelegate("td","mouseover").undelegate("td","mouseout").undelegate("td","mousemove").delegate("td",{mouseover:function(m){if(c.delay){if(g.tipDelayTime){clearTimeout(g.tipDelayTime)}var l=this;g.tipDelayTime=setTimeout(function(){b(g,l,m)},c.delay)}else{b(g,this,m)}},mouseout:function(l){if(g.tipDelayTime){clearTimeout(g.tipDelayTime)}g.tooltip.css({display:"none"})},mousemove:function(m){var l=this;if(g.tipDelayTime){clearTimeout(g.tipDelayTime);g.tipDelayTime=setTimeout(function(){b(g,l,m)},c.delay)}else{b(g,l,m)}}})})}})},cancelCellTip:function(b){return b.each(function(){var d=$(this).data("datagrid");if(d.tooltip){d.tooltip.remove();d.tooltip=null;var c=$(this).datagrid("getPanel").panel("panel");c.find(".datagrid-body").undelegate("td","mouseover").undelegate("td","mouseout").undelegate("td","mousemove")}if(d.tipDelayTime){clearTimeout(d.tipDelayTime);d.tipDelayTime=null}})}});if($("#smsSendHistory").length>0){$("#smsSendHistory").datagrid({width:"100%",height:410,scrollbarSize:0,nowrap:true,striped:true,remoteSort:false,singleSelect:true,pagination:true,autoRowHeight:false,url:"querySendHistory",queryParams:{contactId:$("#customerId").val()},columns:[[{field:"createUser",title:"发送坐席",align:"center",width:50},{field:"contactId",title:"客户编号",align:"center",width:80},{field:"mobile",align:"center",title:"发送手机",width:100},{field:"orderIds",title:"订单号",align:"center",width:100},{field:"smsName",title:"模板名称",align:"center",width:120},{field:"appContent",title:"短信内容",align:"center",width:150},{field:"createDate",title:"发送时间",width:100,formatter:dateFormatter},{field:"appResponseCode",align:"center",title:"发送状态",width:100},{field:"op",title:"操作",align:"center",width:100,formatter:function(c,b){var d="";if(b.smsErrorCode==0){d='<a href="javascript:void(0)" onclick=javascript:resendSms(\''+b.uuid+"','"+b.contactId+"','"+b.orderIds+"')>重发</a>"}return d}}]],onLoadSuccess:function(b){$("#smsSendHistory").datagrid("doCellTip",{delay:500})}});var a=$("#smsSendHistory").datagrid("getPager");$(a).pagination({pageSize:10,pageList:[5,10,15],beforePageText:"第",afterPageText:"页    共 {pages} 页",displayMsg:"当前显示 {from} - {to} 条记录   共 {total} 条记录",onBeforeRefresh:function(){$(this).pagination("loading");$(this).pagination("loaded")}})}$("#queryContact").click(function(){$("#smsSendHistory").datagrid("reload",{contactId:$("#customerId").val()});var b=$("#customerId").val();$("#mobile").combobox({url:ctx+"/sms/queryCustomerMobile?contactId="+b,valueField:"phoneNum",textField:"phoneNumMask"})});$("#sendSms").click(function(){var d=$("#smsForm").form("validate");if(!d){return}var c=$("#smsForm").serialize();var b=$("#smsName").combobox("getText");c=updateURIParameter(c,"smsName",b);sendSms(c)});if(undefined!=_contactId&&null!=_contactId&&""!=_contactId){$("#queryContact").trigger("click")}});function sendSmsViaOrder(_row,showMessage){var _obj=eval("("+_row+")");var _data=new Object();_data.mobile=_obj.mobile;_data.smsContent=_obj.appContent;_data.customerId=_obj.contactId;_data.smsName=_obj.smsName;_data.orderId=_obj.orderIds;_data.leadId=_obj.leadId;$.ajax({url:ctx+"/sms/send",data:_data,async:false,success:function(_rs){if(showMessage){if(eval(_rs.success)){window.parent.alertWin("发送提醒","发送提交成功")}else{window.parent.alertWin("发送提醒","发送提交失败:"+_rs.message)}}},error:function(msg){window.parent.alertWin("提示","网络错误或会话超时")}})}function resendSms(uuid,contactId,orderIds){var leadId=$("#leadId").val();$.ajax({url:ctx+"/sms/resend",data:{uuid:uuid,leadId:leadId,orderId:orderIds},success:function(_rs){if(eval(_rs.success)){window.parent.alertWin("发送提醒","发送提交成功");$("#smsSendHistory").datagrid("reload",{contactId:contactId})}else{window.parent.alertWin("发送提醒","发送提交失败")}},error:function(){window.parent.alertWin("提示","网络错误或会话超时")}})}function sendSms(_data){$.ajax({url:ctx+"/sms/send",data:_data,success:function(_rs){if(eval(_rs.success)){window.parent.alertWin("发送提醒","发送提交成功");var _contactId=$("#customerId").val();$("#smsName").combobox("clear");$("#smsContent").val("");$("#mobile").combobox("loadData",[]);$("#mobile").combobox("clear");$("#customerId").val(_contactId);$("#queryContact").trigger("click")}else{window.parent.alertWin("发送提醒","发送提交失败")}},error:function(){window.parent.alertWin("提示","网络错误或会话超时")}})}function updateURIParameter(c,g,d){var f="";var e=c.split("?");var b=e[0];var a="";if(b){e=b.split("&");for(i=0;i<e.length;i++){if(e[i].split("=")[0]!=g){f+=a+e[i];a="&"}}}var h=a+""+g+"="+d;return f+h}function dateFormatter(b,a){if(null!=b){return new Date(b).format("yyyy-MM-dd hh:mm:ss")}}Date.prototype.format=function(b){var c={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};if(/(y+)/.test(b)){b=b.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))}for(var a in c){if(new RegExp("("+a+")").test(b)){b=b.replace(RegExp.$1,RegExp.$1.length==1?c[a]:("00"+c[a]).substr((""+c[a]).length))}}return b};$.extend($.fn.validatebox.defaults.rules,{mobile:{validator:function(a){return/^(13|14|15|18)\d{9}$/i.test(a)},message:"手机号码格式不正确"},telephoneAreaCode:{validator:function(a){return/^(\d{4}|\d{3})$/i.test(a)},message:"区号格式不正确"},telephone:{validator:function(a){return/^(\d{7,8})$/i.test(a)},message:"电话号码格式不正确"},telephoneExt:{validator:function(a){return/^(\d{4}|\d{3}|\d{2}|\d{1})$/i.test(a)},message:"分机号格式不正确"},zipCode:{validator:function(a){return/^[0-9][0-9]{5}$/i.test(a)},message:"邮政编码格式不正确"},address_p:{validator:function(b,c){var a=false;$.each($(c[0]).combobox("getData"),function(d,e){if(e.provinceName==b){a=true}});return a},message:"地址无效"},address_c:{validator:function(b,c){var a=false;$.each($(c[0]).combobox("getData"),function(d,e){if(e.cityName==b){a=true}});return a},message:"地址无效"},address_t:{validator:function(b,c){var a=false;$.each($(c[0]).combobox("getData"),function(d,e){if(e.countyName==b){a=true}});return a},message:"地址无效"},address_a:{validator:function(b,c){var a=false;$.each($(c[0]).combobox("getData"),function(d,e){if(e.areaName==b){a=true}});return a},message:"地址无效"}});$.extend($.fn.validatebox.defaults.rules,{equals:{validator:function(a,b){return a==$(b[0]).val()},message:"两次密码输入不一致。"}});